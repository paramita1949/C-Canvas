<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éªŒè¯ç³»ç»Ÿ - åå°ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* ç™»å½•é¡µé¢ */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .links {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .links a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }
        
        .links a:hover {
            text-decoration: underline;
        }
        
        /* ç®¡ç†åå° */
        .admin-layout {
            display: none;
            min-height: 100vh;
        }
        
        .admin-layout.active {
            display: flex;
        }
        
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px 0;
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .sidebar-header h2 {
            color: #667eea;
            font-size: 24px;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }
        
        .sidebar-menu li {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
        }
        
        .sidebar-menu li:hover {
            background: #f5f5f5;
            color: #667eea;
        }
        
        .sidebar-menu li.active {
            background: #667eea;
            color: white;
            border-left: 4px solid #764ba2;
        }
        
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }
        
        .top-bar {
            background: white;
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .top-bar h1 {
            color: #333;
            font-size: 28px;
        }
        
        .content-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .content-section {
            display: none;
        }
        
        .content-section.active {
            display: block;
        }
        
        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* æŒ‰é’® */
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* è¡¨æ ¼ */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }
        
        table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        table tr:hover {
            background: #f8f9fa;
        }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        /* æ¶ˆæ¯æç¤º */
        .message {
            padding: 12px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-card .number {
            font-size: 36px;
            font-weight: bold;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .admin-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <h1>ğŸ” ç®¡ç†å‘˜ç™»å½•</h1>
            <div id="login-message" class="message"></div>
            <form id="login-form">
                <div class="form-group">
                    <label>ç®¡ç†å‘˜å¯†é’¥</label>
                    <input type="password" id="admin-key" required placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†é’¥">
                </div>
                <button type="submit" class="btn" style="width: 100%;">ç™»å½•</button>
            </form>
        </div>
    </div>

    <!-- ç®¡ç†åå° -->
    <div id="admin-page" class="admin-layout">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>éªŒè¯ç³»ç»Ÿ</h2>
                <p style="color: #999; font-size: 12px; margin-top: 5px;">åå°ç®¡ç†</p>
            </div>
            <ul class="sidebar-menu">
                <li class="active" onclick="switchSection('dashboard')">ğŸ“Š æ•°æ®æ¦‚è§ˆ</li>
                <li onclick="switchSection('users')">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</li>
                <li onclick="switchSection('add-user')">â• æ·»åŠ ç”¨æˆ·</li>
                <li onclick="switchSection('logs')">ğŸ“ ç™»å½•æ—¥å¿—</li>
                <li onclick="switchSection('api-doc')">ğŸ“¡ API æ–‡æ¡£</li>
                <li onclick="logout()" style="color: #dc3545;">ğŸšª é€€å‡ºç™»å½•</li>
            </ul>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <h1>åå°ç®¡ç†</h1>
                <button class="btn btn-small" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
            </div>

            <!-- æ•°æ®æ¦‚è§ˆ -->
            <div id="dashboard-section" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>æ€»ç”¨æˆ·æ•°</h3>
                        <div class="number" id="stat-total-users">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <h3>æ´»è·ƒç”¨æˆ·</h3>
                        <div class="number" id="stat-active-users">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);">
                        <h3>è¿‡æœŸç”¨æˆ·</h3>
                        <div class="number" id="stat-expired-users">0</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                        <h3>ä»Šæ—¥ç™»å½•</h3>
                        <div class="number" id="stat-today-logins">0</div>
                    </div>
                </div>

                <div class="content-card">
                    <h2 style="margin-bottom: 20px;">å³å°†åˆ°æœŸç”¨æˆ·</h2>
                    <div class="table-container">
                        <table id="expiring-users-table">
                            <thead>
                                <tr>
                                    <th>ç”¨æˆ·å</th>
                                    <th>é‚®ç®±</th>
                                    <th>åˆ°æœŸæ—¶é—´</th>
                                    <th>å‰©ä½™å¤©æ•°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ç”¨æˆ·ç®¡ç† -->
            <div id="users-section" class="content-section">
                <div class="content-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>ç”¨æˆ·åˆ—è¡¨</h2>
                        <div>
                            <input type="text" id="search-user" placeholder="æœç´¢ç”¨æˆ·..." style="padding: 8px 15px; border: 1px solid #e0e0e0; border-radius: 5px;">
                        </div>
                    </div>
                    <div id="users-message" class="message"></div>
                    <div class="table-container">
                        <table id="users-table">
                            <thead>
                                <tr>
                            <th>ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>é‚®ç®±</th>
                            <th>æ³¨å†ŒIP</th>
                            <th>åˆ›å»ºæ—¶é—´</th>
                            <th>åˆ°æœŸæ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                            <th>é‡ç½®æ¬¡æ•°</th>
                            <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- æ·»åŠ ç”¨æˆ· -->
            <div id="add-user-section" class="content-section">
                <div class="content-card">
                    <h2 style="margin-bottom: 20px;">æ·»åŠ æ–°ç”¨æˆ·</h2>
                    <div id="add-user-message" class="message"></div>
                    <form id="add-user-form">
                        <div class="form-group">
                            <label>ç”¨æˆ·å *</label>
                            <input type="text" name="username" required minlength="3" placeholder="3-20ä¸ªå­—ç¬¦">
                        </div>
                        <div class="form-group">
                            <label>å¯†ç  *</label>
                            <input type="password" name="password" required minlength="6" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦">
                        </div>
                        <div class="form-group">
                            <label>é‚®ç®±</label>
                            <input type="email" name="email" placeholder="å¯é€‰">
                        </div>
                        <div class="form-group">
                            <label>æœ‰æ•ˆæœŸ (å¤©æ•°) *</label>
                            <input type="number" name="days" value="30" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>æœ€å¤§è®¾å¤‡æ•°</label>
                            <input type="number" name="max_devices" value="1" min="1">
                        </div>
                        <button type="submit" class="btn">æ·»åŠ ç”¨æˆ·</button>
                    </form>
                </div>
            </div>

            <!-- ç™»å½•æ—¥å¿— -->
            <div id="logs-section" class="content-section">
                <div class="content-card">
                    <h2 style="margin-bottom: 20px;">ç™»å½•æ—¥å¿—</h2>
                    <div class="table-container">
                        <table id="logs-table">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>ç”¨æˆ·å</th>
                                    <th>IPåœ°å€</th>
                                    <th>çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- API æ–‡æ¡£ -->
            <div id="api-doc-section" class="content-section">
                <div class="content-card">
                    <h2 style="margin-bottom: 20px;">API æ¥å£æ–‡æ¡£ (ä¾›å¤–éƒ¨ç¨‹åºè°ƒç”¨)</h2>
                    
                    <h3 style="margin: 20px 0 10px; color: #667eea;">1. éªŒè¯ç”¨æˆ·</h3>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto;"><code>POST /api/auth/verify

è¯·æ±‚å‚æ•°:
{
  "username": "ç”¨æˆ·å",
  "password": "å¯†ç ",
  "hardware_id": "ç¡¬ä»¶ID (å¯é€‰)"
}

æˆåŠŸå“åº”:
{
  "success": true,
  "valid": true,
  "message": "éªŒè¯é€šè¿‡",
  "data": {
    "username": "testuser",
    "expires_at": "2024-12-31T23:59:59.000Z",
    "remaining_days": 30
  }
}</code></pre>

                    <h3 style="margin: 20px 0 10px; color: #667eea;">2. å¿ƒè·³éªŒè¯ (ä»…éœ€ token)</h3>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto;"><code>POST /api/auth/heartbeat

è¯·æ±‚å‚æ•°:
{
  "username": "ç”¨æˆ·å",
  "token": "ç™»å½•æ—¶è·å–çš„token"
}

æˆåŠŸå“åº”:
{
  "success": true,
  "valid": true,
  "remaining_days": 30
}</code></pre>

                    <h3 style="margin: 20px 0 10px; color: #28a745;">ä½¿ç”¨ç¤ºä¾‹ (Python)</h3>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto;"><code>import requests

# éªŒè¯ç”¨æˆ·
response = requests.post('https://ä½ çš„åŸŸå.pages.dev/api/auth/verify', json={
    'username': 'testuser',
    'password': 'password123'
})

result = response.json()
if result['valid']:
    print(f"éªŒè¯é€šè¿‡,å‰©ä½™{result['data']['remaining_days']}å¤©")
    token = result['data'].get('token')
else:
    print("éªŒè¯å¤±è´¥:", result['message'])</code></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let adminKey = '';
        let sessionToken = '';
        let sessionTimestamp = 0;
        let allUsers = [];

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ä¼šè¯
        window.addEventListener('DOMContentLoaded', () => {
            const savedSession = localStorage.getItem('admin_session');
            if (savedSession) {
                try {
                    const session = JSON.parse(savedSession);
                    const now = Date.now();
                    // æ£€æŸ¥ä¼šè¯æ˜¯å¦è¿‡æœŸï¼ˆ2å°æ—¶ï¼‰
                    if (now - session.timestamp < 7200000) {
                        adminKey = session.admin_key;
                        sessionToken = session.session_token;
                        sessionTimestamp = session.timestamp;
                        document.getElementById('login-page').classList.add('hidden');
                        document.getElementById('admin-page').classList.add('active');
                        loadDashboard();
                    } else {
                        // ä¼šè¯å·²è¿‡æœŸï¼Œæ¸…é™¤
                        localStorage.removeItem('admin_session');
                    }
                } catch (e) {
                    localStorage.removeItem('admin_session');
                }
            }
        });

        // ç®¡ç†å‘˜ç™»å½•
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const key = document.getElementById('admin-key').value;
            
            // éªŒè¯ç®¡ç†å‘˜å¯†é’¥
            const response = await fetch('/api/admin/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_key: key })
            });

            const result = await response.json();
            
            if (result.success) {
                adminKey = key;
                sessionToken = result.session_token;
                sessionTimestamp = result.timestamp;
                
                // ä¿å­˜ä¼šè¯åˆ°æœ¬åœ°ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
                const sessionData = {
                    admin_key: key,
                    session_token: sessionToken,
                    timestamp: sessionTimestamp
                };
                localStorage.setItem('admin_session', JSON.stringify(sessionData));
                
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('admin-page').classList.add('active');
                loadDashboard();
            } else {
                showMessage('login-message', result.message, 'error');
            }
        });

        // åˆ‡æ¢èœå•
        function switchSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-menu li').forEach(li => li.classList.remove('active'));
            
            document.getElementById(section + '-section').classList.add('active');
            event.target.classList.add('active');

            if (section === 'dashboard') loadDashboard();
            if (section === 'users') loadUsers();
            if (section === 'logs') loadLogs();
        }

        // åŠ è½½æ•°æ®æ¦‚è§ˆ
        async function loadDashboard() {
            const response = await fetch('/api/admin/stats', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_key: adminKey })
            });

            const data = await response.json();
            if (data.success) {
                document.getElementById('stat-total-users').textContent = data.stats.total_users;
                document.getElementById('stat-active-users').textContent = data.stats.active_users;
                document.getElementById('stat-expired-users').textContent = data.stats.expired_users;
                document.getElementById('stat-today-logins').textContent = data.stats.today_logins;

                // åŠ è½½å³å°†åˆ°æœŸç”¨æˆ·
                loadExpiringUsers();
            }
        }

        // åŠ è½½å³å°†åˆ°æœŸç”¨æˆ·
        async function loadExpiringUsers() {
            const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_key: adminKey })
            });

            const data = await response.json();
            if (data.success) {
                const tbody = document.querySelector('#expiring-users-table tbody');
                tbody.innerHTML = '';

                const expiringUsers = data.users.filter(u => {
                    const days = Math.ceil((new Date(u.expires_at) - new Date()) / (1000*60*60*24));
                    return days > 0 && days <= 7 && u.is_active;
                }).slice(0, 10);

                expiringUsers.forEach(user => {
                    const days = Math.ceil((new Date(user.expires_at) - new Date()) / (1000*60*60*24));
                    const row = `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.email || '-'}</td>
                            <td>${new Date(user.expires_at).toLocaleString('zh-CN')}</td>
                            <td><span class="badge badge-warning">${days} å¤©</span></td>
                            <td><button class="btn btn-small btn-success" onclick="extendUser('${user.username}', 30)">å»¶æœŸ30å¤©</button></td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_key: adminKey })
            });

            const data = await response.json();
            if (data.success) {
                allUsers = data.users;
                renderUsers(allUsers);
            }
        }

        // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
        function renderUsers(users) {
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const isExpired = new Date(user.expires_at) < new Date();
                const statusBadge = user.is_active ? 
                    (isExpired ? '<span class="badge badge-danger">å·²è¿‡æœŸ</span>' : '<span class="badge badge-success">æ­£å¸¸</span>') :
                    '<span class="badge badge-danger">å·²ç¦ç”¨</span>';

                const resetCount = user.reset_device_count ?? 3;
                const resetCountBadge = resetCount > 0 
                    ? `<span class="badge badge-success">${resetCount}æ¬¡</span>`
                    : `<span class="badge badge-danger">å·²ç”¨å®Œ</span>`;

                const row = `
                    <tr>
                        <td>${user.id}</td>
                        <td><strong>${user.username}</strong></td>
                        <td>${user.email || '-'}</td>
                        <td>${user.register_ip || '-'}</td>
                        <td>${new Date(user.created_at).toLocaleString('zh-CN')}</td>
                        <td>${new Date(user.expires_at).toLocaleString('zh-CN')}</td>
                        <td>${statusBadge}</td>
                        <td>${resetCountBadge}</td>
                        <td style="white-space: nowrap;">
                            <button class="btn btn-small btn-success" onclick="extendUser('${user.username}', 30)">å»¶æœŸ</button>
                            <button class="btn btn-small" style="background: #17a2b8;" onclick="setExpireDate('${user.username}', '${user.expires_at}')">è®¾ç½®åˆ°æœŸ</button>
                            <button class="btn btn-small" style="background: #6c757d;" onclick="setMaxDevices('${user.username}', ${user.max_devices || 1})">è®¾å¤‡æ•°(${user.max_devices || 1})</button>
                            <button class="btn btn-small" style="background: #ff6b6b;" onclick="resetDevices('${user.username}')">é‡ç½®è®¾å¤‡</button>
                            <button class="btn btn-small" style="background: #ffc107; color: #333;" onclick="resetPassword('${user.username}')">é‡ç½®å¯†ç </button>
                            <button class="btn btn-small ${user.is_active ? 'btn-danger' : 'btn-success'}" 
                                onclick="toggleUser('${user.username}', ${user.is_active})">
                                ${user.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteUser('${user.username}')">åˆ é™¤</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // æœç´¢ç”¨æˆ·
        document.getElementById('search-user').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            const filtered = allUsers.filter(u => 
                u.username.toLowerCase().includes(keyword) || 
                (u.email && u.email.toLowerCase().includes(keyword))
            );
            renderUsers(filtered);
        });

        // æ·»åŠ ç”¨æˆ·
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const response = await fetch('/api/admin/add-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_key: adminKey,
                    username: formData.get('username'),
                    password: formData.get('password'),
                    email: formData.get('email'),
                    days: parseInt(formData.get('days')),
                    max_devices: parseInt(formData.get('max_devices'))
                })
            });

            const result = await response.json();
            showMessage('add-user-message', result.message, result.success ? 'success' : 'error');
            
            if (result.success) {
                e.target.reset();
            }
        });

        // å»¶æœŸç”¨æˆ·
        async function extendUser(username, days) {
            const customDays = prompt(`ä¸ºç”¨æˆ· ${username} å»¶æœŸå¤šå°‘å¤©ï¼Ÿ`, days);
            if (!customDays) return;

            const response = await fetch('/api/admin/extend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_key: adminKey,
                    username: username,
                    days: parseInt(customDays)
                })
            });

            const result = await response.json();
            alert(result.message);
            
            if (result.success) {
                refreshData();
            }
        }

        // è®¾ç½®åˆ°æœŸæ—¶é—´
        async function setExpireDate(username, currentExpire) {
            const currentDate = new Date(currentExpire).toISOString().slice(0, 16);
            const newDate = prompt(`è®¾ç½®ç”¨æˆ· ${username} çš„åˆ°æœŸæ—¶é—´\næ ¼å¼: YYYY-MM-DD HH:MM\nä¾‹å¦‚: 2025-12-31 23:59`, currentDate.replace('T', ' ').slice(0, 16));
            
            if (!newDate) return;
            
            // éªŒè¯æ—¥æœŸæ ¼å¼
            const expireDate = new Date(newDate.replace(' ', 'T'));
            if (isNaN(expireDate.getTime())) {
                alert('æ—¥æœŸæ ¼å¼é”™è¯¯ï¼');
                return;
            }

            const response = await fetch('/api/admin/set-expire', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_key: adminKey,
                    username: username,
                    expire_date: expireDate.toISOString()
                })
            });

            const result = await response.json();
            alert(result.message);
            
            if (result.success) {
                refreshData();
            }
        }

        // å¯ç”¨/ç¦ç”¨ç”¨æˆ·
        async function toggleUser(username, isActive) {
            const action = isActive ? 'ç¦ç”¨' : 'å¯ç”¨';
            if (!confirm(`ç¡®å®šè¦${action}ç”¨æˆ· ${username} å—?`)) return;

            const response = await fetch('/api/admin/toggle-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_key: adminKey,
                    username: username,
                    active: !isActive
                })
            });

            const result = await response.json();
            showMessage('users-message', result.message, result.success ? 'success' : 'error');
            
            if (result.success) {
                loadUsers();
            }
        }

        // é‡ç½®ç”¨æˆ·å¯†ç 
        async function resetPassword(username) {
            const newPassword = prompt(`ä¸ºç”¨æˆ· ${username} è®¾ç½®æ–°å¯†ç ï¼š`, '');
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                alert('å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦ï¼');
                return;
            }

            const response = await fetch('/api/admin/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_key: adminKey,
                    username: username,
                    new_password: newPassword
                })
            });

            const result = await response.json();
            
            if (result.success) {
                // æ˜¾ç¤ºæ–°å¯†ç ä¾›å¤åˆ¶
                const message = `âœ… å¯†ç é‡ç½®æˆåŠŸï¼\n\nç”¨æˆ·å: ${username}\næ–°å¯†ç : ${newPassword}\n\nè¯·å°†æ–°å¯†ç å‘ŠçŸ¥ç”¨æˆ·`;
                alert(message);
                
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(`ç”¨æˆ·å: ${username}\nå¯†ç : ${newPassword}`).then(() => {
                    showMessage('users-message', 'å¯†ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                });
            } else {
                showMessage('users-message', result.message, 'error');
            }
        }

        // è®¾ç½®æœ€å¤§è®¾å¤‡æ•°
        async function setMaxDevices(username, currentDevices) {
            const newMaxDevices = prompt(`ä¸ºç”¨æˆ· ${username} è®¾ç½®æœ€å¤§è®¾å¤‡æ•°ï¼š\n(å½“å‰: ${currentDevices}å°)`, currentDevices);
            if (!newMaxDevices) return;
            
            const devices = parseInt(newMaxDevices);
            if (isNaN(devices) || devices < 1) {
                alert('è®¾å¤‡æ•°å¿…é¡»æ˜¯å¤§äº0çš„æ•´æ•°ï¼');
                return;
            }

            const response = await fetch('/api/admin/set-max-devices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_key: adminKey,
                    username: username,
                    max_devices: devices
                })
            });

            const result = await response.json();
            showMessage('users-message', result.message, result.success ? 'success' : 'error');
            
            if (result.success) {
                loadUsers();
            }
        }

        // é‡ç½®ç”¨æˆ·ç»‘å®šçš„è®¾å¤‡
        async function resetDevices(username) {
            // è·å–è¯¥ç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡ä¿¡æ¯
            const response = await fetch('/api/admin/devices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_key: adminKey })
            });
            const result = await response.json();
            
            if (!result.success) {
                alert('è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                return;
            }
            
            // æ‰¾åˆ°è¯¥ç”¨æˆ·çš„è®¾å¤‡åˆ—è¡¨
            const user = result.users.find(u => u.username === username);
            if (!user) {
                alert('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯');
                return;
            }
            
            // æ˜¾ç¤ºè®¾å¤‡ç®¡ç†æ¨¡æ€æ¡†
            showDeviceManagementModal(user);
        }
        
        // æ˜¾ç¤ºè®¾å¤‡ç®¡ç†æ¨¡æ€æ¡†
        function showDeviceManagementModal(user) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 800px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            let devicesHTML = '';
            if (user.devices && user.devices.length > 0) {
                devicesHTML = `
                    <table class="table" style="margin-top: 20px;">
                        <thead>
                            <tr>
                                <th>è®¾å¤‡ID</th>
                                <th>é¦–æ¬¡ç»‘å®š</th>
                                <th>æœ€åæ´»è·ƒ</th>
                                <th>IPåœ°å€</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${user.devices.map(device => `
                                <tr>
                                    <td style="font-family: monospace; font-size: 12px;">
                                        ${device.hardware_id.substring(0, 16)}...
                                        <button class="btn btn-small" style="margin-left: 5px; padding: 2px 8px;" onclick="copyToClipboard('${device.hardware_id}')">ğŸ“‹</button>
                                    </td>
                                    <td style="font-size: 12px;">${new Date(device.created_at).toLocaleString('zh-CN')}</td>
                                    <td style="font-size: 12px;">${new Date(device.last_seen).toLocaleString('zh-CN')}</td>
                                    <td>${device.last_ip || 'æœªçŸ¥'}</td>
                                    <td>
                                        <span style="display: inline-block; padding: 3px 8px; border-radius: 5px; font-size: 12px; ${device.is_online ? 'background: #28a745; color: white;' : 'background: #6c757d; color: white;'}">
                                            ${device.is_online ? 'ğŸŸ¢ åœ¨çº¿' : 'âš« ç¦»çº¿'}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-small btn-danger" onclick="deleteSingleDevice(${device.id}, '${user.username}', ${user.id})">åˆ é™¤</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                devicesHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¯¥ç”¨æˆ·æš‚æ— ç»‘å®šè®¾å¤‡</p>';
            }
            
            modalContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>è®¾å¤‡ç®¡ç† - ${user.username}</h2>
                    <button onclick="this.closest('[style*=\\'position: fixed\\']').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">Ã—</button>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p><strong>ç»‘å®šæƒ…å†µï¼š</strong> ${user.bound_devices} / ${user.max_devices} å°è®¾å¤‡</p>
                    <p><strong>å‰©ä½™æ§½ä½ï¼š</strong> ${user.remaining_slots} å°</p>
                    <p>
                        <strong>è§£ç»‘æ¬¡æ•°ï¼š</strong> 
                        <span id="reset-count-${user.id}" style="color: ${user.reset_device_count > 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">
                            ${user.reset_device_count} æ¬¡
                        </span>
                        <button class="btn btn-small" style="margin-left: 10px; padding: 4px 10px;" onclick="setResetCount('${user.username}', ${user.reset_device_count}, ${user.id})">âš™ï¸ è®¾ç½®</button>
                        <button class="btn btn-small btn-success" style="margin-left: 5px; padding: 4px 10px;" onclick="addResetCount('${user.username}', ${user.id}, 1)">+1</button>
                        <button class="btn btn-small btn-success" style="margin-left: 5px; padding: 4px 10px;" onclick="addResetCount('${user.username}', ${user.id}, 3)">+3</button>
                    </p>
                </div>
                ${devicesHTML}
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-danger" onclick="resetAllDevices('${user.username}', ${user.id})">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰è®¾å¤‡</button>
                    <button class="btn" style="background: #6c757d; margin-left: 10px;" onclick="this.closest('[style*=\\'position: fixed\\']').remove()">å…³é—­</button>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('âœ… å·²å¤åˆ¶å®Œæ•´ç¡¬ä»¶IDåˆ°å‰ªè´´æ¿');
            }).catch(() => {
                alert('âŒ å¤åˆ¶å¤±è´¥');
            });
        }
        
        // åˆ é™¤å•ä¸ªè®¾å¤‡
        async function deleteSingleDevice(deviceId, username, userId) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¾å¤‡å—ï¼Ÿ\n\nåˆ é™¤åè¯¥è®¾å¤‡å°†è¢«è§£ç»‘ï¼Œç”¨æˆ·å¯ä»¥é‡æ–°ç»‘å®šæ–°è®¾å¤‡ã€‚`)) return;
            
            const response = await fetch('/api/admin/device-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    device_id: deviceId,
                    user_id: userId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('âœ… ' + result.message);
                // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°
                document.querySelector('[style*="position: fixed"]').remove();
                loadUsers();
            } else {
                alert('âŒ ' + result.message);
            }
        }
        
        // é‡ç½®æ‰€æœ‰è®¾å¤‡
        async function resetAllDevices(username, userId) {
            if (!confirm(`âš ï¸ ç¡®å®šè¦é‡ç½®ç”¨æˆ· ${username} çš„æ‰€æœ‰ç»‘å®šè®¾å¤‡å—ï¼Ÿ\n\næ­¤æ“ä½œå°†æ¸…é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡ç»‘å®šä¿¡æ¯ï¼Œç”¨æˆ·ä¸‹æ¬¡ç™»å½•æ—¶å¯ä»¥é‡æ–°ç»‘å®šè®¾å¤‡ã€‚`)) return;

            const response = await fetch('/api/admin/reset-devices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_key: adminKey,
                    username: username
                })
            });

            const result = await response.json();
            
            if (result.success) {
                alert('âœ… ' + result.message);
                // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°
                document.querySelector('[style*="position: fixed"]').remove();
                loadUsers();
            } else {
                alert('âŒ ' + result.message);
            }
        }

        // è®¾ç½®é‡ç½®æ¬¡æ•°ï¼ˆç›´æ¥è®¾ç½®ä¸ºæŒ‡å®šå€¼ï¼‰
        async function setResetCount(username, currentCount, userId) {
            const newCount = prompt(`è®¾ç½®ç”¨æˆ· ${username} çš„é‡ç½®æ¬¡æ•°ï¼ˆ0-10ï¼‰ï¼š\nå½“å‰: ${currentCount}æ¬¡`, currentCount);
            if (newCount === null) return;
            
            const count = parseInt(newCount);
            if (isNaN(count) || count < 0 || count > 10) {
                alert('é‡ç½®æ¬¡æ•°å¿…é¡»æ˜¯ 0-10 ä¹‹é—´çš„æ•´æ•°ï¼');
                return;
            }
            
            const response = await fetch('/api/admin/set-reset-count', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_key: adminKey,
                    username: username,
                    reset_count: count
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`âœ… ${result.message}\n\nä¿®æ”¹å‰: ${result.reset_count_before}æ¬¡\nä¿®æ”¹å: ${result.reset_count_after}æ¬¡`);
                
                // æ›´æ–°æ˜¾ç¤º
                const span = document.getElementById(`reset-count-${userId}`);
                if (span) {
                    span.textContent = `${count} æ¬¡`;
                    span.style.color = count > 0 ? '#28a745' : '#dc3545';
                }
                
                loadUsers();
            } else {
                alert('âŒ ' + result.message);
            }
        }
        
        // å¢åŠ é‡ç½®æ¬¡æ•°ï¼ˆç›¸å¯¹å€¼ï¼‰
        async function addResetCount(username, userId, addValue) {
            const response = await fetch('/api/admin/add-reset-count', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_key: adminKey,
                    username: username,
                    add_count: addValue
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`âœ… ${result.message}\n\nä¿®æ”¹å‰: ${result.reset_count_before}æ¬¡\nä¿®æ”¹å: ${result.reset_count_after}æ¬¡\nå¢åŠ : ${result.added}æ¬¡`);
                
                // æ›´æ–°æ˜¾ç¤º
                const span = document.getElementById(`reset-count-${userId}`);
                if (span) {
                    span.textContent = `${result.reset_count_after} æ¬¡`;
                    span.style.color = result.reset_count_after > 0 ? '#28a745' : '#dc3545';
                }
                
                loadUsers();
            } else {
                alert('âŒ ' + result.message);
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(username) {
            if (!confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${username} å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ç™»å½•æ—¥å¿—å’Œè®¾å¤‡ä¿¡æ¯ï¼Œä¸”æ— æ³•æ¢å¤ï¼`)) return;
            
            // äºŒæ¬¡ç¡®è®¤
            const confirmText = prompt(`è¯·è¾“å…¥ç”¨æˆ·å "${username}" ç¡®è®¤åˆ é™¤ï¼š`);
            if (confirmText !== username) {
                alert('ç”¨æˆ·åä¸åŒ¹é…ï¼Œå–æ¶ˆåˆ é™¤');
                return;
            }

            const response = await fetch('/api/admin/delete-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    admin_key: adminKey,
                    username: username
                })
            });

            const result = await response.json();
            showMessage('users-message', result.message, result.success ? 'success' : 'error');
            
            if (result.success) {
                loadUsers();
                loadDashboard();
            }
        }

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            const response = await fetch('/api/admin/logs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_key: adminKey })
            });

            const data = await response.json();
            if (data.success) {
                const tbody = document.querySelector('#logs-table tbody');
                tbody.innerHTML = '';

                data.logs.forEach(log => {
                    const row = `
                        <tr>
                            <td>${new Date(log.login_time).toLocaleString('zh-CN')}</td>
                            <td>${log.username || 'æœªçŸ¥'}</td>
                            <td>${log.ip_address}</td>
                            <td>${log.success ? '<span class="badge badge-success">æˆåŠŸ</span>' : '<span class="badge badge-danger">å¤±è´¥</span>'}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadDashboard();
            loadUsers();
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—?')) {
                adminKey = '';
                sessionToken = '';
                sessionTimestamp = 0;
                
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ä¼šè¯
                localStorage.removeItem('admin_session');
                
                document.getElementById('admin-page').classList.remove('active');
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('admin-key').value = '';
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = `message ${type}`;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }
    </script>
</body>
</html>

