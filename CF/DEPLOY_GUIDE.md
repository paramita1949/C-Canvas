# æ³¨å†ŒåŠŸèƒ½ä¼˜åŒ–éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ä¼˜åŒ–å†…å®¹æ€»ç»“

### 1. å®‰å…¨å¢å¼º
- âœ… æ³¨å†Œå¿…é¡»æä¾›ç¡¬ä»¶IDï¼ˆhardware_idï¼‰
- âœ… IPé™åˆ¶ï¼š1å°æ—¶å†…åŒä¸€IPæœ€å¤š5ä¸ªæ³¨å†Œ
- âœ… ç¡¬ä»¶é™åˆ¶ï¼š24å°æ—¶å†…åŒä¸€è®¾å¤‡æœ€å¤š3ä¸ªæ³¨å†Œ
- âœ… è®¾å¤‡æ€»é‡é™åˆ¶ï¼šåŒä¸€è®¾å¤‡æœ€å¤š10ä¸ªè´¦å·
- âœ… åªå…è®¸å®¢æˆ·ç«¯æ³¨å†Œï¼Œé˜»æ­¢Webæ‰¹é‡æ³¨å†Œ

### 2. æ•°æ®åº“å˜æ›´
- æ·»åŠ å­—æ®µï¼š`hardware_id TEXT NOT NULL`ï¼ˆæ³¨å†Œç¡¬ä»¶IDï¼‰
- æ·»åŠ å­—æ®µï¼š`register_source TEXT DEFAULT 'desktop_client'`ï¼ˆæ³¨å†Œæ¥æºï¼‰
- æ·»åŠ ç´¢å¼•ï¼š`idx_hardware_id`ã€`idx_register_ip`

### 3. å®¢æˆ·ç«¯å˜æ›´
- æ³¨å†Œæ—¶è‡ªåŠ¨è·å–å¹¶å‘é€ç¡¬ä»¶ID
- å‘é€æ³¨å†Œæ¥æºæ ‡è¯†

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šå¤‡ä»½æ•°æ®åº“
```bash
# åœ¨Cloudflare Workersåå°å¤‡ä»½D1æ•°æ®åº“
# æˆ–å¯¼å‡ºç°æœ‰æ•°æ®
wrangler d1 execute YOUR_DATABASE_NAME --command "SELECT * FROM users" > backup.sql
```

### æ­¥éª¤2ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»
```bash
# è¿›å…¥CFç›®å½•
cd CF

# æ‰§è¡Œè¿ç§»è„šæœ¬ï¼ˆä¸ºæ—§ç”¨æˆ·æ·»åŠ ä¸´æ—¶hardware_idï¼‰
wrangler d1 execute YOUR_DATABASE_NAME --file=migrate.sql
```

### æ­¥éª¤3ï¼šéƒ¨ç½²APIæ›´æ–°
```bash
# éƒ¨ç½²æ›´æ–°åçš„API
wrangler deploy
```

### æ­¥éª¤4ï¼šæ›´æ–°å®¢æˆ·ç«¯
```bash
# ç¼–è¯‘C#å®¢æˆ·ç«¯ï¼ˆå·²è‡ªåŠ¨åŒ…å«ç¡¬ä»¶IDï¼‰
cd ..
dotnet build -c Release
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### Cloudflare Workers ç¯å¢ƒå˜é‡

éœ€è¦åœ¨ `wrangler.toml` ä¸­ç¡®ä¿ä»¥ä¸‹ç»‘å®šï¼š

```toml
[[d1_databases]]
binding = "DB"
database_name = "your_database_name"
database_id = "your_database_id"

[[kv_namespaces]]
binding = "KV"
id = "your_kv_namespace_id"
```

**æ³¨æ„**ï¼šKVå‘½åç©ºé—´ç”¨äºé¢‘ç‡é™åˆ¶ï¼Œå¿…é¡»åˆ›å»ºå¹¶ç»‘å®šï¼

### åˆ›å»ºKVå‘½åç©ºé—´ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
```bash
# åˆ›å»ºKVå‘½åç©ºé—´
wrangler kv:namespace create "RATE_LIMIT"

# å¤åˆ¶è¿”å›çš„IDï¼Œæ·»åŠ åˆ° wrangler.toml
```

---

## ğŸ” éªŒè¯éƒ¨ç½²

### 1. æµ‹è¯•æ³¨å†ŒAPI
```bash
curl -X POST https://your-api.workers.dev/api/user/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "password": "test123456",
    "hardware_id": "test_hardware_id_123456789"
  }'
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "success": true,
  "message": "æ³¨å†ŒæˆåŠŸï¼è¯·ç­‰å¾…ç®¡ç†å‘˜æ¿€æ´»æ‚¨çš„è´¦å·ã€‚",
  "data": {
    "username": "testuser",
    "expires_at": "2025-10-28T00:00:00.000Z",
    "trial_days": 0
  }
}
```

### 2. æµ‹è¯•é¢‘ç‡é™åˆ¶
è¿ç»­æ³¨å†Œ6æ¬¡ï¼Œç¬¬6æ¬¡åº”è¯¥å¤±è´¥ï¼š
```json
{
  "success": false,
  "message": "æ³¨å†Œè¿‡äºé¢‘ç¹ï¼Œè¯·1å°æ—¶åé‡è¯•"
}
```

### 3. æµ‹è¯•ç¼ºå°‘hardware_id
```bash
curl -X POST https://your-api.workers.dev/api/user/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser2",
    "password": "test123456"
  }'
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "success": false,
  "message": "è¯·ä»å®¢æˆ·ç«¯è½¯ä»¶å†…æ³¨å†Œï¼ˆç¼ºå°‘ç¡¬ä»¶æ ‡è¯†ï¼‰"
}
```

---

## ğŸ“Š é¢‘ç‡é™åˆ¶è¯¦æƒ…

| é™åˆ¶ç±»å‹ | æ—¶é—´çª—å£ | æœ€å¤§æ¬¡æ•° | å­˜å‚¨ä½ç½® |
|---------|---------|---------|---------|
| IPé™åˆ¶ | 1å°æ—¶ | 5æ¬¡ | KV (3600ç§’) |
| ç¡¬ä»¶IDé™åˆ¶ | 24å°æ—¶ | 3æ¬¡ | KV (86400ç§’) |
| è®¾å¤‡æ€»é‡ | æ°¸ä¹… | 10ä¸ª | D1æ•°æ®åº“ |

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæ³¨å†Œå¤±è´¥"ç³»ç»Ÿé”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"
**åŸå› **ï¼šKVå‘½åç©ºé—´æœªç»‘å®š

**è§£å†³**ï¼š
```bash
# æ£€æŸ¥wrangler.tomlä¸­æ˜¯å¦æœ‰KVç»‘å®š
# åˆ›å»ºå¹¶ç»‘å®šKVå‘½åç©ºé—´
wrangler kv:namespace create "RATE_LIMIT"
```

### é—®é¢˜2ï¼šæ—§ç”¨æˆ·æ— æ³•ç™»å½•
**åŸå› **ï¼šhardware_idå­—æ®µä¸ºç©º

**è§£å†³**ï¼šæ‰§è¡Œè¿ç§»è„šæœ¬ï¼ˆmigrate.sqlï¼‰ï¼Œä¼šè‡ªåŠ¨ä¸ºæ—§ç”¨æˆ·ç”Ÿæˆä¸´æ—¶ID

### é—®é¢˜3ï¼šå®¢æˆ·ç«¯æ³¨å†Œå¤±è´¥
**æ£€æŸ¥è°ƒè¯•è¾“å‡º**ï¼š
```
ğŸ“ [AuthService] å¼€å§‹æ³¨å†Œ: testuser
ğŸ“ [AuthService] ç¡¬ä»¶ID: abc123...
ğŸ“ [AuthService] æœåŠ¡å™¨å“åº”: {...}
```

---

## ğŸ“ å›æ»šæ–¹æ¡ˆ

å¦‚æœéœ€è¦å›æ»šåˆ°æ—§ç‰ˆæœ¬ï¼š

### 1. å›æ»šAPI
```bash
# éƒ¨ç½²æ—§ç‰ˆæœ¬
git checkout previous_commit
wrangler deploy
```

### 2. æ•°æ®åº“ä¸éœ€è¦å›æ»š
- æ–°æ·»åŠ çš„å­—æ®µæœ‰é»˜è®¤å€¼
- æ—§ç‰ˆæœ¬ä»å¯æ­£å¸¸å·¥ä½œ
- hardware_idå¯ä»¥ä¸ºç©ºï¼ˆæ—§ç”¨æˆ·ï¼‰

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] å¤‡ä»½æ•°æ®åº“
- [ ] åˆ›å»ºKVå‘½åç©ºé—´
- [ ] æ›´æ–°wrangler.tomlé…ç½®
- [ ] æ‰§è¡Œæ•°æ®åº“è¿ç§»
- [ ] éƒ¨ç½²APIæ›´æ–°
- [ ] æµ‹è¯•æ³¨å†ŒåŠŸèƒ½
- [ ] æµ‹è¯•é¢‘ç‡é™åˆ¶
- [ ] æµ‹è¯•æ—§ç”¨æˆ·ç™»å½•
- [ ] æ›´æ–°å®¢æˆ·ç«¯ç¨‹åº

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. Cloudflare Workersæ—¥å¿—
2. å®¢æˆ·ç«¯è°ƒè¯•è¾“å‡º
3. æ•°æ®åº“æŸ¥è¯¢ç»“æœ

```bash
# æŸ¥çœ‹Workersæ—¥å¿—
wrangler tail

# æŸ¥è¯¢æ•°æ®åº“
wrangler d1 execute YOUR_DATABASE_NAME --command "SELECT * FROM users LIMIT 10"
```

