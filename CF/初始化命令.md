# Cloudflare Workers 初始化命令

## 📋 前置条件
- 已安装 Node.js
- 已安装 Wrangler CLI: `npm install -g wrangler`
- 已登录 Cloudflare: `wrangler login`

---

## 🚀 完整初始化流程

### 步骤1：创建D1数据库（如果还没有）

```bash
cd CF

# 创建D1数据库
wrangler d1 create canvas-db
```

**输出示例**：
```
✅ Successfully created DB 'canvas-db'

[[d1_databases]]
binding = "DB"
database_name = "canvas-db"
database_id = "726cb4e5-1cf0-4348-9189-be72924ffcfd"
```

> ⚠️ 如果已有数据库，跳过此步骤，使用现有的ID

---

### 步骤2：执行数据库Schema

```bash
# 初始化表结构
wrangler d1 execute canvas-db --file=schema.sql
```

**会创建的表**：
- ✅ `users` - 用户表
- ✅ `login_logs` - 登录日志表
- ✅ `devices` - 设备表
- ✅ 相关索引

**验证表是否创建成功**：
```bash
# 查看所有表
wrangler d1 execute canvas-db --command "SELECT name FROM sqlite_master WHERE type='table'"
```

**预期输出**：
```
┌──────────────┐
│ name         │
├──────────────┤
│ users        │
│ login_logs   │
│ devices      │
└──────────────┘
```

---

### 步骤3：执行数据库迁移（如果有旧数据）

```bash
# 为旧用户添加新字段
wrangler d1 execute canvas-db --file=migrate.sql
```

**作用**：
- 添加 `register_source` 字段
- 添加 `reset_device_count` 字段
- 为旧用户设置临时 `hardware_id`
- 创建索引

---

### 步骤4：创建KV命名空间

```bash
# 创建生产环境KV
wrangler kv:namespace create "RATE_LIMIT"
```

**输出示例**：
```
🌀 Creating namespace with title "cloudflare-auth-system-RATE_LIMIT"
✨ Success!
Add the following to your wrangler.toml:
{ binding = "KV", id = "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6" }
```

**（可选）创建预览环境KV**：
```bash
wrangler kv:namespace create "RATE_LIMIT" --preview
```

---

### 步骤5：更新wrangler.toml

打开 `wrangler.toml`，填入实际的KV ID：

```toml
# KV 命名空间配置（用于频率限制）
[[kv_namespaces]]
binding = "KV"
id = "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6"  # 替换为步骤4的实际ID
preview_id = "x1y2z3..."  # 可选：本地测试用
```

---

### 步骤6：部署

```bash
# 部署到Cloudflare
wrangler deploy
```

**输出示例**：
```
⛅️ wrangler 3.x.x
------------------
Total Upload: xxx KiB / gzip: xxx KiB
Uploaded cloudflare-auth-system (x.xx sec)
Published cloudflare-auth-system (x.xx sec)
  https://cloudflare-auth-system.xxx.workers.dev
Current Deployment ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

---

## 🔍 验证部署

### 1. 测试数据库连接

```bash
# 查询用户数量
wrangler d1 execute canvas-db --command "SELECT COUNT(*) as count FROM users"
```

### 2. 测试KV存储

```bash
# 写入测试数据
wrangler kv:key put --namespace-id=YOUR_KV_ID "test" "hello"

# 读取测试数据
wrangler kv:key get --namespace-id=YOUR_KV_ID "test"
```

### 3. 测试API

```bash
# 测试注册API（应该失败，因为缺少hardware_id）
curl -X POST https://cloudflare-auth-system.xxx.workers.dev/api/user/register \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"123456"}'
```

**预期响应**：
```json
{
  "success": false,
  "message": "请从客户端软件内注册（缺少硬件标识）"
}
```

---

## 📊 为什么需要D1和KV两者？

### 使用场景对比

| 数据类型 | 存储位置 | 原因 |
|---------|---------|------|
| 用户账号 | D1数据库 | 永久存储，需要复杂查询 |
| 设备绑定 | D1数据库 | 永久存储，关联查询 |
| 登录日志 | D1数据库 | 永久存储，统计分析 |
| IP注册次数 | KV | 1小时自动过期，快速读写 |
| 硬件注册次数 | KV | 24小时自动过期，快速读写 |

### 性能对比

**D1数据库查询（复杂查询）**：
```sql
-- 查询某硬件ID注册的所有账号（需要全表扫描）
SELECT * FROM users WHERE hardware_id = 'abc123';
-- 耗时：10-50ms
```

**KV查询（简单计数）**：
```javascript
// 查询IP注册次数
const count = await env.KV.get('register:ip:1.2.3.4');
// 耗时：1-5ms（快10倍）
```

### 成本对比

| 操作 | D1数据库 | KV存储 |
|-----|---------|--------|
| 读取 | 5美元/百万次 | 0.5美元/千万次 |
| 写入 | 1美元/百万次 | 5美元/百万次 |
| 存储 | 5美元/GB/月 | 0.5美元/GB/月 |

**频率限制场景**：
- 每次注册需要查询2次（IP + 硬件ID）
- 使用KV：成本降低90%
- 使用KV：速度提升10倍

---

## 💡 简化方案（如果不想用KV）

如果真的不想用KV，可以只用D1，但会有以下问题：

### 方案：创建rate_limit表

```sql
CREATE TABLE rate_limit (
    key TEXT PRIMARY KEY,
    count INTEGER,
    expires_at TIMESTAMP
);
```

### 缺点：

1. **性能差**：每次注册需要查询+更新数据库
2. **无自动清理**：需要定时任务清理过期数据
3. **成本高**：每次写入都要更新数据库
4. **复杂度高**：需要自己实现TTL逻辑

---

## ✅ 推荐配置

**D1数据库**：用于所有永久数据  
**KV存储**：用于频率限制（临时计数）

**原因**：
- ✅ 性能最优（KV快10倍）
- ✅ 成本最低（KV便宜90%）
- ✅ 自动过期（无需手动清理）
- ✅ 代码简单（无需写TTL逻辑）

---

## 🆘 常见问题

### Q1: 必须用KV吗？
**A**: 不是必须，但强烈推荐。不用KV的话：
- 性能下降10倍
- 需要自己实现过期清理
- 成本增加

### Q2: KV会增加多少成本？
**A**: 几乎可以忽略
- 免费额度：10万次读取/天
- 注册场景：每天即使1000次注册，只用2000次读取
- **完全在免费额度内**

### Q3: 如何本地测试？
**A**: 使用本地开发模式
```bash
# 本地开发（使用本地KV和D1）
wrangler dev --local
```

---

## 📝 初始化检查清单

- [ ] 安装wrangler CLI
- [ ] 登录Cloudflare账号
- [ ] 创建/确认D1数据库
- [ ] 执行schema.sql初始化表
- [ ] 执行migrate.sql迁移数据
- [ ] 创建KV命名空间
- [ ] 更新wrangler.toml配置
- [ ] 部署到Cloudflare
- [ ] 测试API功能
- [ ] 验证频率限制

完成后，你的系统就初始化好了！🎉

