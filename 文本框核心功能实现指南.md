# æ–‡æœ¬æ¡†æ ¸å¿ƒåŠŸèƒ½å®ç°æŒ‡å—

> **åŠŸèƒ½åˆ—è¡¨**: è¾¹æ¡†ã€æ–‡å­—èƒŒæ™¯ã€æ–œä½“ã€å­—é—´è·ã€è¡Œé—´è·ã€æ–‡æœ¬å¯¹é½ï¼ˆå·¦/ä¸­/å³ï¼‰  
> **æŠ€æœ¯æ ˆ**: WPF + SkiaSharp  
> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-02

---

## ğŸ“‹ ç›®å½•

1. [æ•°æ®æ¨¡å‹å®šä¹‰](#æ•°æ®æ¨¡å‹å®šä¹‰)
2. [SkiaSharp æ¸²æŸ“å®ç°](#skiasharp-æ¸²æŸ“å®ç°)
3. [UI å±æ€§é¢æ¿](#ui-å±æ€§é¢æ¿)
4. [å®Œæ•´ä»£ç ç¤ºä¾‹](#å®Œæ•´ä»£ç ç¤ºä¾‹)
5. [æ•°æ®åº“æ‰©å±•](#æ•°æ®åº“æ‰©å±•)

---

## ğŸ“¦ æ•°æ®æ¨¡å‹å®šä¹‰

### 1. TextPropertiesï¼ˆæ–‡æœ¬å±æ€§ç±»ï¼‰

```csharp
using SkiaSharp;
using System.ComponentModel;
using System.Runtime.CompilerServices;

namespace ImageColorChanger.Models
{
    /// <summary>
    /// æ–‡æœ¬å±æ€§æ¨¡å‹
    /// åŒ…å«æ‰€æœ‰æ–‡æœ¬æ ·å¼å’Œæ’ç‰ˆå±æ€§
    /// </summary>
    public class TextProperties : INotifyPropertyChanged
    {
        // ========== åŸºç¡€æ–‡æœ¬å±æ€§ ==========
        private string _fontFamily = "Microsoft YaHei UI";
        private float _fontSize = 20;
        private SKColor _textColor = SKColors.White;
        private bool _isBold = false;
        private bool _isItalic = false;  // ğŸ¯ æ–œä½“
        private bool _isUnderline = false;
        private bool _isStrikethrough = false;
        
        // ========== é«˜çº§æ’ç‰ˆå±æ€§ ==========
        private float _letterSpacing = 0;     // ğŸ¯ å­—é—´è·ï¼ˆåƒç´ ï¼‰
        private float _lineSpacing = 1.2f;    // ğŸ¯ è¡Œé—´è·ï¼ˆå€æ•°ï¼‰
        private TextAlignment _alignment = TextAlignment.Left;  // ğŸ¯ å¯¹é½æ–¹å¼
        
        // ========== æ–‡å­—èƒŒæ™¯å±æ€§ ==========
        private bool _hasBackground = false;           // ğŸ¯ æ˜¯å¦æ˜¾ç¤ºèƒŒæ™¯
        private SKColor _backgroundColor = new SKColor(52, 152, 219, 200);  // é»˜è®¤åŠé€æ˜è“è‰²
        private float _backgroundOpacity = 0.8f;       // èƒŒæ™¯é€æ˜åº¦
        private float _backgroundPadding = 10;         // èƒŒæ™¯å†…è¾¹è·
        private float _backgroundCornerRadius = 10;    // èƒŒæ™¯åœ†è§’
        
        // ========== è¾¹æ¡†å±æ€§ ==========
        private bool _hasBorder = false;               // ğŸ¯ æ˜¯å¦æ˜¾ç¤ºè¾¹æ¡†
        private SKColor _borderColor = SKColors.Black;
        private float _borderWidth = 2;
        private float _borderCornerRadius = 10;        // è¾¹æ¡†åœ†è§’
        private float _borderOpacity = 1.0f;
        
        // ========== å±æ€§å®ç° ==========
        
        public string FontFamily
        {
            get => _fontFamily;
            set { _fontFamily = value; OnPropertyChanged(); }
        }
        
        public float FontSize
        {
            get => _fontSize;
            set { _fontSize = Math.Max(1, value); OnPropertyChanged(); }
        }
        
        public SKColor TextColor
        {
            get => _textColor;
            set { _textColor = value; OnPropertyChanged(); }
        }
        
        public bool IsBold
        {
            get => _isBold;
            set { _isBold = value; OnPropertyChanged(); }
        }
        
        public bool IsItalic  // ğŸ¯ æ–œä½“
        {
            get => _isItalic;
            set { _isItalic = value; OnPropertyChanged(); }
        }
        
        public bool IsUnderline
        {
            get => _isUnderline;
            set { _isUnderline = value; OnPropertyChanged(); }
        }
        
        public bool IsStrikethrough
        {
            get => _isStrikethrough;
            set { _isStrikethrough = value; OnPropertyChanged(); }
        }
        
        public float LetterSpacing  // ğŸ¯ å­—é—´è·
        {
            get => _letterSpacing;
            set { _letterSpacing = value; OnPropertyChanged(); }
        }
        
        public float LineSpacing  // ğŸ¯ è¡Œé—´è·
        {
            get => _lineSpacing;
            set { _lineSpacing = Math.Max(0.5f, value); OnPropertyChanged(); }
        }
        
        public TextAlignment Alignment  // ğŸ¯ å¯¹é½æ–¹å¼
        {
            get => _alignment;
            set { _alignment = value; OnPropertyChanged(); }
        }
        
        // æ–‡å­—èƒŒæ™¯
        public bool HasBackground
        {
            get => _hasBackground;
            set { _hasBackground = value; OnPropertyChanged(); }
        }
        
        public SKColor BackgroundColor
        {
            get => _backgroundColor;
            set { _backgroundColor = value; OnPropertyChanged(); }
        }
        
        public float BackgroundOpacity
        {
            get => _backgroundOpacity;
            set { _backgroundOpacity = Math.Clamp(value, 0f, 1f); OnPropertyChanged(); }
        }
        
        public float BackgroundPadding
        {
            get => _backgroundPadding;
            set { _backgroundPadding = Math.Max(0, value); OnPropertyChanged(); }
        }
        
        public float BackgroundCornerRadius
        {
            get => _backgroundCornerRadius;
            set { _backgroundCornerRadius = Math.Max(0, value); OnPropertyChanged(); }
        }
        
        // è¾¹æ¡†
        public bool HasBorder
        {
            get => _hasBorder;
            set { _hasBorder = value; OnPropertyChanged(); }
        }
        
        public SKColor BorderColor
        {
            get => _borderColor;
            set { _borderColor = value; OnPropertyChanged(); }
        }
        
        public float BorderWidth
        {
            get => _borderWidth;
            set { _borderWidth = Math.Max(0, value); OnPropertyChanged(); }
        }
        
        public float BorderCornerRadius
        {
            get => _borderCornerRadius;
            set { _borderCornerRadius = Math.Max(0, value); OnPropertyChanged(); }
        }
        
        public float BorderOpacity
        {
            get => _borderOpacity;
            set { _borderOpacity = Math.Clamp(value, 0f, 1f); OnPropertyChanged(); }
        }
        
        // INotifyPropertyChanged å®ç°
        public event PropertyChangedEventHandler PropertyChanged;
        protected void OnPropertyChanged([CallerMemberName] string name = null)
        {
            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(name));
        }
    }
    
    /// <summary>
    /// æ–‡æœ¬å¯¹é½æ–¹å¼æšä¸¾
    /// </summary>
    public enum TextAlignment
    {
        Left,    // å·¦å¯¹é½
        Center,  // å±…ä¸­å¯¹é½
        Right    // å³å¯¹é½
    }
}
```

---

## ğŸ¨ SkiaSharp æ¸²æŸ“å®ç°

### 2. SkiaTextRendererï¼ˆæ–‡æœ¬æ¸²æŸ“å™¨ï¼‰

```csharp
using SkiaSharp;
using System;
using System.Collections.Generic;
using System.Linq;

namespace ImageColorChanger.Core
{
    /// <summary>
    /// SkiaSharp æ–‡æœ¬æ¸²æŸ“å™¨
    /// è´Ÿè´£æ¸²æŸ“æ‰€æœ‰æ–‡æœ¬æ ·å¼å’Œæ•ˆæœ
    /// </summary>
    public class SkiaTextRenderer
    {
        /// <summary>
        /// æ¸²æŸ“å®Œæ•´çš„æ–‡æœ¬æ¡†
        /// </summary>
        public void Render(SKCanvas canvas, string text, TextProperties props, SKRect bounds)
        {
            if (string.IsNullOrEmpty(text))
                return;
            
            // 1. æ¸²æŸ“æ–‡å­—èƒŒæ™¯
            if (props.HasBackground)
            {
                RenderTextBackground(canvas, text, props, bounds);
            }
            
            // 2. æ¸²æŸ“è¾¹æ¡†
            if (props.HasBorder)
            {
                RenderBorder(canvas, props, bounds);
            }
            
            // 3. æ¸²æŸ“æ–‡æœ¬
            RenderText(canvas, text, props, bounds);
        }
        
        /// <summary>
        /// ğŸ¯ æ¸²æŸ“æ–‡å­—èƒŒæ™¯
        /// </summary>
        private void RenderTextBackground(SKCanvas canvas, string text, TextProperties props, SKRect bounds)
        {
            using var paint = new SKPaint
            {
                Color = props.BackgroundColor.WithAlpha((byte)(props.BackgroundOpacity * 255)),
                Style = SKPaintStyle.Fill,
                IsAntialias = true
            };
            
            // è®¡ç®—èƒŒæ™¯åŒºåŸŸï¼ˆæ–‡æœ¬åŒºåŸŸ + å†…è¾¹è·ï¼‰
            var bgRect = new SKRect(
                bounds.Left + props.BackgroundPadding,
                bounds.Top + props.BackgroundPadding,
                bounds.Right - props.BackgroundPadding,
                bounds.Bottom - props.BackgroundPadding
            );
            
            // ç»˜åˆ¶åœ†è§’çŸ©å½¢èƒŒæ™¯
            canvas.DrawRoundRect(bgRect, props.BackgroundCornerRadius, props.BackgroundCornerRadius, paint);
        }
        
        /// <summary>
        /// ğŸ¯ æ¸²æŸ“è¾¹æ¡†
        /// </summary>
        private void RenderBorder(SKCanvas canvas, TextProperties props, SKRect bounds)
        {
            using var paint = new SKPaint
            {
                Color = props.BorderColor.WithAlpha((byte)(props.BorderOpacity * 255)),
                Style = SKPaintStyle.Stroke,
                StrokeWidth = props.BorderWidth,
                IsAntialias = true
            };
            
            // ç»˜åˆ¶åœ†è§’çŸ©å½¢è¾¹æ¡†
            var borderRect = bounds;
            borderRect.Inflate(-props.BorderWidth / 2, -props.BorderWidth / 2);
            canvas.DrawRoundRect(borderRect, props.BorderCornerRadius, props.BorderCornerRadius, paint);
        }
        
        /// <summary>
        /// ğŸ¯ æ¸²æŸ“æ–‡æœ¬ï¼ˆæ”¯æŒå­—é—´è·ã€è¡Œé—´è·ã€å¯¹é½æ–¹å¼ã€æ–œä½“ï¼‰
        /// </summary>
        private void RenderText(SKCanvas canvas, string text, TextProperties props, SKRect bounds)
        {
            // åˆ›å»ºå­—ä½“
            var fontStyle = GetFontStyle(props.IsBold, props.IsItalic);
            using var typeface = SKTypeface.FromFamilyName(props.FontFamily, fontStyle);
            
            using var paint = new SKPaint
            {
                Typeface = typeface,
                TextSize = props.FontSize,
                Color = props.TextColor,
                IsAntialias = true,
                SubpixelText = true
            };
            
            // åˆ†å‰²æ–‡æœ¬ä¸ºå¤šè¡Œ
            var lines = text.Split(new[] { '\n', '\r' }, StringSplitOptions.None);
            
            // è®¡ç®—èµ·å§‹ Y åæ ‡
            float currentY = bounds.Top + props.FontSize;
            float lineHeight = props.FontSize * props.LineSpacing;  // ğŸ¯ è¡Œé—´è·
            
            foreach (var line in lines)
            {
                if (string.IsNullOrEmpty(line))
                {
                    currentY += lineHeight;
                    continue;
                }
                
                // ğŸ¯ æ ¹æ®å¯¹é½æ–¹å¼è®¡ç®— X åæ ‡
                float startX = CalculateAlignmentX(line, paint, props, bounds);
                
                // ğŸ¯ æ¸²æŸ“å•è¡Œæ–‡æœ¬ï¼ˆæ”¯æŒå­—é—´è·ï¼‰
                if (props.LetterSpacing == 0)
                {
                    // æ— å­—é—´è·ï¼Œç›´æ¥ç»˜åˆ¶
                    canvas.DrawText(line, startX, currentY, paint);
                }
                else
                {
                    // æœ‰å­—é—´è·ï¼Œé€å­—ç¬¦ç»˜åˆ¶
                    RenderLineWithSpacing(canvas, line, startX, currentY, props.LetterSpacing, paint);
                }
                
                // ğŸ¯ æ¸²æŸ“ä¸‹åˆ’çº¿
                if (props.IsUnderline)
                {
                    RenderUnderline(canvas, line, startX, currentY, props, paint);
                }
                
                // ğŸ¯ æ¸²æŸ“åˆ é™¤çº¿
                if (props.IsStrikethrough)
                {
                    RenderStrikethrough(canvas, line, startX, currentY, props, paint);
                }
                
                currentY += lineHeight;  // ğŸ¯ è¡Œé—´è·
            }
        }
        
        /// <summary>
        /// ğŸ¯ è®¡ç®—å¯¹é½æ–¹å¼çš„ X åæ ‡
        /// </summary>
        private float CalculateAlignmentX(string line, SKPaint paint, TextProperties props, SKRect bounds)
        {
            float lineWidth = MeasureLineWidth(line, paint, props.LetterSpacing);
            
            switch (props.Alignment)
            {
                case TextAlignment.Left:
                    return bounds.Left + props.BackgroundPadding;
                
                case TextAlignment.Center:
                    return bounds.Left + (bounds.Width - lineWidth) / 2;
                
                case TextAlignment.Right:
                    return bounds.Right - lineWidth - props.BackgroundPadding;
                
                default:
                    return bounds.Left;
            }
        }
        
        /// <summary>
        /// ğŸ¯ æ¸²æŸ“å¸¦å­—é—´è·çš„å•è¡Œæ–‡æœ¬
        /// </summary>
        private void RenderLineWithSpacing(SKCanvas canvas, string line, float x, float y, float spacing, SKPaint paint)
        {
            float currentX = x;
            
            foreach (char c in line)
            {
                string charStr = c.ToString();
                canvas.DrawText(charStr, currentX, y, paint);
                
                float charWidth = paint.MeasureText(charStr);
                currentX += charWidth + spacing;  // ğŸ¯ å­—é—´è·
            }
        }
        
        /// <summary>
        /// æµ‹é‡æ–‡æœ¬è¡Œå®½åº¦ï¼ˆè€ƒè™‘å­—é—´è·ï¼‰
        /// </summary>
        private float MeasureLineWidth(string line, SKPaint paint, float spacing)
        {
            if (spacing == 0)
            {
                return paint.MeasureText(line);
            }
            
            float width = 0;
            foreach (char c in line)
            {
                width += paint.MeasureText(c.ToString()) + spacing;
            }
            return width - spacing;  // æœ€åä¸€ä¸ªå­—ç¬¦ä¸åŠ é—´è·
        }
        
        /// <summary>
        /// ğŸ¯ è·å–å­—ä½“æ ·å¼ï¼ˆç²—ä½“ + æ–œä½“ï¼‰
        /// </summary>
        private SKFontStyle GetFontStyle(bool isBold, bool isItalic)
        {
            var weight = isBold ? SKFontStyleWeight.Bold : SKFontStyleWeight.Normal;
            var slant = isItalic ? SKFontStyleSlant.Italic : SKFontStyleSlant.Upright;
            
            return new SKFontStyle(weight, SKFontStyleWidth.Normal, slant);
        }
        
        /// <summary>
        /// æ¸²æŸ“ä¸‹åˆ’çº¿
        /// </summary>
        private void RenderUnderline(SKCanvas canvas, string line, float x, float y, TextProperties props, SKPaint paint)
        {
            float lineWidth = MeasureLineWidth(line, paint, props.LetterSpacing);
            float underlineY = y + props.FontSize * 0.1f;
            
            using var underlinePaint = new SKPaint
            {
                Color = props.TextColor,
                StrokeWidth = Math.Max(1, props.FontSize * 0.05f),
                IsAntialias = true
            };
            
            canvas.DrawLine(x, underlineY, x + lineWidth, underlineY, underlinePaint);
        }
        
        /// <summary>
        /// æ¸²æŸ“åˆ é™¤çº¿
        /// </summary>
        private void RenderStrikethrough(SKCanvas canvas, string line, float x, float y, TextProperties props, SKPaint paint)
        {
            float lineWidth = MeasureLineWidth(line, paint, props.LetterSpacing);
            float strikeY = y - props.FontSize * 0.3f;
            
            using var strikePaint = new SKPaint
            {
                Color = props.TextColor,
                StrokeWidth = Math.Max(1, props.FontSize * 0.05f),
                IsAntialias = true
            };
            
            canvas.DrawLine(x, strikeY, x + lineWidth, strikeY, strikePaint);
        }
    }
}
```

---

## ğŸ›ï¸ UI å±æ€§é¢æ¿

### 3. TextPropertyPanel.xamlï¼ˆæ–‡æœ¬å±æ€§é¢æ¿ï¼‰

```xml
<UserControl x:Class="ImageColorChanger.UI.Controls.TextPropertyPanel"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             Width="300" Background="#2C3E50">
    
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="15">
            
            <!-- æ ‡é¢˜ -->
            <TextBlock Text="æ–‡æœ¬å±æ€§" FontSize="18" FontWeight="Bold" 
                       Foreground="White" Margin="0,0,0,15"/>
            
            <!-- ========== åŸºç¡€æ ·å¼ ========== -->
            <TextBlock Text="åŸºç¡€æ ·å¼" FontSize="14" Foreground="#ECF0F1" Margin="0,0,0,10"/>
            
            <!-- å­—ä½“ -->
            <StackPanel Margin="0,0,0,10">
                <TextBlock Text="å­—ä½“" Foreground="#BDC3C7" FontSize="12"/>
                <ComboBox x:Name="FontFamilyComboBox" Height="30" Margin="0,5,0,0"
                          SelectedItem="{Binding FontFamily, Mode=TwoWay}">
                    <ComboBoxItem Content="Microsoft YaHei UI"/>
                    <ComboBoxItem Content="SimSun"/>
                    <ComboBoxItem Content="SimHei"/>
                    <ComboBoxItem Content="Arial"/>
                    <ComboBoxItem Content="Times New Roman"/>
                </ComboBox>
            </StackPanel>
            
            <!-- å­—å· -->
            <StackPanel Margin="0,0,0,10">
                <TextBlock Text="å­—å·" Foreground="#BDC3C7" FontSize="12"/>
                <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                    <Slider x:Name="FontSizeSlider" Width="220" Minimum="10" Maximum="100"
                            Value="{Binding FontSize, Mode=TwoWay}" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding FontSize, StringFormat={}{0:F0}px}" 
                               Foreground="White" Margin="10,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>
            </StackPanel>
            
            <!-- æ–‡å­—é¢œè‰² -->
            <StackPanel Margin="0,0,0,10">
                <TextBlock Text="æ–‡å­—é¢œè‰²" Foreground="#BDC3C7" FontSize="12"/>
                <!-- è¿™é‡Œéœ€è¦è‡ªå®šä¹‰é¢œè‰²é€‰æ‹©å™¨æ§ä»¶ -->
                <Button x:Name="TextColorButton" Height="30" Margin="0,5,0,0"
                        Content="é€‰æ‹©é¢œè‰²" Click="OnTextColorClicked"/>
            </StackPanel>
            
            <!-- æ ·å¼æŒ‰é’®ç»„ -->
            <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                <ToggleButton x:Name="BoldButton" Width="40" Height="30" Content="B" 
                              FontWeight="Bold" IsChecked="{Binding IsBold, Mode=TwoWay}"/>
                <ToggleButton x:Name="ItalicButton" Width="40" Height="30" Content="I" 
                              FontStyle="Italic" Margin="5,0,0,0"
                              IsChecked="{Binding IsItalic, Mode=TwoWay}"/>
                <ToggleButton x:Name="UnderlineButton" Width="40" Height="30" Content="U" 
                              Margin="5,0,0,0" IsChecked="{Binding IsUnderline, Mode=TwoWay}"/>
                <ToggleButton x:Name="StrikethroughButton" Width="40" Height="30" Content="S" 
                              Margin="5,0,0,0" IsChecked="{Binding IsStrikethrough, Mode=TwoWay}"/>
            </StackPanel>
            
            <!-- ========== é«˜çº§æ’ç‰ˆ ========== -->
            <TextBlock Text="é«˜çº§æ’ç‰ˆ" FontSize="14" Foreground="#ECF0F1" Margin="0,10,0,10"/>
            
            <!-- ğŸ¯ å­—é—´è· -->
            <StackPanel Margin="0,0,0,10">
                <TextBlock Text="å­—é—´è·" Foreground="#BDC3C7" FontSize="12"/>
                <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                    <Slider x:Name="LetterSpacingSlider" Width="220" Minimum="-5" Maximum="20"
                            Value="{Binding LetterSpacing, Mode=TwoWay}" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding LetterSpacing, StringFormat={}{0:F1}px}" 
                               Foreground="White" Margin="10,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>
            </StackPanel>
            
            <!-- ğŸ¯ è¡Œé—´è· -->
            <StackPanel Margin="0,0,0,10">
                <TextBlock Text="è¡Œé—´è·" Foreground="#BDC3C7" FontSize="12"/>
                <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                    <Slider x:Name="LineSpacingSlider" Width="220" Minimum="0.5" Maximum="3.0"
                            Value="{Binding LineSpacing, Mode=TwoWay}" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding LineSpacing, StringFormat={}{0:F1}}" 
                               Foreground="White" Margin="10,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>
            </StackPanel>
            
            <!-- ğŸ¯ å¯¹é½æ–¹å¼ -->
            <StackPanel Margin="0,0,0,15">
                <TextBlock Text="å¯¹é½æ–¹å¼" Foreground="#BDC3C7" FontSize="12" Margin="0,0,0,5"/>
                <StackPanel Orientation="Horizontal">
                    <RadioButton x:Name="AlignLeftButton" Content="å·¦å¯¹é½" Foreground="White"
                                 GroupName="Alignment" IsChecked="True" 
                                 Checked="OnAlignmentChanged" Tag="Left"/>
                    <RadioButton x:Name="AlignCenterButton" Content="å±…ä¸­" Foreground="White"
                                 GroupName="Alignment" Margin="10,0,0,0"
                                 Checked="OnAlignmentChanged" Tag="Center"/>
                    <RadioButton x:Name="AlignRightButton" Content="å³å¯¹é½" Foreground="White"
                                 GroupName="Alignment" Margin="10,0,0,0"
                                 Checked="OnAlignmentChanged" Tag="Right"/>
                </StackPanel>
            </StackPanel>
            
            <!-- ========== æ–‡å­—èƒŒæ™¯ ========== -->
            <TextBlock Text="æ–‡å­—èƒŒæ™¯" FontSize="14" Foreground="#ECF0F1" Margin="0,10,0,10"/>
            
            <!-- å¯ç”¨èƒŒæ™¯ -->
            <CheckBox x:Name="EnableBackgroundCheckBox" Content="æ˜¾ç¤ºèƒŒæ™¯" Foreground="White"
                      IsChecked="{Binding HasBackground, Mode=TwoWay}" Margin="0,0,0,10"/>
            
            <StackPanel x:Name="BackgroundPanel" 
                        IsEnabled="{Binding IsChecked, ElementName=EnableBackgroundCheckBox}">
                
                <!-- èƒŒæ™¯é¢œè‰² -->
                <StackPanel Margin="0,0,0,10">
                    <TextBlock Text="èƒŒæ™¯é¢œè‰²" Foreground="#BDC3C7" FontSize="12"/>
                    <Button x:Name="BackgroundColorButton" Height="30" Margin="0,5,0,0"
                            Content="é€‰æ‹©é¢œè‰²" Click="OnBackgroundColorClicked"/>
                </StackPanel>
                
                <!-- èƒŒæ™¯é€æ˜åº¦ -->
                <StackPanel Margin="0,0,0,10">
                    <TextBlock Text="èƒŒæ™¯é€æ˜åº¦" Foreground="#BDC3C7" FontSize="12"/>
                    <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                        <Slider x:Name="BackgroundOpacitySlider" Width="220" Minimum="0" Maximum="1"
                                Value="{Binding BackgroundOpacity, Mode=TwoWay}" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding BackgroundOpacity, StringFormat={}{0:P0}}" 
                                   Foreground="White" Margin="10,0,0,0" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
                
                <!-- èƒŒæ™¯å†…è¾¹è· -->
                <StackPanel Margin="0,0,0,10">
                    <TextBlock Text="å†…è¾¹è·" Foreground="#BDC3C7" FontSize="12"/>
                    <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                        <Slider x:Name="BackgroundPaddingSlider" Width="220" Minimum="0" Maximum="50"
                                Value="{Binding BackgroundPadding, Mode=TwoWay}" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding BackgroundPadding, StringFormat={}{0:F0}px}" 
                                   Foreground="White" Margin="10,0,0,0" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
                
                <!-- èƒŒæ™¯åœ†è§’ -->
                <StackPanel Margin="0,0,0,10">
                    <TextBlock Text="åœ†è§’" Foreground="#BDC3C7" FontSize="12"/>
                    <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                        <Slider x:Name="BackgroundCornerRadiusSlider" Width="220" Minimum="0" Maximum="50"
                                Value="{Binding BackgroundCornerRadius, Mode=TwoWay}" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding BackgroundCornerRadius, StringFormat={}{0:F0}px}" 
                                   Foreground="White" Margin="10,0,0,0" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
            
            <!-- ========== è¾¹æ¡† ========== -->
            <TextBlock Text="è¾¹æ¡†" FontSize="14" Foreground="#ECF0F1" Margin="0,10,0,10"/>
            
            <!-- å¯ç”¨è¾¹æ¡† -->
            <CheckBox x:Name="EnableBorderCheckBox" Content="æ˜¾ç¤ºè¾¹æ¡†" Foreground="White"
                      IsChecked="{Binding HasBorder, Mode=TwoWay}" Margin="0,0,0,10"/>
            
            <StackPanel x:Name="BorderPanel" 
                        IsEnabled="{Binding IsChecked, ElementName=EnableBorderCheckBox}">
                
                <!-- è¾¹æ¡†é¢œè‰² -->
                <StackPanel Margin="0,0,0,10">
                    <TextBlock Text="è¾¹æ¡†é¢œè‰²" Foreground="#BDC3C7" FontSize="12"/>
                    <Button x:Name="BorderColorButton" Height="30" Margin="0,5,0,0"
                            Content="é€‰æ‹©é¢œè‰²" Click="OnBorderColorClicked"/>
                </StackPanel>
                
                <!-- è¾¹æ¡†å®½åº¦ -->
                <StackPanel Margin="0,0,0,10">
                    <TextBlock Text="è¾¹æ¡†å®½åº¦" Foreground="#BDC3C7" FontSize="12"/>
                    <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                        <Slider x:Name="BorderWidthSlider" Width="220" Minimum="0" Maximum="20"
                                Value="{Binding BorderWidth, Mode=TwoWay}" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding BorderWidth, StringFormat={}{0:F0}px}" 
                                   Foreground="White" Margin="10,0,0,0" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
                
                <!-- è¾¹æ¡†åœ†è§’ -->
                <StackPanel Margin="0,0,0,10">
                    <TextBlock Text="åœ†è§’" Foreground="#BDC3C7" FontSize="12"/>
                    <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                        <Slider x:Name="BorderCornerRadiusSlider" Width="220" Minimum="0" Maximum="50"
                                Value="{Binding BorderCornerRadius, Mode=TwoWay}" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding BorderCornerRadius, StringFormat={}{0:F0}px}" 
                                   Foreground="White" Margin="10,0,0,0" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
                
                <!-- è¾¹æ¡†é€æ˜åº¦ -->
                <StackPanel Margin="0,0,0,10">
                    <TextBlock Text="è¾¹æ¡†é€æ˜åº¦" Foreground="#BDC3C7" FontSize="12"/>
                    <StackPanel Orientation="Horizontal" Margin="0,5,0,0">
                        <Slider x:Name="BorderOpacitySlider" Width="220" Minimum="0" Maximum="1"
                                Value="{Binding BorderOpacity, Mode=TwoWay}" VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding BorderOpacity, StringFormat={}{0:P0}}" 
                                   Foreground="White" Margin="10,0,0,0" VerticalAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
            
            <!-- æŒ‰é’®ç»„ -->
            <StackPanel Orientation="Horizontal" Margin="0,20,0,0" HorizontalAlignment="Right">
                <Button Content="åº”ç”¨" Width="80" Height="35" Click="OnApplyClicked"
                        Background="#27AE60" Foreground="White" BorderThickness="0"/>
                <Button Content="å–æ¶ˆ" Width="80" Height="35" Margin="10,0,0,0" Click="OnCancelClicked"
                        Background="#95A5A6" Foreground="White" BorderThickness="0"/>
            </StackPanel>
            
        </StackPanel>
    </ScrollViewer>
</UserControl>
```

---

## ğŸ’» å®Œæ•´ä»£ç ç¤ºä¾‹

### 4. SkiaTextBox æ§ä»¶ï¼ˆé›†æˆæ‰€æœ‰åŠŸèƒ½ï¼‰

```csharp
using SkiaSharp;
using SkiaSharp.Views.Desktop;
using SkiaSharp.Views.WPF;
using System.Windows;
using System.Windows.Input;
using ImageColorChanger.Models;
using ImageColorChanger.Core;

namespace ImageColorChanger.UI.Controls
{
    /// <summary>
    /// åŸºäº SkiaSharp çš„æ–‡æœ¬æ¡†æ§ä»¶
    /// æ”¯æŒæ‰€æœ‰é«˜çº§æ–‡æœ¬åŠŸèƒ½
    /// </summary>
    public class SkiaTextBox : SKElement
    {
        private SkiaTextRenderer _renderer;
        private TextProperties _textProperties;
        private string _text = "åŒå‡»ç¼–è¾‘æ–‡å­—";
        private bool _isSelected;
        
        public SkiaTextBox()
        {
            _renderer = new SkiaTextRenderer();
            _textProperties = new TextProperties();
            
            // è®¢é˜…å±æ€§å˜åŒ–äº‹ä»¶ï¼ˆå®æ—¶é¢„è§ˆï¼‰
            _textProperties.PropertyChanged += (s, e) => InvalidateVisual();
            
            // è®¢é˜…ç»˜åˆ¶äº‹ä»¶
            PaintSurface += OnPaintSurface;
            
            // é¼ æ ‡äº¤äº’
            MouseLeftButtonDown += OnMouseDown;
            MouseLeftButtonUp += OnMouseUp;
        }
        
        // ========== å±æ€§ ==========
        
        public string Text
        {
            get => _text;
            set { _text = value; InvalidateVisual(); }
        }
        
        public TextProperties TextProperties
        {
            get => _textProperties;
            set
            {
                if (_textProperties != null)
                    _textProperties.PropertyChanged -= (s, e) => InvalidateVisual();
                
                _textProperties = value;
                _textProperties.PropertyChanged += (s, e) => InvalidateVisual();
                InvalidateVisual();
            }
        }
        
        public bool IsSelected
        {
            get => _isSelected;
            set { _isSelected = value; InvalidateVisual(); }
        }
        
        // ========== æ¸²æŸ“ ==========
        
        private void OnPaintSurface(object sender, SKPaintSurfaceEventArgs e)
        {
            var canvas = e.Surface.Canvas;
            canvas.Clear(SKColors.Transparent);
            
            var bounds = new SKRect(0, 0, (float)ActualWidth, (float)ActualHeight);
            
            // æ¸²æŸ“æ–‡æœ¬ï¼ˆåŒ…å«èƒŒæ™¯å’Œè¾¹æ¡†ï¼‰
            _renderer.Render(canvas, _text, _textProperties, bounds);
            
            // æ¸²æŸ“é€‰ä¸­è¾¹æ¡†
            if (_isSelected)
            {
                RenderSelectionBorder(canvas, bounds);
            }
        }
        
        private void RenderSelectionBorder(SKCanvas canvas, SKRect bounds)
        {
            using var paint = new SKPaint
            {
                Color = new SKColor(52, 152, 219),  // è“è‰²
                Style = SKPaintStyle.Stroke,
                StrokeWidth = 2,
                IsAntialias = true,
                PathEffect = SKPathEffect.CreateDash(new[] { 5f, 5f }, 0)
            };
            
            canvas.DrawRect(bounds, paint);
        }
        
        // ========== äº¤äº’ ==========
        
        private void OnMouseDown(object sender, MouseButtonEventArgs e)
        {
            IsSelected = true;
            Focus();
            e.Handled = true;
        }
        
        private void OnMouseUp(object sender, MouseButtonEventArgs e)
        {
            // åŒå‡»è¿›å…¥ç¼–è¾‘æ¨¡å¼
            if (e.ClickCount == 2)
            {
                EnterEditMode();
            }
        }
        
        private void EnterEditMode()
        {
            // TODO: æ˜¾ç¤ºæ–‡æœ¬è¾“å…¥æ¡†
        }
    }
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“æ‰©å±•

### 5. æ•°æ®åº“è¿ç§»è„šæœ¬

```csharp
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Migrations;

namespace ImageColorChanger.Database.Migrations
{
    public partial class AddTextPropertiesColumns : Migration
    {
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            // æ·»åŠ æ–°åˆ—
            migrationBuilder.AddColumn<string>(
                name: "text_properties_json",
                table: "TextElements",
                type: "TEXT",
                nullable: true);
        }
        
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropColumn(
                name: "text_properties_json",
                table: "TextElements");
        }
    }
}
```

### 6. TextElement å®ä½“æ‰©å±•

```csharp
using System.ComponentModel.DataAnnotations.Schema;
using System.Text.Json;

namespace ImageColorChanger.Database.Models
{
    public partial class TextElement
    {
        // æ–°å¢ï¼šæ–‡æœ¬å±æ€§ï¼ˆJSON åºåˆ—åŒ–ï¼‰
        [Column("text_properties_json")]
        public string TextPropertiesJson { get; set; }
        
        [NotMapped]
        public TextProperties TextProperties
        {
            get => string.IsNullOrEmpty(TextPropertiesJson)
                ? new TextProperties()
                : JsonSerializer.Deserialize<TextProperties>(TextPropertiesJson);
            set => TextPropertiesJson = JsonSerializer.Serialize(value);
        }
    }
}
```

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

```csharp
// åˆ›å»ºæ–‡æœ¬æ¡†
var textBox = new SkiaTextBox
{
    Text = "å¯åº”ç»æ–‡\nç¬¬äºŒè¡Œæ–‡å­—",
    Width = 500,
    Height = 200
};

// è®¾ç½®æ–‡æœ¬å±æ€§
textBox.TextProperties.FontSize = 32;
textBox.TextProperties.IsItalic = true;           // ğŸ¯ æ–œä½“
textBox.TextProperties.LetterSpacing = 5;         // ğŸ¯ å­—é—´è· 5px
textBox.TextProperties.LineSpacing = 1.5f;        // ğŸ¯ è¡Œé—´è· 1.5 å€
textBox.TextProperties.Alignment = TextAlignment.Center;  // ğŸ¯ å±…ä¸­å¯¹é½

// è®¾ç½®æ–‡å­—èƒŒæ™¯
textBox.TextProperties.HasBackground = true;
textBox.TextProperties.BackgroundColor = new SKColor(52, 152, 219, 200);
textBox.TextProperties.BackgroundCornerRadius = 20;

// è®¾ç½®è¾¹æ¡†
textBox.TextProperties.HasBorder = true;
textBox.TextProperties.BorderColor = SKColors.White;
textBox.TextProperties.BorderWidth = 3;
textBox.TextProperties.BorderCornerRadius = 20;

// æ·»åŠ åˆ° Canvas
Canvas.SetLeft(textBox, 100);
Canvas.SetTop(textBox, 100);
EditorCanvas.Children.Add(textBox);
```

---

## âœ… åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ğŸ¯ è¾¹æ¡† | âœ… | é¢œè‰²ã€å®½åº¦ã€åœ†è§’ã€é€æ˜åº¦ |
| ğŸ¯ æ–‡å­—èƒŒæ™¯ | âœ… | é¢œè‰²ã€é€æ˜åº¦ã€å†…è¾¹è·ã€åœ†è§’ |
| ğŸ¯ æ–œä½“ | âœ… | SKFontStyle.Italic |
| ğŸ¯ å­—é—´è· | âœ… | é€å­—ç¬¦ç»˜åˆ¶ + é—´è· |
| ğŸ¯ è¡Œé—´è· | âœ… | è¡Œé«˜ = å­—å· Ã— è¡Œé—´è·å€æ•° |
| ğŸ¯ å·¦å¯¹é½ | âœ… | TextAlignment.Left |
| ğŸ¯ å±…ä¸­å¯¹é½ | âœ… | TextAlignment.Center |
| ğŸ¯ å³å¯¹é½ | âœ… | TextAlignment.Right |
| ç²—ä½“ | âœ… | SKFontStyle.Bold |
| ä¸‹åˆ’çº¿ | âœ… | DrawLine |
| åˆ é™¤çº¿ | âœ… | DrawLine |

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Canvas Cast Team  
**æœ€åæ›´æ–°**: 2025-11-02

