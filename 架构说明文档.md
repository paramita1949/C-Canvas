# Canvas Cast 架构说明文档

> **版本**: V5.0.9  
> **框架**: .NET 8.0 + WPF  
> **语言**: C#  
> **迁移来源**: Python + Tkinter  

---

## 📋 目录

1. [项目概述](#项目概述)
2. [整体架构](#整体架构)
3. [目录结构详解](#目录结构详解)
4. [核心模块说明](#核心模块说明)
5. [数据流转](#数据流转)
6. [关键技术](#关键技术)

---

## 项目概述

Canvas Cast 是一个专业的图片/视频浏览与投影管理工具，主要用于：
- **多屏幕投影演示**：支持双屏或多屏幕投影显示
- **关键帧播放**：按预设关键帧自动滚动播放图片
- **原图循环模式**：智能识别相似图片进行循环播放
- **视频/音频播放**：支持多种媒体格式播放
- **图片变色效果**：自动识别深色背景并优化黄色文字显示
- **文本幻灯片编辑**：创建和编辑文本幻灯片项目
- **数据库管理**：使用SQLite存储文件夹、文件、关键帧等数据

---

## 整体架构

Canvas Cast 采用 **分层架构 + 依赖注入** 的设计模式：

```
┌─────────────────────────────────────────────────────────┐
│                      UI Layer (WPF)                      │
│  MainWindow + ContactWindow + ScriptEditWindow          │
│  (用户交互、视图呈现、事件处理)                           │
└──────────────┬──────────────────────────────────────────┘
               │
┌──────────────▼──────────────────────────────────────────┐
│                    ViewModel Layer                       │
│  PlaybackControlViewModel + ViewModelBase               │
│  (MVVM数据绑定、UI状态管理)                              │
└──────────────┬──────────────────────────────────────────┘
               │
┌──────────────▼──────────────────────────────────────────┐
│                    Manager Layer                         │
│  ProjectionManager, KeyframeManager, ImportManager...   │
│  (业务逻辑协调、多模块编排)                              │
└──────────────┬──────────────────────────────────────────┘
               │
┌──────────────▼──────────────────────────────────────────┐
│                    Service Layer                         │
│  PlaybackService, RecordingService, CountdownService     │
│  (核心业务逻辑、算法实现、状态机)                        │
└──────────────┬──────────────────────────────────────────┘
               │
┌──────────────▼──────────────────────────────────────────┐
│                  Repository Layer                        │
│  KeyframeRepository, MediaFileRepository...              │
│  (数据访问层、CRUD操作封装)                              │
└──────────────┬──────────────────────────────────────────┘
               │
┌──────────────▼──────────────────────────────────────────┐
│                   Database Layer                         │
│  CanvasDbContext + Entity Framework Core                │
│  (ORM映射、SQLite数据库)                                 │
└─────────────────────────────────────────────────────────┘
```

---

## 目录结构详解

### 📁 根目录文件

| 文件名 | 作用 |
|--------|------|
| `App.xaml` / `App.xaml.cs` | WPF应用程序入口，配置依赖注入、全局异常处理 |
| `ImageColorChanger.csproj` | 项目配置文件，定义依赖包、构建规则、PAK资源打包 |
| `ImageColorChanger.sln` | Visual Studio解决方案文件 |
| `baodian.ico` | 应用程序图标 |
| `build.bat` | 快速构建脚本 |
| `run.bat` | 快速运行脚本 |
| `updata.txt` | 版本更新日志（详细记录每个版本的功能改进和Bug修复） |
| `pay.png` / `weixin.png` | 捐赠二维码图片（通过PAK加载） |

---

### 📁 Core（核心层）

**职责**: 提供核心服务、工具类、常量定义

| 文件名 | 作用 |
|--------|------|
| `Constants.cs` | 应用程序常量配置（图片限制、缩放参数、缓存大小、性能参数等） |
| `ImageProcessor.cs` | **核心图片处理器**<br>- 图片加载、缩放、显示<br>- 变色效果处理<br>- 原图模式/正常模式切换<br>- LRU图片缓存管理 |
| `ProjectionManager.cs` | **投影管理器**（已移至Managers目录，但核心功能在此处实现）<br>- 多屏幕检测和管理<br>- 投影窗口创建和控制<br>- 主屏与投影屏同步滚动<br>- 共享渲染优化（主屏和投影屏复用BitmapSource） |
| `GPUContext.cs` | **GPU加速管理器**<br>- SkiaSharp GPU上下文初始化<br>- 自动检测GPU可用性<br>- CPU/GPU混合渲染策略 |
| `ConfigManager.cs` | 配置管理器（读取和保存应用配置） |
| `FontConfig.cs` | 字体配置管理（加载自定义字体列表） |
| `PakManager.cs` | PAK资源包管理器（打包和加载Fonts/图片资源） |
| `ResourceLoader.cs` | 资源加载器（优先从PAK加载，降级到文件系统） |
| `PreloadCacheManager.cs` | 预加载缓存管理器<br>- 原图循环模式：预缓存相似图片<br>- 原图顺序模式：预缓存后续10张图片 |
| `ServiceCollectionExtensions.cs` | **依赖注入服务注册**<br>- 注册所有Service、Repository、Manager<br>- 配置数据库上下文 |

---

### 📁 Database（数据库层）

**职责**: 数据库模型定义、ORM配置、数据访问

#### 主要文件
| 文件名 | 作用 |
|--------|------|
| `CanvasDbContext.cs` | Entity Framework Core数据库上下文<br>- 定义DbSet集合<br>- 配置数据库连接<br>- 表结构初始化 |
| `DatabaseManager.cs` | **高级数据库操作接口**<br>- 文件夹/文件增删改查<br>- 关键帧管理<br>- 原图标记管理<br>- 设置保存与加载<br>- 数据库迁移和优化 |

#### Models（数据模型）
| 文件名 | 作用 |
|--------|------|
| `Folder.cs` | 文件夹模型（路径、名称、排序、高亮颜色、变色标记等） |
| `MediaFile.cs` | 媒体文件模型（路径、名称、类型、排序等） |
| `Keyframe.cs` | 关键帧模型（图片ID、位置、Y坐标、播放次数等） |
| `OriginalMark.cs` | 原图标记模型（循环/顺序模式标记） |
| `Slide.cs` | 幻灯片项目模型 |
| `TextProject.cs` | 文本项目模型 |
| `TextElement.cs` | 文本元素模型 |
| `Setting.cs` / `UISetting.cs` | 应用设置和UI设置模型 |
| `ImageDisplayLocation.cs` | 图片显示位置记录 |
| `ManualSortFolder.cs` | 手动排序文件夹标记 |

#### Models/Enums（枚举类型）
| 文件名 | 作用 |
|--------|------|
| `FileType.cs` | 文件类型枚举（Image/Video/Audio） |
| `ItemType.cs` | 项目类型枚举（Image/Folder） |
| `MarkType.cs` | 标记类型枚举（Loop循环/Sequence顺序） |
| `PlaybackMode.cs` | 播放模式枚举（Keyframe关键帧/Original原图） |
| `PlaybackStatus.cs` | 播放状态枚举（Idle/Recording/Playing/Paused/Stopped） |
| `LocationType.cs` | 位置类型枚举 |
| `ViewSplitMode.cs` | 视图分割模式枚举 |

#### Models/DTOs（数据传输对象）
| 文件名 | 作用 |
|--------|------|
| `TimingSequenceDto.cs` | 关键帧时间序列数据传输对象 |
| `OriginalTimingSequenceDto.cs` | 原图模式时间序列数据传输对象 |
| `PlaybackStateDto.cs` | 播放状态数据传输对象 |
| `SimilarImageDto.cs` | 相似图片数据传输对象 |
| `SplitRegionData.cs` | 分割区域数据 |

---

### 📁 Managers（管理器层）

**职责**: 业务逻辑协调、多模块编排

| 文件名 | 作用 |
|--------|------|
| `ProjectionManager.cs` | **投影管理器**<br>- 多屏幕投影窗口管理<br>- 主屏/投影屏同步<br>- 视频投影/图片投影切换<br>- 共享渲染优化 |
| `ImportManager.cs` | **导入管理器**<br>- 文件夹导入<br>- 批量文件导入<br>- 高性能BulkInsert |
| `SearchManager.cs` | **搜索管理器**<br>- 文件名搜索<br>- 拼音搜索支持 |
| `SortManager.cs` | **排序管理器**<br>- 文件夹排序<br>- 文件排序<br>- 手动拖拽排序 |
| `VideoPlayerManager.cs` | **视频播放管理器**<br>- LibVLC视频播放控制<br>- 主屏/投影屏视频同步<br>- 播放状态管理 |
| `ImageSaveManager.cs` | **图片保存管理器**<br>- 缩略图生成<br>- 图片导出 |
| `OriginalManager.cs` | **原图模式管理器**<br>- 相似图片查找<br>- 循环/顺序模式切换 |
| `TextProjectManager.cs` | **文本项目管理器**<br>- 文本幻灯片项目管理<br>- 文本元素CRUD |

#### Keyframes（关键帧子模块）
| 文件名 | 作用 |
|--------|------|
| `KeyframeManager.cs` | **关键帧管理器**<br>- 关键帧增删改查<br>- 滚动动画管理<br>- 循环模式控制 |
| `KeyframeNavigator.cs` | **关键帧导航器**<br>- 关键帧跳转（上一帧/下一帧）<br>- 平滑滚动/瞬间跳转<br>- 循环检测 |
| `KeyframeRepository.cs` | **关键帧仓库**<br>- 关键帧数据访问层<br>- 缓存优化 |

---

### 📁 Services（服务层）

**职责**: 核心业务逻辑、算法实现

#### Implementations（服务实现）
| 文件名 | 作用 |
|--------|------|
| `KeyframeRecordingService.cs` | **关键帧录制服务**<br>- 录制关键帧时间点<br>- 记录滚动位置<br>- 保存到数据库 |
| `KeyframePlaybackService.cs` | **关键帧播放服务**<br>- 按时间序列播放关键帧<br>- 滚动动画执行<br>- 循环控制 |
| `OriginalRecordingService.cs` | **原图录制服务**<br>- 录制原图播放时间点 |
| `OriginalPlaybackService.cs` | **原图播放服务**<br>- 原图循环/顺序播放 |
| `CompositePlaybackService.cs` | **合成播放服务**<br>- 关键帧+原图混合播放<br>- 比较模式 |
| `CountdownService.cs` | **倒计时服务**<br>- 播放倒计时管理<br>- 暂停时间累积 |

#### Interfaces（服务接口）
| 文件名 | 作用 |
|--------|------|
| `IRecordingService.cs` | 录制服务接口 |
| `IPlaybackService.cs` | 播放服务接口 |
| `ICountdownService.cs` | 倒计时服务接口 |

#### Algorithms（算法子模块）
| 文件名 | 作用 |
|--------|------|
| `PauseTimeAccumulator.cs` | **暂停时间累加器**<br>- 记录暂停时长<br>- 播放时间补偿 |
| `PlayCountJudge.cs` | **播放次数判断器**<br>- 判断关键帧是否已播放足够次数 |
| `SmartJumpDecider.cs` | **智能跳转决策器**<br>- 决定是否跳过当前关键帧 |

#### StateMachine（状态机）
| 文件名 | 作用 |
|--------|------|
| `PlaybackStateMachine.cs` | **播放状态机**<br>- 管理播放状态转换<br>- 确保状态合法性<br>- 状态变化事件 |

#### PlaybackServiceFactory.cs
播放服务工厂，根据播放模式创建对应的服务实例

---

### 📁 Repositories（仓库层）

**职责**: 数据访问层封装、CRUD操作

#### Interfaces（仓库接口）
| 文件名 | 作用 |
|--------|------|
| `IRepository.cs` | 通用仓库接口 |
| `IKeyframeRepository.cs` | 关键帧仓库接口 |
| `IMediaFileRepository.cs` | 媒体文件仓库接口 |
| `IOriginalModeRepository.cs` | 原图模式仓库接口 |
| `ITimingRepository.cs` | 时间记录仓库接口 |

#### Implementations（仓库实现）
| 文件名 | 作用 |
|--------|------|
| `RepositoryBase.cs` | 仓库基类（通用CRUD实现） |
| `KeyframeRepositoryImpl.cs` | 关键帧仓库实现 |
| `MediaFileRepositoryImpl.cs` | 媒体文件仓库实现 |
| `OriginalModeRepositoryImpl.cs` | 原图模式仓库实现 |
| `TimingRepository.cs` | 时间记录仓库实现 |

---

### 📁 UI（用户界面层）

**职责**: WPF界面、用户交互

| 文件名 | 作用 |
|--------|------|
| `MainWindow.xaml` / `.cs` | **主窗口**<br>- 图片/视频浏览<br>- 关键帧显示<br>- 项目树导航<br>- 媒体控制栏 |
| `MainWindow.Color.cs` | 主窗口扩展：变色效果相关逻辑 |
| `MainWindow.ContextMenu.cs` | 主窗口扩展：右键菜单逻辑 |
| `MainWindow.DragDrop.cs` | 主窗口扩展：拖拽排序逻辑 |
| `MainWindow.HotKey.cs` | 主窗口扩展：全局热键处理 |
| `MainWindow.Import.cs` | 主窗口扩展：文件导入逻辑 |
| `MainWindow.Keyframe.cs` | 主窗口扩展：关键帧操作逻辑 |
| `MainWindow.Lifecycle.cs` | 主窗口扩展：窗口生命周期管理 |
| `MainWindow.Media.cs` | 主窗口扩展：视频播放逻辑 |
| `MainWindow.Original.cs` | 主窗口扩展：原图模式逻辑 |
| `MainWindow.ProjectTree.cs` | 主窗口扩展：项目树操作逻辑 |
| `MainWindow.Settings.cs` | 主窗口扩展：设置管理逻辑 |
| `MainWindow.TextEditor.cs` | 主窗口扩展：文本编辑器逻辑 |
| `MainWindow.Zoom.cs` | 主窗口扩展：缩放控制逻辑 |
| `ContactWindow.xaml` / `.cs` | **联系窗口**<br>- 微信二维码<br>- 捐赠二维码 |
| `ScriptEditWindow.xaml` / `.cs` | **文本编辑窗口**<br>- 文本幻灯片编辑<br>- 富文本编辑器<br>- 拖拽文本框 |

#### Controls（自定义控件）
| 文件名 | 作用 |
|--------|------|
| `DraggableTextBox.cs` | 可拖拽文本框控件<br>- 拖拽移动<br>- 调整大小<br>- 双击编辑<br>- DEL删除 |

---

### 📁 ViewModels（视图模型层）

**职责**: MVVM数据绑定、UI状态管理

| 文件名 | 作用 |
|--------|------|
| `ViewModelBase.cs` | ViewModel基类（实现INotifyPropertyChanged） |
| `PlaybackControlViewModel.cs` | **播放控制视图模型**<br>- 播放/暂停/停止命令<br>- 倒计时显示<br>- 进度条绑定 |

---

### 📁 Utils（工具类）

**职责**: 辅助工具、全局服务

| 文件名 | 作用 |
|--------|------|
| `ImageCache.cs` | 图片缓存工具（LRU缓存策略） |
| `GlobalHotKeyManager.cs` | **全局热键管理器**<br>- 注册/注销系统级热键<br>- PgUp/PgDown/F2/ESC全局支持 |
| `AnimationHelper.cs` | 动画辅助工具<br>- 滚动动画创建<br>- 缓动函数封装 |
| `RealTimeFpsMonitor.cs` | **实时FPS监控器**<br>- 主屏FPS<br>- 投影屏FPS<br>- 同步次数统计 |

---

### 📁 BuildTools（构建工具）

**职责**: 资源打包工具

| 文件名 | 作用 |
|--------|------|
| `PackResources.cs` | PAK资源打包工具<br>- 打包Fonts字体文件<br>- 打包图片资源<br>- 生成Resources.pak |
| `PackResources.csproj` | 打包工具项目配置 |

---

### 📁 Fonts（字体资源）

**职责**: 自定义字体文件

- **Chinese/**: 中文字体文件（.ttf/.otf格式）
  - 卓健橄榄简体、思源宋体、站酷系列、阿里巴巴普惠体等
- **fonts.json**: 字体配置文件（完整列表）
- **fonts-simplified.json**: 简化字体列表

**说明**: 字体文件通过BuildTools打包为PAK，程序运行时动态加载

---

## 核心模块说明

### 1. 图片处理流程 (ImageProcessor)

```
加载图片文件
    ↓
SkiaSharp解码 (SKBitmap)
    ↓
应用变色效果 (可选)
    ↓
缩放处理 (GPU加速)
    ↓
转换为BitmapSource
    ↓
显示到UI
    ↓
缓存管理 (LRU)
```

### 2. 投影同步机制 (ProjectionManager)

```
主屏渲染图片
    ↓
生成BitmapSource
    ↓
共享到投影窗口 (零拷贝)
    ↓
主屏滚动位置变化
    ↓
计算相对滚动比例
    ↓
同步到投影屏幕
```

**关键优化**: 投影窗口直接使用主屏的BitmapSource，避免重复GPU渲染，性能提升2.5-3倍

### 3. 关键帧播放流程 (KeyframePlaybackService)

```
开始播放
    ↓
加载关键帧时间序列
    ↓
创建DispatcherTimer
    ↓
按时间触发跳转
    ↓
滚动动画执行
    ↓
更新UI显示
    ↓
循环检测
```

### 4. 状态机转换规则 (PlaybackStateMachine)

```
Idle (空闲)
  ├─→ Recording (录制)
  └─→ Playing (播放)

Recording (录制)
  └─→ Idle (停止录制)

Playing (播放)
  ├─→ Paused (暂停)
  ├─→ Stopped (停止)
  └─→ Idle (播放完成)

Paused (暂停)
  ├─→ Playing (继续)
  └─→ Stopped (停止)

Stopped (停止)
  ├─→ Idle (回到空闲)
  └─→ Playing (重新播放)
```

---

## 数据流转

### 图片加载数据流

```
用户点击图片
    ↓
MainWindow.ProjectTree (UI层)
    ↓
ImageProcessor.LoadImage() (Core层)
    ↓
SkiaSharp加载 + GPU缩放
    ↓
ImageProcessor.CurrentPhoto (缓存)
    ↓
MainWindow.ImageDisplay (UI显示)
    ↓
ProjectionManager.UpdateProjectionImage() (投影更新)
```

### 关键帧录制数据流

```
用户点击"录制关键帧"
    ↓
MainWindow.RecordKeyframe_Click() (UI层)
    ↓
KeyframeRecordingService.RecordKeyframeTimeAsync() (Service层)
    ↓
KeyframeRepository.AddKeyframe() (Repository层)
    ↓
DatabaseManager.AddKeyframe() (Database层)
    ↓
SQLite保存
```

### 播放控制数据流

```
用户点击"开始播放"
    ↓
PlaybackControlViewModel.PlayCommand (ViewModel层)
    ↓
PlaybackServiceFactory.CreatePlaybackService() (Service层)
    ↓
KeyframePlaybackService.PlayAsync() (Service层)
    ↓
PlaybackStateMachine.TryTransition() (状态机)
    ↓
KeyframeNavigator.JumpToKeyframe() (Manager层)
    ↓
ImageProcessor.ScrollToPosition() (Core层)
    ↓
AnimationHelper.CreateScrollAnimation() (Utils层)
    ↓
WPF动画执行
```

---

## 关键技术

### 1. GPU加速渲染 (SkiaSharp + WPF混合)

- **SkiaSharp CPU模式**: 使用SIMD指令（SSE2/AVX）并行处理缩放
- **WPF GPU合成**: 自动使用DirectX渲染到屏幕
- **优势**: 避免CPU↔GPU数据传输开销，比纯GPU加速更高效

### 2. 投影共享渲染

- **核心思想**: 主屏和投影屏共用同一个BitmapSource对象
- **实现方式**: `ReferenceEquals(mainBitmap, projBitmap) == true`
- **性能收益**: GPU开销从28-38ms降至10-15ms，FPS提升35%，内存优化40%

### 3. 智能预缓存 (PreloadCacheManager)

- **原图循环模式**: 预缓存相似图片（文件名差异≤1），实现秒切换
- **原图顺序模式**: 预缓存后续10张图片，连续浏览流畅
- **关键帧模式**: 图片已在内存，切换极速

### 4. LRU缓存策略 (IMemoryCache)

- **图片缓存**: 最多100张（基于权重）
- **渲染缓存**: 最多500项（支持多张图片×多种尺寸）
- **滑动过期**: 10分钟未访问自动清理

### 5. PAK资源打包

- **目的**: 减少散文件，提升加载速度
- **内容**: 字体文件 + 图片资源
- **加载**: `ResourceLoader` 优先从PAK加载，降级到文件系统

### 6. 依赖注入 (Microsoft.Extensions.DependencyInjection)

- **生命周期管理**:
  - `Singleton`: DatabaseManager, PlaybackStateMachine, CountdownService
  - `Scoped`: DbContext, Repository, Service
  - `Transient`: ViewModel
- **优势**: 解耦、可测试、可扩展

### 7. EF Core + SQLite

- **数据库文件**: `pyimages.db`
- **ORM映射**: 自动生成SQL、变更跟踪、迁移支持
- **批量插入**: `EFCore.BulkExtensions`，性能提升10-100倍

### 8. 全局热键 (GlobalHotKeyManager)

- **系统级热键**: 程序后台也能响应
- **支持按键**: PgUp、PgDown、F2、ESC
- **实现**: Windows API RegisterHotKey

### 9. 实时FPS监控 (RealTimeFpsMonitor)

- **测量方式**: 基于帧时间戳的精确计算
- **监控指标**: 主屏FPS、投影屏FPS、同步次数
- **输出**: 每秒统计一次

---

## 性能优化总结

| 优化项 | 技术方案 | 性能提升 |
|--------|---------|---------|
| 投影渲染 | 共享BitmapSource，零拷贝 | GPU开销降低60%，FPS提升35% |
| 图片缩放 | SkiaSharp CPU SIMD + WPF GPU | 缩放耗时26-53ms（最优） |
| 图片加载 | 智能预缓存 + LRU缓存 | 切换延迟从833ms降至5ms |
| 批量导入 | EF Core BulkInsert | 性能提升10-100倍 |
| 滚动同步 | 120 FPS节流 + 相对位置计算 | 平滑流畅无卡顿 |
| 内存管理 | 多级缓存 + 滑动过期 | 内存占用降低40% |

---

## 待优化项

1. **GPU纯渲染模式**: 探索WPF OpenGL上下文创建，实现纯GPU变色效果
2. **多线程渲染**: 后台线程预渲染投影图片，避免UI阻塞
3. **增量更新**: 部分区域重绘，减少全图渲染
4. **WebP格式支持**: 更小的文件体积，更快的加载速度
5. **GPU视频解码**: 使用硬件加速解码视频，降低CPU占用

---

## 附录：主要依赖包

| 包名 | 版本 | 用途 |
|------|------|------|
| `SkiaSharp` | 2.88.8 | 高性能图片处理 |
| `SkiaSharp.Views.WPF` | 2.88.8 | SkiaSharp WPF集成 |
| `LibVLCSharp` | 3.8.5 | 视频/音频播放 |
| `MaterialDesignThemes` | 5.1.0 | Material Design UI组件 |
| `Microsoft.EntityFrameworkCore.Sqlite` | 8.0.0 | SQLite ORM |
| `EFCore.BulkExtensions` | 8.1.1 | 高性能批量操作 |
| `Microsoft.Extensions.DependencyInjection` | 8.0.0 | 依赖注入容器 |
| `Microsoft.Extensions.Caching.Memory` | 8.0.0 | 内存缓存 |
| `CommunityToolkit.Mvvm` | 8.2.2 | MVVM工具包 |

---

**文档生成时间**: 2025-10-22  
**对应版本**: V5.0.9  
**维护者**: Canvas Cast Team

