name: æž„å»ºå’Œå‘å¸ƒï¼ˆæ··æ·†ä¿æŠ¤ï¼‰

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.cs'
      - '**.xaml'
      - '**.csproj'
      - 'updata.txt'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PROJECT_NAME: ImageColorChanger
  OUTPUT_NAME: Canvas Cast
  DOTNET_VERSION: '8.0.x'

permissions:
  contents: write

jobs:
  build:
    name: ç¼–è¯‘ã€æ··æ·†å’Œå‘å¸ƒ
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ðŸ”§ è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ðŸ“¦ è¿˜åŽŸä¾èµ–
      run: dotnet restore ${{ env.PROJECT_NAME }}.csproj
    
    - name: ðŸ”¨ ç¼–è¯‘ Release ç‰ˆæœ¬
      run: dotnet build ${{ env.PROJECT_NAME }}.csproj -c Release --no-restore
    
    - name: ðŸ“¦ å‘å¸ƒè°ƒè¯•ç‰ˆï¼ˆç”¨äºŽ Releaseï¼‰
      run: dotnet publish ${{ env.PROJECT_NAME }}.csproj -c Release -o publish-original --self-contained false
    
    - name: ðŸ“‹ èŽ·å–ç‰ˆæœ¬å·
      id: get_version
      shell: pwsh
      run: |
        # ä»Ž MainWindow.xaml è¯»å–ç‰ˆæœ¬å·
        $xamlFile = "UI\MainWindow.xaml"
        if (Test-Path $xamlFile) {
          $content = Get-Content $xamlFile -Raw
          if ($content -match 'Title="[^"]*V(\d+\.\d+\.\d+)"') {
            $version = $matches[1]
            $tag = "V$version"
            echo "version=$version" >> $env:GITHUB_OUTPUT
            echo "tag=$tag" >> $env:GITHUB_OUTPUT
            Write-Host "è¯»å–åˆ°ç‰ˆæœ¬å·: $version"
            Write-Host "ç”Ÿæˆæ ‡ç­¾: $tag"
          } else {
            $version = "1.0.0"
            $tag = "V$version"
            echo "version=$version" >> $env:GITHUB_OUTPUT
            echo "tag=$tag" >> $env:GITHUB_OUTPUT
            Write-Host "æœªæ‰¾åˆ°ç‰ˆæœ¬å·ï¼Œä½¿ç”¨é»˜è®¤: $version"
          }
        }
    
    - name: ðŸ“¦ æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯
      shell: pwsh
      run: |
        Write-Host "=================================" -ForegroundColor Cyan
        Write-Host "ðŸ“¦ ç¼–è¯‘ä¿¡æ¯" -ForegroundColor Cyan
        Write-Host "=================================" -ForegroundColor Cyan
        Write-Host "é¡¹ç›®: ${{ env.PROJECT_NAME }}"
        Write-Host "ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
        Write-Host ""
        
        $exePath = "bin\Release\net8.0-windows\${{ env.PROJECT_NAME }}.exe"
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length / 1MB
          Write-Host "åŽŸå§‹æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB" -ForegroundColor Green
        }
    
    - name: ðŸ”’ å®‰è£… Obfuscar
      shell: pwsh
      run: |
        Write-Host "å®‰è£… Obfuscar æ··æ·†å·¥å…·ï¼ˆæ”¯æŒ .NET 8ï¼‰..." -ForegroundColor Yellow
        dotnet tool install --global Obfuscar.GlobalTool
        Write-Host "âœ… Obfuscar å®‰è£…æˆåŠŸ" -ForegroundColor Green
    
    - name: ðŸ” æ··æ·†ä»£ç 
      shell: pwsh
      run: |
        Write-Host "=================================" -ForegroundColor Cyan
        Write-Host "ðŸ” å¼€å§‹æ··æ·†ä»£ç " -ForegroundColor Cyan
        Write-Host "=================================" -ForegroundColor Cyan
        
        # Add .NET tools to PATH
        $env:PATH = "$env:USERPROFILE\.dotnet\tools;$env:PATH"
        
        # Change to the build output directory
        cd "bin\Release\net8.0-windows"
        
        # Debug: List files
        Write-Host "Files in build directory:" -ForegroundColor Yellow
        Get-ChildItem -Name
        
        # Check if exe exists
        $exeName = "Canvas Cast.exe"
        if (Test-Path $exeName) {
          $fileInfo = Get-Item $exeName
          Write-Host "Found: $exeName - Size: $($fileInfo.Length) bytes" -ForegroundColor Green
          
          # Check if it's a valid .NET assembly
          try {
            $assembly = [System.Reflection.Assembly]::LoadFrom((Resolve-Path $exeName).Path)
            Write-Host "Assembly loaded successfully: $($assembly.FullName)" -ForegroundColor Green
          } catch {
            Write-Host "WARNING: Failed to load as .NET assembly: $_" -ForegroundColor Red
          }
        } else {
          Write-Host "ERROR: $exeName not found!" -ForegroundColor Red
          exit 1
        }
        
        # Copy obfuscar config file to build directory
        Copy-Item "..\..\..\obfuscar.xml" -Destination "."
        
        # Run obfuscation with Obfuscar (only DLL, not EXE)
        obfuscar.console obfuscar.xml
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "âŒ æ··æ·†å¤±è´¥ï¼" -ForegroundColor Red
          exit 1
        }
        
        Write-Host "âœ… æ··æ·†å®Œæˆï¼" -ForegroundColor Green
        
        # Verify obfuscated DLL
        $obfuscatedDll = "Confused\${{ env.OUTPUT_NAME }}.dll"
        if (Test-Path $obfuscatedDll) {
          $dllSize = (Get-Item $obfuscatedDll).Length / 1MB
          Write-Host "æ··æ·†åŽ DLL å¤§å°: $([math]::Round($dllSize, 2)) MB" -ForegroundColor Green
        } else {
          Write-Host "âŒ æœªæ‰¾åˆ°æ··æ·†åŽçš„ DLLï¼" -ForegroundColor Red
          exit 1
        }
        
        # Copy EXE and other files to Confused directory
        Write-Host "å¤åˆ¶å¯åŠ¨å™¨å’Œä¾èµ–æ–‡ä»¶..." -ForegroundColor Yellow
        
        # å¤åˆ¶ä¸»ç¨‹åºæ–‡ä»¶
        Copy-Item "${{ env.OUTPUT_NAME }}.exe" -Destination "Confused\" -Force
        Copy-Item "${{ env.OUTPUT_NAME }}.runtimeconfig.json" -Destination "Confused\" -Force
        Copy-Item "${{ env.OUTPUT_NAME }}.deps.json" -Destination "Confused\" -Force
        
        # å¤åˆ¶æ‰€æœ‰ DLLï¼ˆé™¤äº†ä¸» DLLï¼Œå› ä¸ºå·²ç»æ··æ·†è¿‡äº†ï¼‰
        Get-ChildItem -Filter "*.dll" | Where-Object { $_.Name -ne "${{ env.OUTPUT_NAME }}.dll" } | ForEach-Object {
          Copy-Item $_.FullName -Destination "Confused\" -Force
          Write-Host "  å¤åˆ¶ DLL: $($_.Name)"
        }
        
        # å¤åˆ¶ PAK æ–‡ä»¶
        if (Test-Path "Resources.pak") {
          Copy-Item "Resources.pak" -Destination "Confused\" -Force
          Write-Host "  å¤åˆ¶ PAK: Resources.pak"
        }
        
        # å¤åˆ¶ runtimes ç›®å½•ï¼ˆåŒ…å«æœ¬æœºä¾èµ–ï¼‰
        if (Test-Path "runtimes") {
          Copy-Item "runtimes" -Destination "Confused\runtimes" -Recurse -Force
          Write-Host "  å¤åˆ¶ç›®å½•: runtimes"
        }
        
        # å¤åˆ¶ libvlc ç›®å½•ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        if (Test-Path "libvlc") {
          Copy-Item "libvlc" -Destination "Confused\libvlc" -Recurse -Force
          Write-Host "  å¤åˆ¶ç›®å½•: libvlc"
        }
        
        # åˆ—å‡º Confused ç›®å½•å†…å®¹ä»¥ä¾¿æ£€æŸ¥
        Write-Host ""
        Write-Host "=== Confused ç›®å½•å†…å®¹ ===" -ForegroundColor Cyan
        Get-ChildItem "Confused" -Name | ForEach-Object { Write-Host "  - $_" }
        
        Write-Host ""
        Write-Host "âœ… æ‰€æœ‰æ–‡ä»¶å·²å¤åˆ¶åˆ° Confused ç›®å½•" -ForegroundColor Green
    
    - name: ðŸ“¦ æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
      shell: pwsh
      run: |
        $publishDir = "publish"
        $confusedDir = "bin\Release\net8.0-windows\Confused"
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path $publishDir | Out-Null
        
        # æ‰“åŒ…æ­£å¼ç‰ˆæ–‡ä»¶
        Write-Host "ðŸ“¦ æ‰“åŒ…æ­£å¼ç‰ˆæ–‡ä»¶..." -ForegroundColor Green
        Copy-Item "$confusedDir\*" -Destination $publishDir -Recurse -Force
        
        # åˆ é™¤å¯èƒ½å¤åˆ¶è¿›æ¥çš„ bin æ–‡ä»¶å¤¹
        if (Test-Path "$publishDir\bin") {
          Write-Host "âš ï¸ å‘çŽ°å¹¶åˆ é™¤ bin æ–‡ä»¶å¤¹..." -ForegroundColor Yellow
          Remove-Item "$publishDir\bin" -Recurse -Force
        }
        
        Write-Host "âœ… æ‰“åŒ…å®Œæˆ" -ForegroundColor Green
    
    - name: âœ… éªŒè¯æž„å»ºäº§ç‰©
      shell: pwsh
      run: |
        Write-Host "=== éªŒè¯æž„å»ºäº§ç‰© ===" -ForegroundColor Cyan
        
        # æ£€æŸ¥ä¸»ç¨‹åº
        if (Test-Path "publish\${{ env.OUTPUT_NAME }}.exe") {
          Write-Host "âœ… ä¸»ç¨‹åºéªŒè¯æˆåŠŸ" -ForegroundColor Green
          $exeInfo = Get-Item "publish\${{ env.OUTPUT_NAME }}.exe"
          Write-Host "ä¸»ç¨‹åºå¤§å°: $([math]::Round($exeInfo.Length / 1MB, 2)) MB"
        } else {
          Write-Host "âŒ æž„å»ºäº§ç‰©éªŒè¯å¤±è´¥ - ${{ env.OUTPUT_NAME }}.exe ä¸å­˜åœ¨" -ForegroundColor Red
          Write-Host "publishç›®å½•å†…å®¹:" -ForegroundColor Yellow
          Get-ChildItem "publish" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  - $($_.Name)" }
          exit 1
        }
        
        # æ£€æŸ¥å¹¶å¤„ç†PAKæ–‡ä»¶
        if (Test-Path "publish\Resources.pak") {
          Write-Host "âœ… PAKæ–‡ä»¶å·²å­˜åœ¨äºŽpublishç›®å½•" -ForegroundColor Green
          $pakInfo = Get-Item "publish\Resources.pak"
          Write-Host "PAKæ–‡ä»¶å¤§å°: $([math]::Round($pakInfo.Length / 1MB, 2)) MB"
        } else {
          Write-Host "âš ï¸ PAKæ–‡ä»¶ä¸å­˜åœ¨äºŽpublishç›®å½•ï¼Œå°è¯•ä»ŽConfusedç›®å½•å¤åˆ¶..." -ForegroundColor Yellow
          if (Test-Path "bin\Release\net8.0-windows\Confused\Resources.pak") {
            Copy-Item "bin\Release\net8.0-windows\Confused\Resources.pak" "publish\Resources.pak"
            Write-Host "âœ… PAKæ–‡ä»¶å·²ä»ŽConfusedç›®å½•å¤åˆ¶åˆ°publishæ ¹ç›®å½•" -ForegroundColor Green
            $pakInfo = Get-Item "publish\Resources.pak"
            Write-Host "PAKæ–‡ä»¶å¤§å°: $([math]::Round($pakInfo.Length / 1MB, 2)) MB"
          } elseif (Test-Path "bin\Release\net8.0-windows\Resources.pak") {
            Copy-Item "bin\Release\net8.0-windows\Resources.pak" "publish\Resources.pak"
            Write-Host "âœ… PAKæ–‡ä»¶å·²ä»Žbinç›®å½•å¤åˆ¶åˆ°publishæ ¹ç›®å½•" -ForegroundColor Green
            $pakInfo = Get-Item "publish\Resources.pak"
            Write-Host "PAKæ–‡ä»¶å¤§å°: $([math]::Round($pakInfo.Length / 1MB, 2)) MB"
          } else {
            Write-Host "âŒ é”™è¯¯: æœªæ‰¾åˆ°PAKæ–‡ä»¶" -ForegroundColor Red
            exit 1
          }
        }
        
        # ç¡®è®¤æ²¡æœ‰ bin æ–‡ä»¶å¤¹ï¼ˆåº”è¯¥åœ¨æ‰“åŒ…æ­¥éª¤å·²åˆ é™¤ï¼‰
        if (Test-Path "publish\bin") {
          Write-Host "âŒ é”™è¯¯: publish\binç›®å½•ä¸åº”è¯¥å­˜åœ¨ï¼" -ForegroundColor Red
          exit 1
        }
        
        Write-Host ""
        Write-Host "=== publishç›®å½•æœ€ç»ˆå†…å®¹ ===" -ForegroundColor Cyan
        Get-ChildItem "publish" -Name | ForEach-Object { Write-Host "  - $_" }
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      id: create_package
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $tag = "${{ steps.get_version.outputs.tag }}"
        $releaseZip = "Canvas-Cast-$tag-win-x64.zip"
        $debugZip = "Canvas-Cast-$tag-win-x64-Debug.zip"
        
        # åŽ‹ç¼©æ­£å¼ç‰ˆ
        Write-Host "åˆ›å»ºæ­£å¼ç‰ˆå‘å¸ƒåŒ…..." -ForegroundColor Yellow
        Compress-Archive -Path publish\* -DestinationPath $releaseZip
        
        if (Test-Path $releaseZip) {
          $size = (Get-Item $releaseZip).Length / 1MB
          Write-Host "âœ… æ­£å¼ç‰ˆå‘å¸ƒåŒ…åˆ›å»ºæˆåŠŸ: $([math]::Round($size, 2)) MB" -ForegroundColor Green
        } else {
          Write-Host "âŒ æ­£å¼ç‰ˆå‘å¸ƒåŒ…åˆ›å»ºå¤±è´¥" -ForegroundColor Red
          exit 1
        }
        
        # åŽ‹ç¼©è°ƒè¯•ç‰ˆï¼ˆä½¿ç”¨ publish-original ç›®å½•ï¼‰
        Write-Host "åˆ›å»ºè°ƒè¯•ç‰ˆåŽ‹ç¼©åŒ…..." -ForegroundColor Yellow
        Compress-Archive -Path publish-original\* -DestinationPath $debugZip
        
        if (Test-Path $debugZip) {
          $size = (Get-Item $debugZip).Length / 1MB
          Write-Host "âœ… è°ƒè¯•ç‰ˆå‘å¸ƒåŒ…åˆ›å»ºæˆåŠŸ: $([math]::Round($size, 2)) MB" -ForegroundColor Green
        } else {
          Write-Host "âŒ è°ƒè¯•ç‰ˆå‘å¸ƒåŒ…åˆ›å»ºå¤±è´¥" -ForegroundColor Red
          exit 1
        }
        
        # è¾“å‡ºæ–‡ä»¶åä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
        echo "release_zip=$releaseZip" >> $env:GITHUB_OUTPUT
        echo "debug_zip=$debugZip" >> $env:GITHUB_OUTPUT
    
    - name: ðŸ“¤ ä¸Šä¼ æ­£å¼ç‰ˆç¨‹åºï¼ˆArtifactï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.OUTPUT_NAME }}-v${{ steps.get_version.outputs.version }}
        path: publish/
        retention-days: 30
    
    - name: ðŸ“¤ ä¸Šä¼ è°ƒè¯•ç‰ˆç¨‹åºï¼ˆè°ƒè¯•ç”¨ï¼Œ7å¤©åŽåˆ é™¤ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.OUTPUT_NAME }}-v${{ steps.get_version.outputs.version }}-Debug
        path: publish-original/
        retention-days: 7
    
    - name: ðŸ“Š è°ƒè¯•Releaseä¿¡æ¯
      shell: pwsh
      run: |
        Write-Host "=== Releaseè°ƒè¯•ä¿¡æ¯ ===" -ForegroundColor Cyan
        Write-Host "ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.version }}"
        Write-Host "æ ‡ç­¾: ${{ steps.get_version.outputs.tag }}"
        Write-Host "æ­£å¼ç‰ˆåŒ…æ–‡ä»¶: ${{ steps.create_package.outputs.release_zip }}"
        Write-Host "è°ƒè¯•ç‰ˆåŒ…æ–‡ä»¶: ${{ steps.create_package.outputs.debug_zip }}"
        Write-Host "æ­£å¼ç‰ˆåŒ…å­˜åœ¨: $(Test-Path '${{ steps.create_package.outputs.release_zip }}')"
        Write-Host "è°ƒè¯•ç‰ˆåŒ…å­˜åœ¨: $(Test-Path '${{ steps.create_package.outputs.debug_zip }}')"
        if (Test-Path '${{ steps.create_package.outputs.release_zip }}') {
          $size = (Get-Item '${{ steps.create_package.outputs.release_zip }}').Length / 1MB
          Write-Host "æ­£å¼ç‰ˆåŒ…å¤§å°: $([math]::Round($size, 2)) MB" -ForegroundColor Green
        }
        if (Test-Path '${{ steps.create_package.outputs.debug_zip }}') {
          $size = (Get-Item '${{ steps.create_package.outputs.debug_zip }}').Length / 1MB
          Write-Host "è°ƒè¯•ç‰ˆåŒ…å¤§å°: $([math]::Round($size, 2)) MB" -ForegroundColor Green
        }
        Write-Host "======================" -ForegroundColor Cyan
    
    - name: ðŸŽ‰ åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ steps.create_package.outputs.release_zip }}
          ${{ steps.create_package.outputs.debug_zip }}
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: Canvas Cast ${{ steps.get_version.outputs.tag }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ðŸŽ‰ Canvas Cast ${{ steps.get_version.outputs.tag }}
          
          > ðŸ’¡ **ç‰ˆæœ¬è¯´æ˜Ž**ï¼šåŒ…å«æ­£å¼ç‰ˆå’Œè°ƒè¯•ç‰ˆä¸¤ä¸ªä¸‹è½½é€‰é¡¹
          
          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          - **æ­£å¼ç‰ˆ** (æŽ¨è)ï¼š`${{ steps.create_package.outputs.release_zip }}` - æ­£å¼å‘å¸ƒç‰ˆæœ¬
          - **è°ƒè¯•ç‰ˆ**ï¼š`${{ steps.create_package.outputs.debug_zip }}` - å¼€å‘è°ƒè¯•ç”¨ç‰ˆæœ¬
          
          ### ðŸ“– ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ä¸Šè¿° ZIP æ–‡ä»¶
          2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `Canvas Cast.exe`
          
          ### âš™ï¸ ç³»ç»Ÿè¦æ±‚
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - .NET 8.0 Runtime (å¦‚æœªå®‰è£…ä¼šè‡ªåŠ¨æç¤ºä¸‹è½½)
          
          ### ðŸ”§ æŠ€æœ¯æ ˆ
          - å¼€å‘è¯­è¨€ï¼šC#
          - UIæ¡†æž¶ï¼šWPF
          - è¿è¡Œæ—¶ï¼š.NET 8.0
          
          ### ðŸ“ æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„å˜æ›´è®°å½•
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ðŸ“Š æž„å»ºæ‘˜è¦
      shell: pwsh
      run: |
        Write-Host "### âœ… æž„å»ºæˆåŠŸ" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "- **ç‰ˆæœ¬**: ${{ steps.get_version.outputs.version }}" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "- **å¹³å°**: Windows x64" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "- **æ­£å¼ç‰ˆ**: ${{ steps.create_package.outputs.release_zip }}" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "- **è°ƒè¯•ç‰ˆ**: ${{ steps.create_package.outputs.debug_zip }}" >> $env:GITHUB_STEP_SUMMARY
        Write-Host "- **.NET**: ${{ env.DOTNET_VERSION }}" >> $env:GITHUB_STEP_SUMMARY

