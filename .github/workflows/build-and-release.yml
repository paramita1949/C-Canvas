name: æ„å»ºå’Œå‘å¸ƒï¼ˆæ··æ·†ä¿æŠ¤ï¼‰

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.cs'
      - '**.xaml'
      - '**.csproj'
      - 'updata.txt'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PROJECT_NAME: ImageColorChanger
  OUTPUT_NAME: Canvas Cast
  DOTNET_VERSION: '6.0.x'

permissions:
  contents: write

jobs:
  build:
    name: ç¼–è¯‘ã€æ··æ·†å’Œå‘å¸ƒ
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ”§ è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ğŸ“¦ è¿˜åŸä¾èµ–
      run: dotnet restore
    
    - name: ğŸ”¨ ç¼–è¯‘ Release ç‰ˆæœ¬
      run: dotnet build -c Release --no-restore
    
    - name: ğŸ“‹ è·å–ç‰ˆæœ¬å·
      id: get_version
      shell: pwsh
      run: |
        # ä» MainWindow.xaml è¯»å–ç‰ˆæœ¬å·
        $xamlFile = "UI\MainWindow.xaml"
        if (Test-Path $xamlFile) {
          $content = Get-Content $xamlFile -Raw
          if ($content -match 'Title="[^"]*V(\d+\.\d+\.\d+)"') {
            $version = $matches[1]
            echo "version=$version" >> $env:GITHUB_OUTPUT
            Write-Host "è¯»å–åˆ°ç‰ˆæœ¬å·: $version"
          } else {
            $version = "1.0.0"
            echo "version=$version" >> $env:GITHUB_OUTPUT
            Write-Host "æœªæ‰¾åˆ°ç‰ˆæœ¬å·ï¼Œä½¿ç”¨é»˜è®¤: $version"
          }
        }
    
    - name: ğŸ“¦ æ˜¾ç¤ºç¼–è¯‘ä¿¡æ¯
      shell: pwsh
      run: |
        Write-Host "=================================" -ForegroundColor Cyan
        Write-Host "ğŸ“¦ ç¼–è¯‘ä¿¡æ¯" -ForegroundColor Cyan
        Write-Host "=================================" -ForegroundColor Cyan
        Write-Host "é¡¹ç›®: ${{ env.PROJECT_NAME }}"
        Write-Host "ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}"
        Write-Host ""
        
        $exePath = "bin\Release\net6.0-windows\${{ env.PROJECT_NAME }}.exe"
        if (Test-Path $exePath) {
          $fileSize = (Get-Item $exePath).Length / 1MB
          Write-Host "åŸå§‹æ–‡ä»¶å¤§å°: $([math]::Round($fileSize, 2)) MB" -ForegroundColor Green
        }
    
    - name: ğŸ”’ ä¸‹è½½ ConfuserEx
      shell: pwsh
      run: |
        Write-Host "ä¸‹è½½ ConfuserEx æ··æ·†å·¥å…·..." -ForegroundColor Yellow
        $url = "https://github.com/mkaring/ConfuserEx/releases/latest/download/ConfuserEx2-CLI.zip"
        
        try {
          Invoke-WebRequest -Uri $url -OutFile "ConfuserEx.zip" -UseBasicParsing
          Expand-Archive -Path "ConfuserEx.zip" -DestinationPath "ConfuserEx" -Force
          Remove-Item "ConfuserEx.zip"
          Write-Host "âœ… ConfuserEx ä¸‹è½½å®Œæˆ" -ForegroundColor Green
        } catch {
          Write-Host "âŒ ä¸‹è½½å¤±è´¥: $_" -ForegroundColor Red
          exit 1
        }
    
    - name: ğŸ” æ··æ·†ä»£ç 
      shell: pwsh
      run: |
        Write-Host "=================================" -ForegroundColor Cyan
        Write-Host "ğŸ” å¼€å§‹æ··æ·†ä»£ç " -ForegroundColor Cyan
        Write-Host "=================================" -ForegroundColor Cyan
        
        try {
          .\ConfuserEx\Confuser.CLI.exe confuser.crproj
          Write-Host "âœ… æ··æ·†å®Œæˆï¼" -ForegroundColor Green
        } catch {
          Write-Host "âŒ æ··æ·†å¤±è´¥: $_" -ForegroundColor Red
          exit 1
        }
        
        Write-Host ""
        $obfuscatedPath = "bin\Release\net6.0-windows\Confused\${{ env.PROJECT_NAME }}.exe"
        if (Test-Path $obfuscatedPath) {
          $obfuscatedSize = (Get-Item $obfuscatedPath).Length / 1MB
          Write-Host "æ··æ·†åæ–‡ä»¶å¤§å°: $([math]::Round($obfuscatedSize, 2)) MB" -ForegroundColor Green
        } else {
          Write-Host "âŒ æœªæ‰¾åˆ°æ··æ·†åçš„æ–‡ä»¶ï¼" -ForegroundColor Red
          exit 1
        }
    
    - name: ğŸ“¦ æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
      shell: pwsh
      run: |
        $publishDir = "publish"
        $confusedDir = "bin\Release\net6.0-windows\Confused"
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        New-Item -ItemType Directory -Force -Path $publishDir | Out-Null
        
        # å¤åˆ¶æ··æ·†åçš„æ–‡ä»¶
        Copy-Item "$confusedDir\*" -Destination $publishDir -Recurse -Force
        
        Write-Host "âœ… æ‰“åŒ…å®Œæˆ" -ForegroundColor Green
    
    - name: ğŸ“¤ ä¸Šä¼ æ··æ·†åçš„ç¨‹åºï¼ˆArtifactï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.OUTPUT_NAME }}-v${{ steps.get_version.outputs.version }}-Obfuscated
        path: publish/
        retention-days: 30
    
    - name: ğŸ“¤ ä¸Šä¼ åŸå§‹ç¨‹åºï¼ˆè°ƒè¯•ç”¨ï¼Œ7å¤©ååˆ é™¤ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.OUTPUT_NAME }}-v${{ steps.get_version.outputs.version }}-Original
        path: bin/Release/net6.0-windows/
        retention-days: 7
    
    - name: ğŸ‰ åˆ›å»º GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          publish/${{ env.PROJECT_NAME }}.exe
        body: |
          ## ğŸ¨ ${{ env.OUTPUT_NAME }} v${{ steps.get_version.outputs.version }}
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - âœ… ä»£ç å·²ä½¿ç”¨ ConfuserEx æ··æ·†ä¿æŠ¤
          - âœ… é˜²æ­¢åç¼–è¯‘å’Œé€†å‘å·¥ç¨‹
          - âœ… åŒ…å«å®Œæ•´è¿è¡Œæ—¶ç¯å¢ƒ
          - âœ… æ”¯æŒ Windows 10/11
          
          ### ğŸ“¥ ä¸‹è½½è¯´æ˜
          1. ä¸‹è½½ `${{ env.PROJECT_NAME }}.exe`
          2. åŒå‡»è¿è¡Œå³å¯
          3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦ .NET 6 è¿è¡Œæ—¶
          
          ### ğŸ”’ å®‰å…¨è¯´æ˜
          æœ¬ç¨‹åºå·²ä½¿ç”¨ **ConfuserEx 2** è¿›è¡Œä»£ç æ··æ·†ä¿æŠ¤ï¼Œæœ‰æ•ˆé˜²æ­¢ï¼š
          - åç¼–è¯‘æŸ¥çœ‹æºä»£ç 
          - é€†å‘å·¥ç¨‹åˆ†æ
          - éæ³•ç ´è§£å’Œç¯¡æ”¹
          
          ### ğŸ“‹ æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹æäº¤è®°å½•äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹
          
          ---
          
          **æ„å»ºæ—¶é—´:** ${{ github.event.head_commit.timestamp }}  
          **æäº¤SHA:** ${{ github.sha }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

