name: æž„å»ºå’Œå‘å¸ƒ

on:
  push:
    paths:
      - 'updata.txt'
  workflow_dispatch:

env:
  PROJECT_NAME: ImageColorChanger
  OUTPUT_NAME: Canvas
  DOTNET_VERSION: '8.0.x'

jobs:
  build:
    name: ç¼–è¯‘å’Œæ‰“åŒ…
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: è¿˜åŽŸä¾èµ–
      run: dotnet restore
    
    - name: ç¼–è¯‘é¡¹ç›®
      run: dotnet build --configuration Release --no-restore
    
    - name: å‘å¸ƒé¡¹ç›®
      run: dotnet publish -c Release -o publish --self-contained false -p:PublishSingleFile=false
    
    - name: èŽ·å–ç‰ˆæœ¬å·
      id: get_version
      shell: pwsh
      run: |
        if ($env:GITHUB_REF -like 'refs/tags/v*') {
          $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        } else {
          $version = "dev-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "æž„å»ºç‰ˆæœ¬: $version"
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $zipName = "${{ env.OUTPUT_NAME }}-$version-win-x64.zip"
        
        # åŽ‹ç¼©å‘å¸ƒæ–‡ä»¶
        Compress-Archive -Path publish\* -DestinationPath $zipName
        
        # è®¡ç®—æ–‡ä»¶å¤§å°
        $size = (Get-Item $zipName).Length / 1MB
        echo "åŒ…å¤§å°: $([math]::Round($size, 2)) MB"
        
        # è¾“å‡ºæ–‡ä»¶åä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
        echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
      id: create_package
    
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.OUTPUT_NAME }}-${{ steps.get_version.outputs.version }}
        path: ${{ steps.create_package.outputs.zip_name }}
        retention-days: 30
    
    - name: åˆ›å»º GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.create_package.outputs.zip_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ðŸŽ‰ Canvas Cast ${{ steps.get_version.outputs.version }}
          
          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          - ä¸‹è½½ `${{ steps.create_package.outputs.zip_name }}` 
          - è§£åŽ‹åˆ°ä»»æ„ç›®å½•
          - è¿è¡Œ `Canvas.exe`
          
          ### âš™ï¸ ç³»ç»Ÿè¦æ±‚
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - .NET 8.0 Runtime (å¦‚æœªå®‰è£…ä¼šè‡ªåŠ¨æç¤ºä¸‹è½½)
          
          ### ðŸ“ æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„å˜æ›´è®°å½•
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: æž„å»ºæ‘˜è¦
      shell: pwsh
      run: |
        echo "### âœ… æž„å»ºæˆåŠŸ" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: ${{ steps.get_version.outputs.version }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **å¹³å°**: Windows x64" >> $env:GITHUB_STEP_SUMMARY
        echo "- **åŒ…å**: ${{ steps.create_package.outputs.zip_name }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **.NET**: ${{ env.DOTNET_VERSION }}" >> $env:GITHUB_STEP_SUMMARY

