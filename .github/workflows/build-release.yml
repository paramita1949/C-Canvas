name: C#/WPFæ„å»ºå’Œå‘å¸ƒ

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_NAME: ImageColorChanger
  OUTPUT_NAME: CanvasCast
  DOTNET_VERSION: '8.0.x'

permissions:
  contents: write

jobs:
  build:
    name: ç¼–è¯‘å’Œæ‰“åŒ…
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: è¿˜åŸä¾èµ–
      run: dotnet restore
    
    - name: ç¼–è¯‘é¡¹ç›®
      run: dotnet build ImageColorChanger.csproj --configuration Release --no-restore
    
    - name: å‘å¸ƒé¡¹ç›®
      run: dotnet publish ImageColorChanger.csproj -c Release -o publish --self-contained false
    
    - name: è·å–ç‰ˆæœ¬å·
      id: get_version
      shell: pwsh
      run: |
        # ä» .csproj ä¸­æå–ç‰ˆæœ¬å·
        $csprojContent = Get-Content "ImageColorChanger.csproj" -Raw
        if ($csprojContent -match '<Version>([\d.]+)</Version>') {
          $version = $matches[1]
          $appVersion = "V$version"
          echo "ä» .csproj æå–åˆ°ç‰ˆæœ¬å·: $appVersion"
        } else {
          $appVersion = "V5.3.5"
          echo "âš ï¸ æ— æ³•ä» .csproj æå–ç‰ˆæœ¬å·ï¼Œä½¿ç”¨é»˜è®¤å€¼: $appVersion"
        }
        
        # ç”Ÿæˆæˆ–è·å– tag
        if ($env:GITHUB_REF -like 'refs/tags/*') {
          $tag = $env:GITHUB_REF -replace 'refs/tags/', ''
          echo "æ£€æµ‹åˆ°æ¨é€ tag: $tag"
        } else {
          $runNumber = $env:GITHUB_RUN_NUMBER
          $tagBase = "auto-$runNumber"

          try {
            $shortSha = (git rev-parse --short HEAD).Trim()
          } catch {
            $shortSha = ''
            echo "è­¦å‘Š: æ— æ³•è·å–æäº¤å“ˆå¸Œï¼Œtag å°†ä¸åŒ…å«å“ˆå¸Œ"
          }

          if ($shortSha) {
            $tag = "$tagBase-$shortSha"
          } else {
            $tag = $tagBase
          }
          
          echo "æœªæ£€æµ‹åˆ°å¤–éƒ¨ tagï¼Œè‡ªåŠ¨ç”Ÿæˆ tag: $tag"
        }
        
        # ç»„åˆå®Œæ•´ç‰ˆæœ¬å·: V5.2.8-auto-104-6548a7b
        $fullVersion = "$appVersion-$tag"

        echo "app_version=$appVersion" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        echo "full_version=$fullVersion" >> $env:GITHUB_OUTPUT
        echo ""
        echo "=== ç‰ˆæœ¬ä¿¡æ¯ ==="
        echo "åº”ç”¨ç‰ˆæœ¬: $appVersion"
        echo "æ„å»ºæ ‡ç­¾: $tag"
        echo "å®Œæ•´ç‰ˆæœ¬: $fullVersion"
    
    - name: éªŒè¯æ„å»ºäº§ç‰©
      shell: pwsh
      run: |
        echo "=== éªŒè¯æ„å»ºäº§ç‰© ==="
        echo "å½“å‰å·¥ä½œç›®å½•: $pwd"
        echo ""
        
        # æ£€æŸ¥ä¸»ç¨‹åº
        if (Test-Path "publish\CanvasCast.exe") {
          echo "âœ… ä¸»ç¨‹åºéªŒè¯æˆåŠŸ"
          $exeInfo = Get-Item "publish\CanvasCast.exe"
          echo "ä¸»ç¨‹åºå¤§å°: $([math]::Round($exeInfo.Length / 1MB, 2)) MB"
        } else {
          echo "âŒ æ„å»ºäº§ç‰©éªŒè¯å¤±è´¥ - CanvasCast.exe ä¸å­˜åœ¨"
          echo "publishç›®å½•å†…å®¹:"
          Get-ChildItem "publish" -ErrorAction SilentlyContinue | ForEach-Object { echo "  - $($_.Name)" }
          exit 1
        }
        
        # æ£€æŸ¥å¹¶å¤„ç†PAKæ–‡ä»¶
        if (Test-Path "publish\Resources.pak") {
          echo "âœ… PAKæ–‡ä»¶å·²å­˜åœ¨äºpublishç›®å½•"
          $pakInfo = Get-Item "publish\Resources.pak"
          echo "PAKæ–‡ä»¶å¤§å°: $([math]::Round($pakInfo.Length / 1MB, 2)) MB"
        } else {
          echo "âš ï¸ PAKæ–‡ä»¶ä¸å­˜åœ¨äºpublishç›®å½•ï¼Œå°è¯•ä»binç›®å½•å¤åˆ¶..."
          if (Test-Path "bin\Release\net8.0-windows\Resources.pak") {
            Copy-Item "bin\Release\net8.0-windows\Resources.pak" "publish\Resources.pak"
            echo "âœ… PAKæ–‡ä»¶å·²ä»binç›®å½•å¤åˆ¶åˆ°publishæ ¹ç›®å½•"
            $pakInfo = Get-Item "publish\Resources.pak"
            echo "PAKæ–‡ä»¶å¤§å°: $([math]::Round($pakInfo.Length / 1MB, 2)) MB"
          } else {
            echo "âŒ é”™è¯¯: binç›®å½•ä¸­ä¹Ÿæ²¡æœ‰PAKæ–‡ä»¶"
            exit 1
          }
        }
        
        # æ£€æŸ¥å¹¶å¤„ç†åœ£ç»æ•°æ®åº“æ–‡ä»¶
        echo "=== å¤„ç†åœ£ç»æ•°æ®åº“æ–‡ä»¶ ==="
        
        # å¤„ç† bible.db
        if (Test-Path "publish\data\assets\bible.db") {
          echo "âœ… bible.db å·²å­˜åœ¨"
          $dbInfo = Get-Item "publish\data\assets\bible.db"
          echo "bible.db å¤§å°: $([math]::Round($dbInfo.Length / 1MB, 2)) MB"
        } else {
          echo "âš ï¸ bible.db ä¸å­˜åœ¨äºpublishç›®å½•ï¼Œå°è¯•å¤åˆ¶..."
          if (Test-Path "data\assets\bible.db") {
            New-Item -ItemType Directory -Path "publish\data\assets" -Force | Out-Null
            Copy-Item "data\assets\bible.db" "publish\data\assets\bible.db"
            echo "âœ… bible.db å·²å¤åˆ¶åˆ°publishç›®å½•"
            $dbInfo = Get-Item "publish\data\assets\bible.db"
            echo "bible.db å¤§å°: $([math]::Round($dbInfo.Length / 1MB, 2)) MB"
          } else {
            echo "âŒ é”™è¯¯: æºä»£ç ä¸­ä¹Ÿæ²¡æœ‰ bible.db æ–‡ä»¶"
            exit 1
          }
        }
        
        # å¤„ç† hehebenfanti.db
        if (Test-Path "publish\data\assets\hehebenfanti.db") {
          echo "âœ… hehebenfanti.db å·²å­˜åœ¨"
          $dbInfo = Get-Item "publish\data\assets\hehebenfanti.db"
          echo "hehebenfanti.db å¤§å°: $([math]::Round($dbInfo.Length / 1MB, 2)) MB"
        } else {
          echo "âš ï¸ hehebenfanti.db ä¸å­˜åœ¨äºpublishç›®å½•ï¼Œå°è¯•å¤åˆ¶..."
          if (Test-Path "data\assets\hehebenfanti.db") {
            New-Item -ItemType Directory -Path "publish\data\assets" -Force | Out-Null
            Copy-Item "data\assets\hehebenfanti.db" "publish\data\assets\hehebenfanti.db"
            echo "âœ… hehebenfanti.db å·²å¤åˆ¶åˆ°publishç›®å½•"
            $dbInfo = Get-Item "publish\data\assets\hehebenfanti.db"
            echo "hehebenfanti.db å¤§å°: $([math]::Round($dbInfo.Length / 1MB, 2)) MB"
          } else {
            echo "âŒ é”™è¯¯: æºä»£ç ä¸­ä¹Ÿæ²¡æœ‰ hehebenfanti.db æ–‡ä»¶"
            exit 1
          }
        }
        
        # åˆ é™¤publishç›®å½•ä¸­çš„binæ–‡ä»¶å¤¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (Test-Path "publish\bin") {
          echo "âš ï¸ å‘ç°publish\binç›®å½•ï¼Œæ­£åœ¨åˆ é™¤..."
          Remove-Item "publish\bin" -Recurse -Force
          echo "âœ… å·²åˆ é™¤publish\binç›®å½•"
        }
        
        echo ""
        echo "=== publishç›®å½•æœ€ç»ˆå†…å®¹ ==="
        Get-ChildItem "publish" -Name | ForEach-Object { echo "  - $_" }
        if (Test-Path "publish\data") {
          echo ""
          echo "=== dataç›®å½•å†…å®¹ ==="
          Get-ChildItem "publish\data" -Recurse -Name | ForEach-Object { echo "  - $_" }
        }
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      shell: pwsh
      run: |
        $fullVersion = "${{ steps.get_version.outputs.full_version }}"
        $tag = "${{ steps.get_version.outputs.tag }}"
        $fullZipName = "Canvas-Full.zip"
        $updateZipName = "Canvas-Update.zip"
        
        # ========== åˆ›å»ºå®Œæ•´åŒ… ==========
        echo "=== åˆ›å»ºå®Œæ•´åŒ… ==="
        Compress-Archive -Path publish\* -DestinationPath $fullZipName
        
        # éªŒè¯å®Œæ•´åŒ…
        if (Test-Path $fullZipName) {
          $size = (Get-Item $fullZipName).Length / 1MB
          echo "âœ… å®Œæ•´åŒ…åˆ›å»ºæˆåŠŸ"
          echo "åŒ…åç§°: $fullZipName"
          echo "åŒ…å¤§å°: $([math]::Round($size, 2)) MB"
        } else {
          echo "âŒ å®Œæ•´åŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        }
        
        # ========== åˆ›å»ºå¢é‡æ›´æ–°åŒ… ==========
        echo ""
        echo "=== åˆ›å»ºå¢é‡æ›´æ–°åŒ… ==="
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•å­˜æ”¾æ›´æ–°æ–‡ä»¶
        $updateDir = "update_temp"
        New-Item -ItemType Directory -Path $updateDir -Force | Out-Null
        
        # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        $exeFile = "publish\CanvasCast.exe"
        $dllFile = "publish\CanvasCast.dll"
        $pakFile = "publish\Resources.pak"
        
        if (Test-Path $exeFile) {
          Copy-Item $exeFile $updateDir\
          $exeSize = (Get-Item $exeFile).Length / 1MB
          echo "âœ… å·²æ·»åŠ  CanvasCast.exe ($([math]::Round($exeSize, 2)) MB)"
        } else {
          echo "âŒ é”™è¯¯: CanvasCast.exe ä¸å­˜åœ¨"
          exit 1
        }
        
        if (Test-Path $dllFile) {
          Copy-Item $dllFile $updateDir\
          $dllSize = (Get-Item $dllFile).Length / 1MB
          echo "âœ… å·²æ·»åŠ  CanvasCast.dll ($([math]::Round($dllSize, 2)) MB)"
        } else {
          echo "âŒ é”™è¯¯: CanvasCast.dll ä¸å­˜åœ¨"
          exit 1
        }
        
        if (Test-Path $pakFile) {
          Copy-Item $pakFile $updateDir\
          $pakSize = (Get-Item $pakFile).Length / 1MB
          echo "âœ… å·²æ·»åŠ  Resources.pak ($([math]::Round($pakSize, 2)) MB)"
        } else {
          echo "âš ï¸ è­¦å‘Š: Resources.pak ä¸å­˜åœ¨ï¼Œç»§ç»­..."
        }
        
        # å‹ç¼©æ›´æ–°åŒ…
        Compress-Archive -Path $updateDir\* -DestinationPath $updateZipName
        
        # éªŒè¯æ›´æ–°åŒ…
        if (Test-Path $updateZipName) {
          $updateSize = (Get-Item $updateZipName).Length / 1MB
          echo "âœ… å¢é‡æ›´æ–°åŒ…åˆ›å»ºæˆåŠŸ"
          echo "åŒ…åç§°: $updateZipName"
          echo "åŒ…å¤§å°: $([math]::Round($updateSize, 2)) MB"
        } else {
          echo "âŒ å¢é‡æ›´æ–°åŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        }
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        Remove-Item $updateDir -Recurse -Force
        
        # ========== è¾“å‡ºç»Ÿè®¡ä¿¡æ¯ ==========
        echo ""
        echo "=== æ‰“åŒ…å®Œæˆç»Ÿè®¡ ==="
        echo "å®Œæ•´åŒ…: $fullZipName - $([math]::Round((Get-Item $fullZipName).Length / 1MB, 2)) MB"
        echo "æ›´æ–°åŒ…: $updateZipName - $([math]::Round((Get-Item $updateZipName).Length / 1MB, 2)) MB"
        $ratio = ((Get-Item $updateZipName).Length / (Get-Item $fullZipName).Length) * 100
        echo "æ›´æ–°åŒ…ä»…ä¸ºå®Œæ•´åŒ…çš„ $([math]::Round($ratio, 1))%"
        
        # è¾“å‡ºæ–‡ä»¶åä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "full_zip_name=$fullZipName" >> $env:GITHUB_OUTPUT
        echo "update_zip_name=$updateZipName" >> $env:GITHUB_OUTPUT
      id: create_package
    
    - name: ä¸Šä¼ å®Œæ•´åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: Canvas-Cast-Full-${{ steps.get_version.outputs.full_version }}
        path: ${{ steps.create_package.outputs.full_zip_name }}
        retention-days: 30

    - name: ä¸Šä¼ æ›´æ–°åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: Canvas-Cast-Update-${{ steps.get_version.outputs.full_version }}
        path: ${{ steps.create_package.outputs.update_zip_name }}
        retention-days: 30

    - name: ä¸Šä¼ DLLåŸæ–‡ä»¶
      uses: actions/upload-artifact@v4
      with:
        name: CanvasCast-DLL-${{ steps.get_version.outputs.full_version }}
        path: publish/CanvasCast.dll
        retention-days: 30
    
    - name: è°ƒè¯•Releaseä¿¡æ¯
      shell: pwsh
      run: |
        echo "=== Releaseè°ƒè¯•ä¿¡æ¯ ==="
        echo "åº”ç”¨ç‰ˆæœ¬: ${{ steps.get_version.outputs.app_version }}"
        echo "æ„å»ºæ ‡ç­¾: ${{ steps.get_version.outputs.tag }}"
        echo "å®Œæ•´ç‰ˆæœ¬: ${{ steps.get_version.outputs.full_version }}"
        echo ""
        echo "å®Œæ•´åŒ…: ${{ steps.create_package.outputs.full_zip_name }}"
        echo "å®Œæ•´åŒ…å­˜åœ¨: $(Test-Path '${{ steps.create_package.outputs.full_zip_name }}')"
        if (Test-Path '${{ steps.create_package.outputs.full_zip_name }}') {
          $size = (Get-Item '${{ steps.create_package.outputs.full_zip_name }}').Length / 1MB
          echo "å®Œæ•´åŒ…å¤§å°: $([math]::Round($size, 2)) MB"
        }
        echo ""
        echo "æ›´æ–°åŒ…: ${{ steps.create_package.outputs.update_zip_name }}"
        echo "æ›´æ–°åŒ…å­˜åœ¨: $(Test-Path '${{ steps.create_package.outputs.update_zip_name }}')"
        if (Test-Path '${{ steps.create_package.outputs.update_zip_name }}') {
          $size = (Get-Item '${{ steps.create_package.outputs.update_zip_name }}').Length / 1MB
          echo "æ›´æ–°åŒ…å¤§å°: $([math]::Round($size, 2)) MB"
        }
        echo "======================"
    
    - name: éªŒè¯ä¸Šä¼ æ–‡ä»¶
      shell: pwsh
      run: |
        echo "=== éªŒè¯å³å°†ä¸Šä¼ çš„æ–‡ä»¶ ==="
        $files = @(
          "${{ steps.create_package.outputs.full_zip_name }}",
          "${{ steps.create_package.outputs.update_zip_name }}",
          "publish/CanvasCast.dll"
        )
        foreach ($file in $files) {
          if (Test-Path $file) {
            echo "âœ… $file"
          } else {
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨: $file"
          }
        }
    
    - name: åˆ›å»º GitHub Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ steps.create_package.outputs.full_zip_name }}
          ${{ steps.create_package.outputs.update_zip_name }}
          publish/CanvasCast.dll
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: å’æ…•æŠ•å½± ${{ steps.get_version.outputs.full_version }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ‰ å’æ…•æŠ•å½± ${{ steps.get_version.outputs.full_version }}

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜

          æœ¬æ¬¡å‘å¸ƒæä¾›ä¸‰ç§æ–‡ä»¶ï¼Œè¯·æ ¹æ®éœ€è¦é€‰æ‹©ï¼š

          #### ğŸ†• æ–°ç”¨æˆ· - å®Œæ•´å®‰è£…åŒ…
          - ğŸ“¥ ä¸‹è½½ `Canvas-Full.zip`
          - ğŸ“‚ è§£å‹åˆ°ä»»æ„ç›®å½•
          - â–¶ï¸ è¿è¡Œ `CanvasCast.exe`

          #### ğŸ”„ è€ç”¨æˆ· - å¢é‡æ›´æ–°ï¼ˆæ¨èï¼‰
          - ğŸ“¥ ä¸‹è½½ `Canvas-Update.zip`
          - ğŸ“‚ è§£å‹å¾—åˆ° `CanvasCast.exe`ã€`CanvasCast.dll` å’Œ `Resources.pak`
          - ğŸ” è¦†ç›–åŸç¨‹åºç›®å½•ä¸­çš„åŒåæ–‡ä»¶
          - â–¶ï¸ é‡å¯ç¨‹åºå³å¯

          #### ğŸ”§ å¼€å‘è€… - DLLåŸæ–‡ä»¶
          - ğŸ“¥ ä¸‹è½½ `CanvasCast.dll` (å•ç‹¬æ–‡ä»¶)
          - ğŸ” ç›´æ¥æ›¿æ¢åŸç¨‹åºç›®å½•ä¸­çš„ `CanvasCast.dll`
          - â–¶ï¸ é€‚ç”¨äºä»…ä»£ç é€»è¾‘æ›´æ–°çš„åœºæ™¯

          > **æç¤º**:
          > - å¢é‡æ›´æ–°åŒ…åŒ…å«å®Œæ•´çš„æ ¸å¿ƒæ–‡ä»¶ï¼ˆEXEã€DLLã€PAKï¼‰
          > - å¦‚æœåªæ˜¯ä»£ç é€»è¾‘æ›´æ–°ï¼Œåªéœ€æ›¿æ¢ `CanvasCast.dll`
          > - å¦‚æœåŒ…å«èµ„æºæ›´æ–°ï¼Œéœ€è¦åŒæ—¶æ›¿æ¢ `Resources.pak`
          > - å¦‚æœä¸»ç¨‹åºæœ‰æ›´æ–°ï¼Œéœ€è¦æ›¿æ¢ `CanvasCast.exe`
          > - DLLåŸæ–‡ä»¶æœªç»è¿‡ä»£ç ä¿æŠ¤ï¼Œä»…ä¾›å¼€å‘è°ƒè¯•ä½¿ç”¨

          ### âš™ï¸ ç³»ç»Ÿè¦æ±‚
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - .NET 8.0 Runtime (å¦‚æœªå®‰è£…ä¼šè‡ªåŠ¨æç¤ºä¸‹è½½)

          ### ğŸ“ æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„å˜æ›´è®°å½•
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: æ„å»ºæ‘˜è¦
      shell: pwsh
      run: |
        echo "### âœ… æ„å»ºæˆåŠŸ" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "- **å®Œæ•´ç‰ˆæœ¬**: ${{ steps.get_version.outputs.full_version }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **åº”ç”¨ç‰ˆæœ¬**: ${{ steps.get_version.outputs.app_version }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **æ„å»ºæ ‡ç­¾**: ${{ steps.get_version.outputs.tag }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **å¹³å°**: Windows x64" >> $env:GITHUB_STEP_SUMMARY
        echo "- **.NET**: ${{ env.DOTNET_VERSION }}" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "### ğŸ“¦ å‘å¸ƒåŒ…" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY

        $fullSize = [math]::Round((Get-Item "${{ steps.create_package.outputs.full_zip_name }}").Length / 1MB, 2)
        $updateSize = [math]::Round((Get-Item "${{ steps.create_package.outputs.update_zip_name }}").Length / 1MB, 2)
        $dllSize = [math]::Round((Get-Item "publish/CanvasCast.dll").Length / 1MB, 2)
        $updateRatio = [math]::Round(($updateSize / $fullSize) * 100, 1)

        echo "- **å®Œæ•´åŒ…**: ``${{ steps.create_package.outputs.full_zip_name }}`` - $fullSize MB" >> $env:GITHUB_STEP_SUMMARY
        echo "- **æ›´æ–°åŒ…**: ``${{ steps.create_package.outputs.update_zip_name }}`` - $updateSize MB (å®Œæ•´åŒ…çš„ $updateRatio%)" >> $env:GITHUB_STEP_SUMMARY
        echo "- **DLLåŸæ–‡ä»¶**: ``CanvasCast.dll`` - $dllSize MB" >> $env:GITHUB_STEP_SUMMARY

