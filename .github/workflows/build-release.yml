name: C#/WPF构建和发布

on:
  push:
    paths:
      - 'updata.txt'
  workflow_dispatch:

env:
  PROJECT_NAME: ImageColorChanger
  OUTPUT_NAME: Canvas Cast
  DOTNET_VERSION: '8.0.x'

permissions:
  contents: write

jobs:
  build:
    name: 编译和打包
    runs-on: windows-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: 设置 .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: 还原依赖
      run: dotnet restore
    
    - name: 编译项目
      run: dotnet build ImageColorChanger.csproj --configuration Release --no-restore
    
    - name: 发布项目
      run: dotnet publish ImageColorChanger.csproj -c Release -o publish --self-contained false -p:PublishSingleFile=false
    
    - name: 获取版本号
      id: get_version
      shell: pwsh
      run: |
        if ($env:GITHUB_REF -like 'refs/tags/v*') {
          $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        } else {
          # 从MainWindow.xaml的Title属性中读取版本号
          $xamlFile = "UI\MainWindow.xaml"
          if (Test-Path $xamlFile) {
            $titleMatch = Select-String -Path $xamlFile -Pattern 'Title="[^"]*V(\d+\.\d+\.\d+)"' | ForEach-Object { $_.Matches[0].Groups[1].Value }
            if ($titleMatch) {
              $version = $titleMatch
              echo "从MainWindow.xaml读取版本: $version"
            } else {
              # 如果读取失败，使用时间戳作为后备
              $timestamp = Get-Date -Format 'yyyyMMdd-HHmmss'
              $version = "dev-$timestamp"
              echo "无法从MainWindow.xaml读取版本，使用时间戳: $version"
            }
          } else {
            # 如果文件不存在，使用时间戳作为后备
            $timestamp = Get-Date -Format 'yyyyMMdd-HHmmss'
            $version = "dev-$timestamp"
            echo "MainWindow.xaml文件不存在，使用时间戳: $version"
          }
        }
        
        # 如果版本号已经有V前缀，直接使用；否则添加V前缀
        if ($version -like 'V*') {
          $tag = $version
        } else {
          $tag = "V$version"
        }
        
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        echo "构建版本: $version"
        echo "标签: $tag"
    
    - name: 验证构建产物
      shell: pwsh
      run: |
        if (Test-Path "publish\Canvas Cast.exe") {
          echo "✅ 构建产物验证成功"
          $exeInfo = Get-Item "publish\Canvas Cast.exe"
          echo "文件大小: $([math]::Round($exeInfo.Length / 1MB, 2)) MB"
        } else {
          echo "❌ 构建产物验证失败 - Canvas Cast.exe 不存在"
          echo "publish目录内容:"
          Get-ChildItem "publish" -ErrorAction SilentlyContinue | ForEach-Object { echo "  - $($_.Name)" }
          exit 1
        }
    
    - name: 创建发布包
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $tag = "${{ steps.get_version.outputs.tag }}"
        $zipName = "Canvas-Cast-CSharp-$tag-win-x64.zip"
        
        # 压缩发布文件
        Compress-Archive -Path publish\* -DestinationPath $zipName
        
        # 验证zip文件
        if (Test-Path $zipName) {
          $size = (Get-Item $zipName).Length / 1MB
          echo "✅ 发布包创建成功"
          echo "包大小: $([math]::Round($size, 2)) MB"
        } else {
          echo "❌ 发布包创建失败"
          exit 1
        }
        
        # 输出文件名供后续步骤使用
        echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
      id: create_package
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: Canvas-Cast-${{ steps.get_version.outputs.version }}
        path: ${{ steps.create_package.outputs.zip_name }}
        retention-days: 30
    
    - name: 调试Release信息
      shell: pwsh
      run: |
        echo "=== Release调试信息 ==="
        echo "版本号: ${{ steps.get_version.outputs.version }}"
        echo "标签: ${{ steps.get_version.outputs.tag }}"
        echo "包文件: ${{ steps.create_package.outputs.zip_name }}"
        echo "包文件存在: $(Test-Path '${{ steps.create_package.outputs.zip_name }}')"
        if (Test-Path '${{ steps.create_package.outputs.zip_name }}') {
          $size = (Get-Item '${{ steps.create_package.outputs.zip_name }}').Length / 1MB
          echo "包文件大小: $([math]::Round($size, 2)) MB"
        }
        echo "======================"
    
    - name: 创建 GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.create_package.outputs.zip_name }}
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: Canvas Cast CSharp ${{ steps.get_version.outputs.tag }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## 🎉 Canvas Cast CSharp ${{ steps.get_version.outputs.tag }}
          
          > 💡 **版本说明**：本版本使用 C# / WPF 开发，基于 .NET 8.0 框架
          
          ### 📦 下载说明
          - 下载 `${{ steps.create_package.outputs.zip_name }}` 
          - 解压到任意目录
          - 运行 `Canvas Cast.exe`
          
          ### ⚙️ 系统要求
          - Windows 10 或更高版本
          - .NET 8.0 Runtime (如未安装会自动提示下载)
          
          ### 🔧 技术栈
          - 开发语言：C# 
          - UI框架：WPF
          - 运行时：.NET 8.0
          
          ### 📝 更新日志
          请查看下方自动生成的变更记录
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 构建摘要
      shell: pwsh
      run: |
        echo "### ✅ 构建成功" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "- **版本**: ${{ steps.get_version.outputs.version }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **平台**: Windows x64" >> $env:GITHUB_STEP_SUMMARY
        echo "- **包名**: ${{ steps.create_package.outputs.zip_name }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **.NET**: ${{ env.DOTNET_VERSION }}" >> $env:GITHUB_STEP_SUMMARY

