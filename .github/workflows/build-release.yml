name: C#/WPFæž„å»ºå’Œå‘å¸ƒ

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_NAME: ImageColorChanger
  OUTPUT_NAME: Canvas Cast
  DOTNET_VERSION: '8.0.x'

permissions:
  contents: write

jobs:
  build:
    name: ç¼–è¯‘å’Œæ‰“åŒ…
    runs-on: windows-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½® .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: è¿˜åŽŸä¾èµ–
      run: dotnet restore
    
    - name: ç¼–è¯‘é¡¹ç›®
      run: dotnet build ImageColorChanger.csproj --configuration Release --no-restore
    
    - name: å‘å¸ƒé¡¹ç›®
      run: dotnet publish ImageColorChanger.csproj -c Release -o publish --self-contained false
    
    - name: èŽ·å–ç‰ˆæœ¬å·
      id: get_version
      shell: pwsh
      run: |
        if ($env:GITHUB_REF -like 'refs/tags/v*') {
          $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        } else {
          # ä»ŽMainWindow.xamlçš„Titleå±žæ€§ä¸­è¯»å–ç‰ˆæœ¬å·
          $xamlFile = "UI\MainWindow.xaml"
          if (Test-Path $xamlFile) {
            $titleMatch = Select-String -Path $xamlFile -Pattern 'Title="[^"]*V(\d+\.\d+\.\d+)"' | ForEach-Object { $_.Matches[0].Groups[1].Value }
            if ($titleMatch) {
              $version = $titleMatch
              echo "ä»ŽMainWindow.xamlè¯»å–ç‰ˆæœ¬: $version"
            } else {
              # å¦‚æžœè¯»å–å¤±è´¥ï¼Œä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºåŽå¤‡
              $timestamp = Get-Date -Format 'yyyyMMdd-HHmmss'
              $version = "dev-$timestamp"
              echo "æ— æ³•ä»ŽMainWindow.xamlè¯»å–ç‰ˆæœ¬ï¼Œä½¿ç”¨æ—¶é—´æˆ³: $version"
            }
          } else {
            # å¦‚æžœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºåŽå¤‡
            $timestamp = Get-Date -Format 'yyyyMMdd-HHmmss'
            $version = "dev-$timestamp"
            echo "MainWindow.xamlæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨æ—¶é—´æˆ³: $version"
          }
        }
        
        # å¦‚æžœç‰ˆæœ¬å·å·²ç»æœ‰Vå‰ç¼€ï¼Œç›´æŽ¥ä½¿ç”¨ï¼›å¦åˆ™æ·»åŠ Vå‰ç¼€
        if ($version -like 'V*') {
          $tag = $version
        } else {
          $tag = "V$version"
        }
        
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "tag=$tag" >> $env:GITHUB_OUTPUT
        echo "æž„å»ºç‰ˆæœ¬: $version"
        echo "æ ‡ç­¾: $tag"
    
    - name: éªŒè¯æž„å»ºäº§ç‰©
      shell: pwsh
      run: |
        echo "=== éªŒè¯æž„å»ºäº§ç‰© ==="
        
        # æ£€æŸ¥ä¸»ç¨‹åº
        if (Test-Path "publish\Canvas Cast.exe") {
          echo "âœ… ä¸»ç¨‹åºéªŒè¯æˆåŠŸ"
          $exeInfo = Get-Item "publish\Canvas Cast.exe"
          echo "ä¸»ç¨‹åºå¤§å°: $([math]::Round($exeInfo.Length / 1MB, 2)) MB"
        } else {
          echo "âŒ æž„å»ºäº§ç‰©éªŒè¯å¤±è´¥ - Canvas Cast.exe ä¸å­˜åœ¨"
          echo "publishç›®å½•å†…å®¹:"
          Get-ChildItem "publish" -ErrorAction SilentlyContinue | ForEach-Object { echo "  - $($_.Name)" }
          exit 1
        }
        
        # æ£€æŸ¥å¹¶å¤„ç†PAKæ–‡ä»¶
        if (Test-Path "publish\Resources.pak") {
          echo "âœ… PAKæ–‡ä»¶å·²å­˜åœ¨äºŽpublishç›®å½•"
          $pakInfo = Get-Item "publish\Resources.pak"
          echo "PAKæ–‡ä»¶å¤§å°: $([math]::Round($pakInfo.Length / 1MB, 2)) MB"
        } else {
          echo "âš ï¸ PAKæ–‡ä»¶ä¸å­˜åœ¨äºŽpublishç›®å½•ï¼Œå°è¯•ä»Žbinç›®å½•å¤åˆ¶..."
          if (Test-Path "bin\Release\net8.0-windows\Resources.pak") {
            Copy-Item "bin\Release\net8.0-windows\Resources.pak" "publish\Resources.pak"
            echo "âœ… PAKæ–‡ä»¶å·²ä»Žbinç›®å½•å¤åˆ¶åˆ°publishæ ¹ç›®å½•"
            $pakInfo = Get-Item "publish\Resources.pak"
            echo "PAKæ–‡ä»¶å¤§å°: $([math]::Round($pakInfo.Length / 1MB, 2)) MB"
          } else {
            echo "âŒ é”™è¯¯: binç›®å½•ä¸­ä¹Ÿæ²¡æœ‰PAKæ–‡ä»¶"
            exit 1
          }
        }
        
        # åˆ é™¤publishç›®å½•ä¸­çš„binæ–‡ä»¶å¤¹ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
        if (Test-Path "publish\bin") {
          echo "âš ï¸ å‘çŽ°publish\binç›®å½•ï¼Œæ­£åœ¨åˆ é™¤..."
          Remove-Item "publish\bin" -Recurse -Force
          echo "âœ… å·²åˆ é™¤publish\binç›®å½•"
        }
        
        echo ""
        echo "=== publishç›®å½•æœ€ç»ˆå†…å®¹ ==="
        Get-ChildItem "publish" -Name | ForEach-Object { echo "  - $_" }
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.version }}"
        $tag = "${{ steps.get_version.outputs.tag }}"
        $zipName = "Canvas.zip"
        
        # åŽ‹ç¼©å‘å¸ƒæ–‡ä»¶
        Compress-Archive -Path publish\* -DestinationPath $zipName
        
        # éªŒè¯zipæ–‡ä»¶
        if (Test-Path $zipName) {
          $size = (Get-Item $zipName).Length / 1MB
          echo "âœ… å‘å¸ƒåŒ…åˆ›å»ºæˆåŠŸ"
          echo "åŒ…åç§°: $zipName"
          echo "åŒ…å¤§å°: $([math]::Round($size, 2)) MB"
          echo "ç‰ˆæœ¬å·: $tag"
        } else {
          echo "âŒ å‘å¸ƒåŒ…åˆ›å»ºå¤±è´¥"
          exit 1
        }
        
        # è¾“å‡ºæ–‡ä»¶åä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
        echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
      id: create_package
    
    - name: ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: Canvas-Cast-${{ steps.get_version.outputs.version }}
        path: ${{ steps.create_package.outputs.zip_name }}
        retention-days: 30
    
    - name: è°ƒè¯•Releaseä¿¡æ¯
      shell: pwsh
      run: |
        echo "=== Releaseè°ƒè¯•ä¿¡æ¯ ==="
        echo "ç‰ˆæœ¬å·: ${{ steps.get_version.outputs.version }}"
        echo "æ ‡ç­¾: ${{ steps.get_version.outputs.tag }}"
        echo "åŒ…æ–‡ä»¶: ${{ steps.create_package.outputs.zip_name }}"
        echo "åŒ…æ–‡ä»¶å­˜åœ¨: $(Test-Path '${{ steps.create_package.outputs.zip_name }}')"
        if (Test-Path '${{ steps.create_package.outputs.zip_name }}') {
          $size = (Get-Item '${{ steps.create_package.outputs.zip_name }}').Length / 1MB
          echo "åŒ…æ–‡ä»¶å¤§å°: $([math]::Round($size, 2)) MB"
        }
        echo "======================"
    
    - name: æ£€æŸ¥å¹¶åˆ é™¤å·²å­˜åœ¨çš„ Release
      shell: pwsh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $tag = "${{ steps.get_version.outputs.tag }}"
        echo "=== æ£€æŸ¥ Release æ˜¯å¦å­˜åœ¨ ==="
        echo "æ ‡ç­¾: $tag"
        
        # èŽ·å– Release ä¿¡æ¯
        $headers = @{
          "Authorization" = "Bearer $env:GITHUB_TOKEN"
          "Accept" = "application/vnd.github+json"
          "X-GitHub-Api-Version" = "2022-11-28"
        }
        
        $repo = "${{ github.repository }}"
        $releaseUrl = "https://api.github.com/repos/$repo/releases/tags/$tag"
        
        try {
          $response = Invoke-WebRequest -Uri $releaseUrl -Headers $headers -Method Get -ErrorAction Stop
          $releaseData = $response.Content | ConvertFrom-Json
          $releaseId = $releaseData.id
          
          echo "âš ï¸ å‘çŽ°å·²å­˜åœ¨çš„ Release (ID: $releaseId)ï¼Œæ­£åœ¨åˆ é™¤..."
          
          # åˆ é™¤ Release
          $deleteUrl = "https://api.github.com/repos/$repo/releases/$releaseId"
          Invoke-WebRequest -Uri $deleteUrl -Headers $headers -Method Delete -ErrorAction Stop | Out-Null
          echo "âœ… å·²åˆ é™¤æ—§çš„ Release"
          
          # ç­‰å¾…ä¸€ä¸‹ç¡®ä¿åˆ é™¤å®Œæˆ
          Start-Sleep -Seconds 2
        } catch {
          if ($_.Exception.Response.StatusCode -eq 404) {
            echo "âœ… Release ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤"
          } else {
            echo "âš ï¸ æ£€æŸ¥ Release æ—¶å‡ºé”™: $($_.Exception.Message)"
          }
        }
        
        # æ£€æŸ¥å¹¶åˆ é™¤ Tag
        $tagUrl = "https://api.github.com/repos/$repo/git/refs/tags/$tag"
        try {
          Invoke-WebRequest -Uri $tagUrl -Headers $headers -Method Get -ErrorAction Stop | Out-Null
          echo "âš ï¸ å‘çŽ°å·²å­˜åœ¨çš„ Tagï¼Œæ­£åœ¨åˆ é™¤..."
          
          Invoke-WebRequest -Uri $tagUrl -Headers $headers -Method Delete -ErrorAction Stop | Out-Null
          echo "âœ… å·²åˆ é™¤æ—§çš„ Tag"
          
          # ç­‰å¾…ä¸€ä¸‹ç¡®ä¿åˆ é™¤å®Œæˆ
          Start-Sleep -Seconds 2
        } catch {
          if ($_.Exception.Response.StatusCode -eq 404) {
            echo "âœ… Tag ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤"
          } else {
            echo "âš ï¸ æ£€æŸ¥ Tag æ—¶å‡ºé”™: $($_.Exception.Message)"
          }
        }
        
        echo "=== æ£€æŸ¥å®Œæˆï¼Œå‡†å¤‡åˆ›å»ºæ–°çš„ Release ==="
    
    - name: åˆ›å»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.create_package.outputs.zip_name }}
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: Canvas Cast ${{ steps.get_version.outputs.tag }}
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ðŸŽ‰ Canvas Cast ${{ steps.get_version.outputs.tag }}
          
          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          - ä¸‹è½½ `Canvas.zip` 
          - è§£åŽ‹åˆ°ä»»æ„ç›®å½•
          - è¿è¡Œ `Canvas Cast.exe`
          
          ### âš™ï¸ ç³»ç»Ÿè¦æ±‚
          - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
          - .NET 8.0 Runtime (å¦‚æœªå®‰è£…ä¼šè‡ªåŠ¨æç¤ºä¸‹è½½)
          
          ### ðŸ“ æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹ä¸‹æ–¹è‡ªåŠ¨ç”Ÿæˆçš„å˜æ›´è®°å½•
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: æž„å»ºæ‘˜è¦
      shell: pwsh
      run: |
        echo "### âœ… æž„å»ºæˆåŠŸ" >> $env:GITHUB_STEP_SUMMARY
        echo "" >> $env:GITHUB_STEP_SUMMARY
        echo "- **ç‰ˆæœ¬**: ${{ steps.get_version.outputs.version }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **å¹³å°**: Windows x64" >> $env:GITHUB_STEP_SUMMARY
        echo "- **åŒ…å**: ${{ steps.create_package.outputs.zip_name }}" >> $env:GITHUB_STEP_SUMMARY
        echo "- **.NET**: ${{ env.DOTNET_VERSION }}" >> $env:GITHUB_STEP_SUMMARY

