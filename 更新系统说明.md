# Canvas Cast 智能更新系统说明

## 📋 概述

Canvas Cast 采用了**智能、灵活、自动化**的更新系统，能够自动处理任何类型的文件更新，无需硬编码文件名。

---

## 🎯 核心特性

### ✅ 1. 智能文件发现
- **自动扫描**：自动发现更新目录中的所有文件（包括子目录）
- **无需配置**：不需要在代码中写死文件名
- **支持任意文件**：DLL、EXE、PAK、JSON、图片、字体等任何文件

### ✅ 2. 灵活的更新方式
支持三种更新文件提供方式：

#### 方式1：files.txt 文件列表（推荐）
在服务器上创建 `v{版本号}/files.txt`，列出需要更新的文件：

```
CanvasCast.dll
Resources.pak
config.json
Fonts/Chinese/SourceHanSans.ttf
```

#### 方式2：压缩包（自动解压）
上传压缩包，系统会自动解压并更新所有文件：
- `update.zip`
- `Canvas-Update.zip`
- `Canvas-Full.zip`

#### 方式3：直接上传文件
直接上传文件到版本目录，系统会自动发现：
- `CanvasCast.dll`
- `Resources.pak`
- 任何其他文件

### ✅ 3. 子目录支持
完整保留目录结构，例如：
```
更新包/
├── CanvasCast.dll
├── Resources.pak
├── Fonts/
│   └── Chinese/
│       └── SourceHanSans.ttf
└── Config/
    └── settings.json
```

更新后会自动创建对应的子目录并放置文件。

### ✅ 4. 安全机制
- **自动备份**：更新前自动备份所有文件（.bak）
- **失败回滚**：更新失败时自动恢复备份
- **原子操作**：要么全部成功，要么全部回滚
- **文件锁处理**：通过批处理脚本避免文件锁定问题

### ✅ 5. 自动重启
- **智能检测**：自动检测当前运行的程序路径
- **无需配置**：不管程序安装在哪里都能正确重启
- **静默执行**：整个过程无窗口，用户体验流畅

---

## 🔧 工作流程

### 1️⃣ 检查更新
```
程序启动 → 读取 latest.txt → 比较版本号 → 发现新版本
```

### 2️⃣ 获取文件列表
```
优先读取 files.txt → 如果不存在 → 自动发现常见文件
```

### 3️⃣ 下载文件
```
下载所有文件 → 显示进度 → 自动解压压缩包 → 保存到临时目录
```

### 4️⃣ 应用更新
```
扫描临时目录 → 生成批处理脚本 → 退出程序 → 脚本执行更新 → 重启程序
```

### 5️⃣ 批处理脚本执行
```
等待2秒 → 备份旧文件 → 复制新文件 → 清理备份 → 重启程序 → 自我删除
```

---

## 📝 服务器端配置

### 目录结构
```
https://canvas.019890311.xyz/
├── latest.txt              # 最新版本号（例如：5.3.1）
├── v5.3.0/
│   ├── files.txt          # 文件列表（可选）
│   ├── CanvasCast.dll
│   └── Resources.pak
└── v5.3.1/
    ├── files.txt          # 文件列表（可选）
    ├── update.zip         # 或者使用压缩包
    └── CanvasCast.dll     # 或者直接上传文件
```

### latest.txt 格式
```
5.3.1
```

### files.txt 格式（可选）
```
CanvasCast.dll
Resources.pak
Fonts/Chinese/SourceHanSans.ttf
Config/settings.json
```

**注意**：
- 每行一个文件名
- 支持相对路径（子目录）
- 文件名区分大小写

---

## 🎨 使用场景示例

### 场景1：仅更新主程序
**服务器端**：
```
v5.3.1/
└── CanvasCast.dll
```

**结果**：只更新 `CanvasCast.dll`

---

### 场景2：更新程序和资源
**服务器端**：
```
v5.3.1/
├── CanvasCast.dll
└── Resources.pak
```

**结果**：更新 `CanvasCast.dll` 和 `Resources.pak`

---

### 场景3：更新字体文件
**服务器端**：
```
v5.3.1/
├── files.txt
└── Fonts/
    └── Chinese/
        └── SourceHanSans.ttf
```

**files.txt**：
```
Fonts/Chinese/SourceHanSans.ttf
```

**结果**：更新 `Fonts/Chinese/SourceHanSans.ttf`，自动创建子目录

---

### 场景4：使用压缩包
**服务器端**：
```
v5.3.1/
└── update.zip
```

**update.zip 内容**：
```
CanvasCast.dll
Resources.pak
Fonts/Chinese/SourceHanSans.ttf
```

**结果**：自动解压并更新所有文件

---

## 🚀 优势对比

### ❌ 旧方案（硬编码）
```csharp
// 写死文件名
start "" "D:\App\CanvasCast\CanvasCast.exe"
```

**问题**：
- 只能更新固定的文件
- 添加新文件需要修改代码
- 不支持子目录
- 程序路径写死

### ✅ 新方案（智能）
```csharp
// 自动发现所有文件
var updateFiles = Directory.GetFiles(updateDir, "*.*", SearchOption.AllDirectories);

// 自动检测程序路径
var currentExePath = Process.GetCurrentProcess().MainModule?.FileName;
```

**优势**：
- 支持任意文件
- 无需修改代码
- 支持子目录结构
- 自动检测程序路径

---

## 🔍 调试信息

在 DEBUG 模式下，会输出详细的日志：

```
[UpdateService] 当前程序: D:\App\CanvasCast\CanvasCast.exe
[UpdateService] 发现 3 个更新文件:
  - CanvasCast.dll
  - Resources.pak
  - Fonts/Chinese/SourceHanSans.ttf
[UpdateService] 创建更新脚本: C:\Users\xxx\AppData\Local\Temp\update_canvas.bat
[UpdateService] 将更新 3 个文件
[UpdateService] 更新完成后将重启: D:\App\CanvasCast\CanvasCast.exe
```

---

## 📌 注意事项

1. **文件权限**：确保程序有权限写入安装目录
2. **杀毒软件**：批处理脚本可能被杀毒软件拦截，需要添加信任
3. **网络连接**：需要稳定的网络连接下载更新文件
4. **磁盘空间**：确保有足够的临时空间存储更新文件

---

## 🎯 最佳实践

### 推荐做法
1. 使用 `files.txt` 明确指定需要更新的文件
2. 大量文件时使用压缩包减少下载次数
3. 测试环境先验证更新流程
4. 保持版本号规范（x.y.z 格式）

### 不推荐做法
1. ❌ 不要在更新包中包含不必要的文件
2. ❌ 不要频繁发布小版本更新
3. ❌ 不要在更新过程中手动干预

---

## 🔧 故障排除

### 问题1：更新失败
**原因**：文件被占用或权限不足
**解决**：以管理员身份运行程序

### 问题2：下载失败
**原因**：网络问题或服务器文件不存在
**解决**：检查网络连接和服务器文件

### 问题3：重启失败
**原因**：程序路径检测失败
**解决**：检查 DEBUG 日志中的程序路径

---

## 📚 相关文件

- `Services/UpdateService.cs` - 更新服务核心逻辑
- `UI/UpdateWindow.xaml.cs` - 更新窗口界面
- `.github/workflows/build-release.yml` - 自动构建和发布

---

## 🎉 总结

新的智能更新系统具有以下特点：

✅ **灵活** - 支持任意文件和目录结构
✅ **安全** - 自动备份和回滚机制
✅ **智能** - 自动发现和处理文件
✅ **可靠** - 完善的错误处理
✅ **易用** - 无需配置，开箱即用

现在你可以随意更新任何文件，系统会自动处理一切！🚀

