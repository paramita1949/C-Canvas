# é¢œè‰²é€‰æ‹©å™¨å®ç°æŒ‡å—

> **åŠŸèƒ½**: å¸¸è§„é¢œè‰²é€‰æ‹© + è‡ªå®šä¹‰è‰²ç›˜  
> **æŠ€æœ¯æ ˆ**: WPF + SkiaSharp  
> **é›†æˆ**: å¤ç”¨ç°æœ‰ ConfigManager é¢œè‰²é¢„è®¾ç³»ç»Ÿ  
> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-02

---

## ğŸ“‹ ç›®å½•

1. [è®¾è®¡æ¦‚è§ˆ](#è®¾è®¡æ¦‚è§ˆ)
2. [ColorPickerDialog æ§ä»¶](#colorpickerdialog-æ§ä»¶)
3. [HSV è‰²ç›˜å®ç°](#hsv-è‰²ç›˜å®ç°)
4. [é›†æˆåˆ°æ–‡æœ¬ç¼–è¾‘å™¨](#é›†æˆåˆ°æ–‡æœ¬ç¼–è¾‘å™¨)
5. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)

---

## ğŸ¨ è®¾è®¡æ¦‚è§ˆ

### UI å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¢œè‰²é€‰æ‹©å™¨                                    [X]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å¸¸è§„é¢œè‰²        â”‚  â”‚  è‡ªå®šä¹‰è‰²ç›˜              â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚                         â”‚ â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â”‚  â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â”‚  â”‚      â”‚ HSV è‰²ç›˜ â”‚        â”‚ â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â”‚  â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â”‚  â”‚                         â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚  R: [â”â”â”â”â”â”â”â”] 255     â”‚ â”‚
â”‚  â”‚ [+ æ·»åŠ è‡ªå®šä¹‰]   â”‚  â”‚  G: [â”â”â”â”â”â”â”â”] 255     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  B: [â”â”â”â”â”â”â”â”] 255     â”‚ â”‚
â”‚                       â”‚                         â”‚ â”‚
â”‚                       â”‚  é¢„è§ˆ: â–ˆâ–ˆâ–ˆâ–ˆ             â”‚ â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                     â”‚
â”‚  å½“å‰é¢œè‰²: â–ˆâ–ˆâ–ˆâ–ˆ  #3498DB                            â”‚
â”‚                                                     â”‚
â”‚                    [ç¡®å®š]  [å–æ¶ˆ]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åŠŸèƒ½ç‰¹æ€§

âœ… **å¸¸è§„é¢œè‰²é¢æ¿**
- æ˜¾ç¤ºå†…ç½®é¢œè‰²é¢„è®¾ï¼ˆæ¥è‡ª ConfigManagerï¼‰
- æ˜¾ç¤ºç”¨æˆ·è‡ªå®šä¹‰é¢œè‰²é¢„è®¾
- æ”¯æŒæ·»åŠ æ–°çš„è‡ªå®šä¹‰é¢œè‰²
- æ”¯æŒåˆ é™¤è‡ªå®šä¹‰é¢œè‰²ï¼ˆå†…ç½®é¢œè‰²ä¸å¯åˆ é™¤ï¼‰

âœ… **è‡ªå®šä¹‰è‰²ç›˜**
- HSV è‰²ç›˜ï¼ˆè‰²ç›¸ + é¥±å’Œåº¦/æ˜åº¦ï¼‰
- RGB æ»‘å—ç²¾ç¡®è°ƒæ•´
- åå…­è¿›åˆ¶é¢œè‰²ç è¾“å…¥
- å®æ—¶é¢„è§ˆ

---

## ğŸ›ï¸ ColorPickerDialog æ§ä»¶

### 1. ColorPickerDialog.xaml

```xml
<Window x:Class="ImageColorChanger.UI.Controls.ColorPickerDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:ImageColorChanger.UI.Controls"
        Title="é¢œè‰²é€‰æ‹©å™¨" 
        Width="700" Height="500"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="#2C3E50">
    
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- ========== å·¦ä¾§ï¼šå¸¸è§„é¢œè‰²é¢æ¿ ========== -->
            <Border Grid.Column="0" Background="#34495E" CornerRadius="5" Padding="15">
                <StackPanel>
                    <TextBlock Text="å¸¸è§„é¢œè‰²" FontSize="14" FontWeight="Bold" 
                               Foreground="White" Margin="0,0,0,10"/>
                    
                    <!-- å†…ç½®é¢œè‰² -->
                    <TextBlock Text="å†…ç½®é¢œè‰²" FontSize="12" Foreground="#BDC3C7" Margin="0,0,0,5"/>
                    <ItemsControl x:Name="BuiltInColorsPanel" Margin="0,0,0,15">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Width="35" Height="35" Margin="2" 
                                        Click="OnPresetColorClicked"
                                        Tag="{Binding}"
                                        ToolTip="{Binding Name}"
                                        BorderThickness="2"
                                        BorderBrush="Transparent">
                                    <Button.Background>
                                        <SolidColorBrush Color="{Binding Color}"/>
                                    </Button.Background>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- è‡ªå®šä¹‰é¢œè‰² -->
                    <TextBlock Text="è‡ªå®šä¹‰é¢œè‰²" FontSize="12" Foreground="#BDC3C7" Margin="0,0,0,5"/>
                    <ItemsControl x:Name="CustomColorsPanel" Margin="0,0,0,10">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel Orientation="Horizontal"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid Width="35" Height="35" Margin="2">
                                    <Button Click="OnPresetColorClicked"
                                            Tag="{Binding}"
                                            ToolTip="{Binding Name}"
                                            BorderThickness="2"
                                            BorderBrush="Transparent">
                                        <Button.Background>
                                            <SolidColorBrush Color="{Binding Color}"/>
                                        </Button.Background>
                                    </Button>
                                    <!-- åˆ é™¤æŒ‰é’® -->
                                    <Button Width="16" Height="16" 
                                            HorizontalAlignment="Right" 
                                            VerticalAlignment="Top"
                                            Margin="-5,-5,0,0"
                                            Background="#E74C3C"
                                            Foreground="White"
                                            Content="Ã—"
                                            FontSize="10"
                                            Padding="0"
                                            Click="OnDeleteCustomColorClicked"
                                            Tag="{Binding}"
                                            ToolTip="åˆ é™¤"/>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                    
                    <!-- æ·»åŠ è‡ªå®šä¹‰é¢œè‰²æŒ‰é’® -->
                    <Button Content="+ æ·»åŠ å½“å‰é¢œè‰²" 
                            Height="30" 
                            Background="#27AE60" 
                            Foreground="White"
                            BorderThickness="0"
                            Click="OnAddCustomColorClicked"/>
                </StackPanel>
            </Border>
            
            <!-- ========== å³ä¾§ï¼šè‡ªå®šä¹‰è‰²ç›˜ ========== -->
            <Border Grid.Column="1" Background="#34495E" CornerRadius="5" Padding="15" Margin="10,0,0,0">
                <StackPanel>
                    <TextBlock Text="è‡ªå®šä¹‰è‰²ç›˜" FontSize="14" FontWeight="Bold" 
                               Foreground="White" Margin="0,0,0,10"/>
                    
                    <!-- HSV è‰²ç›˜ -->
                    <Border Width="250" Height="250" 
                            BorderBrush="#7F8C8D" BorderThickness="1"
                            Margin="0,0,0,15">
                        <local:HSVColorPicker x:Name="HsvColorPicker"
                                              ColorChanged="OnHsvColorChanged"/>
                    </Border>
                    
                    <!-- RGB æ»‘å— -->
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="20"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="50"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="30"/>
                            <RowDefinition Height="30"/>
                            <RowDefinition Height="30"/>
                        </Grid.RowDefinitions>
                        
                        <!-- R -->
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="R" Foreground="White" VerticalAlignment="Center"/>
                        <Slider Grid.Row="0" Grid.Column="1" x:Name="RedSlider" 
                                Minimum="0" Maximum="255" 
                                ValueChanged="OnRgbSliderChanged"
                                Margin="5,0"/>
                        <TextBox Grid.Row="0" Grid.Column="2" 
                                 Text="{Binding Value, ElementName=RedSlider, Mode=TwoWay, StringFormat={}{0:F0}}"
                                 VerticalContentAlignment="Center"
                                 TextAlignment="Center"/>
                        
                        <!-- G -->
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="G" Foreground="White" VerticalAlignment="Center"/>
                        <Slider Grid.Row="1" Grid.Column="1" x:Name="GreenSlider" 
                                Minimum="0" Maximum="255" 
                                ValueChanged="OnRgbSliderChanged"
                                Margin="5,0"/>
                        <TextBox Grid.Row="1" Grid.Column="2" 
                                 Text="{Binding Value, ElementName=GreenSlider, Mode=TwoWay, StringFormat={}{0:F0}}"
                                 VerticalContentAlignment="Center"
                                 TextAlignment="Center"/>
                        
                        <!-- B -->
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="B" Foreground="White" VerticalAlignment="Center"/>
                        <Slider Grid.Row="2" Grid.Column="1" x:Name="BlueSlider" 
                                Minimum="0" Maximum="255" 
                                ValueChanged="OnRgbSliderChanged"
                                Margin="5,0"/>
                        <TextBox Grid.Row="2" Grid.Column="2" 
                                 Text="{Binding Value, ElementName=BlueSlider, Mode=TwoWay, StringFormat={}{0:F0}}"
                                 VerticalContentAlignment="Center"
                                 TextAlignment="Center"/>
                    </Grid>
                    
                    <!-- åå…­è¿›åˆ¶è¾“å…¥ -->
                    <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                        <TextBlock Text="HEX:" Foreground="White" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <TextBox x:Name="HexTextBox" Width="100" 
                                 TextChanged="OnHexTextChanged"
                                 VerticalContentAlignment="Center"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Grid>
        
        <!-- ========== å½“å‰é¢œè‰²é¢„è§ˆ ========== -->
        <Border Grid.Row="1" Background="#34495E" CornerRadius="5" 
                Padding="15" Margin="0,10,0,0">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="å½“å‰é¢œè‰²:" Foreground="White" VerticalAlignment="Center" Margin="0,0,10,0"/>
                <Border Width="50" Height="30" 
                        BorderBrush="#7F8C8D" BorderThickness="1"
                        x:Name="CurrentColorPreview"/>
                <TextBlock x:Name="CurrentColorText" 
                           Foreground="White" 
                           VerticalAlignment="Center" 
                           Margin="10,0,0,0"/>
            </StackPanel>
        </Border>
        
        <!-- ========== æŒ‰é’® ========== -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" 
                    HorizontalAlignment="Right" Margin="0,15,0,0">
            <Button Content="ç¡®å®š" Width="100" Height="35" 
                    Background="#27AE60" Foreground="White" 
                    BorderThickness="0" Click="OnOkClicked"/>
            <Button Content="å–æ¶ˆ" Width="100" Height="35" 
                    Background="#95A5A6" Foreground="White" 
                    BorderThickness="0" Margin="10,0,0,0" 
                    Click="OnCancelClicked"/>
        </StackPanel>
    </Grid>
</Window>
```

---

## ğŸ¨ HSV è‰²ç›˜å®ç°

### 2. HSVColorPicker.csï¼ˆè‡ªå®šä¹‰æ§ä»¶ï¼‰

```csharp
using SkiaSharp;
using SkiaSharp.Views.Desktop;
using SkiaSharp.Views.WPF;
using System;
using System.Windows;
using System.Windows.Input;

namespace ImageColorChanger.UI.Controls
{
    /// <summary>
    /// HSV è‰²ç›˜æ§ä»¶
    /// æ”¯æŒè‰²ç›¸ç¯ + é¥±å’Œåº¦/æ˜åº¦é€‰æ‹©
    /// </summary>
    public class HSVColorPicker : SKElement
    {
        private float _hue = 0;           // è‰²ç›¸ (0-360)
        private float _saturation = 1;    // é¥±å’Œåº¦ (0-1)
        private float _value = 1;         // æ˜åº¦ (0-1)
        
        private bool _isDragging = false;
        private bool _isDraggingHue = false;
        
        public event EventHandler<ColorChangedEventArgs> ColorChanged;
        
        public HSVColorPicker()
        {
            PaintSurface += OnPaintSurface;
            MouseLeftButtonDown += OnMouseDown;
            MouseMove += OnMouseMove;
            MouseLeftButtonUp += OnMouseUp;
        }
        
        // ========== å±æ€§ ==========
        
        public SKColor SelectedColor
        {
            get => HSVToRGB(_hue, _saturation, _value);
            set
            {
                RGBToHSV(value, out _hue, out _saturation, out _value);
                InvalidateVisual();
            }
        }
        
        // ========== æ¸²æŸ“ ==========
        
        private void OnPaintSurface(object sender, SKPaintSurfaceEventArgs e)
        {
            var canvas = e.Surface.Canvas;
            canvas.Clear(SKColors.Transparent);
            
            float width = (float)ActualWidth;
            float height = (float)ActualHeight;
            float centerX = width / 2;
            float centerY = height / 2;
            float radius = Math.Min(width, height) / 2 - 20;
            
            // 1. ç»˜åˆ¶è‰²ç›¸ç¯
            DrawHueRing(canvas, centerX, centerY, radius);
            
            // 2. ç»˜åˆ¶é¥±å’Œåº¦/æ˜åº¦æ–¹å—
            DrawSaturationValueSquare(canvas, centerX, centerY, radius * 0.7f);
            
            // 3. ç»˜åˆ¶é€‰æ‹©æŒ‡ç¤ºå™¨
            DrawSelectionIndicators(canvas, centerX, centerY, radius);
        }
        
        /// <summary>
        /// ç»˜åˆ¶è‰²ç›¸ç¯
        /// </summary>
        private void DrawHueRing(SKCanvas canvas, float cx, float cy, float radius)
        {
            using var paint = new SKPaint
            {
                IsAntialias = true,
                Style = SKPaintStyle.Stroke,
                StrokeWidth = 20
            };
            
            // ç»˜åˆ¶ 360 åº¦è‰²ç›¸ç¯
            for (int i = 0; i < 360; i++)
            {
                paint.Color = HSVToRGB(i, 1, 1);
                
                float startAngle = i - 90;  // ä»é¡¶éƒ¨å¼€å§‹
                canvas.DrawArc(
                    new SKRect(cx - radius, cy - radius, cx + radius, cy + radius),
                    startAngle, 1, false, paint);
            }
        }
        
        /// <summary>
        /// ç»˜åˆ¶é¥±å’Œåº¦/æ˜åº¦æ–¹å—
        /// </summary>
        private void DrawSaturationValueSquare(SKCanvas canvas, float cx, float cy, float size)
        {
            float left = cx - size / 2;
            float top = cy - size / 2;
            
            // åˆ›å»ºæ¸å˜ä½å›¾
            using var bitmap = new SKBitmap((int)size, (int)size);
            
            for (int y = 0; y < size; y++)
            {
                for (int x = 0; x < size; x++)
                {
                    float s = x / size;  // é¥±å’Œåº¦ï¼šå·¦åˆ°å³ (0-1)
                    float v = 1 - (y / size);  // æ˜åº¦ï¼šä¸Šåˆ°ä¸‹ (1-0)
                    
                    var color = HSVToRGB(_hue, s, v);
                    bitmap.SetPixel(x, y, color);
                }
            }
            
            canvas.DrawBitmap(bitmap, left, top);
            
            // ç»˜åˆ¶è¾¹æ¡†
            using var borderPaint = new SKPaint
            {
                Color = SKColors.White,
                Style = SKPaintStyle.Stroke,
                StrokeWidth = 2,
                IsAntialias = true
            };
            canvas.DrawRect(left, top, size, size, borderPaint);
        }
        
        /// <summary>
        /// ç»˜åˆ¶é€‰æ‹©æŒ‡ç¤ºå™¨
        /// </summary>
        private void DrawSelectionIndicators(SKCanvas canvas, float cx, float cy, float radius)
        {
            // 1. è‰²ç›¸ç¯æŒ‡ç¤ºå™¨
            float hueAngle = (_hue - 90) * (float)Math.PI / 180;
            float hueX = cx + radius * (float)Math.Cos(hueAngle);
            float hueY = cy + radius * (float)Math.Sin(hueAngle);
            
            using var huePaint = new SKPaint
            {
                Color = SKColors.White,
                Style = SKPaintStyle.Stroke,
                StrokeWidth = 3,
                IsAntialias = true
            };
            canvas.DrawCircle(hueX, hueY, 8, huePaint);
            
            // 2. é¥±å’Œåº¦/æ˜åº¦æŒ‡ç¤ºå™¨
            float squareSize = radius * 0.7f;
            float svX = cx - squareSize / 2 + _saturation * squareSize;
            float svY = cy - squareSize / 2 + (1 - _value) * squareSize;
            
            using var svPaint = new SKPaint
            {
                Color = SKColors.White,
                Style = SKPaintStyle.Stroke,
                StrokeWidth = 2,
                IsAntialias = true
            };
            canvas.DrawCircle(svX, svY, 6, svPaint);
            
            using var svFillPaint = new SKPaint
            {
                Color = SelectedColor,
                Style = SKPaintStyle.Fill,
                IsAntialias = true
            };
            canvas.DrawCircle(svX, svY, 4, svFillPaint);
        }
        
        // ========== äº¤äº’ ==========
        
        private void OnMouseDown(object sender, MouseButtonEventArgs e)
        {
            var pos = e.GetPosition(this);
            float width = (float)ActualWidth;
            float height = (float)ActualHeight;
            float centerX = width / 2;
            float centerY = height / 2;
            float radius = Math.Min(width, height) / 2 - 20;
            
            float dx = (float)pos.X - centerX;
            float dy = (float)pos.Y - centerY;
            float distance = (float)Math.Sqrt(dx * dx + dy * dy);
            
            // åˆ¤æ–­ç‚¹å‡»ä½ç½®
            if (distance > radius * 0.7f && distance < radius + 10)
            {
                // ç‚¹å‡»è‰²ç›¸ç¯
                _isDraggingHue = true;
                UpdateHue(pos, centerX, centerY);
            }
            else if (Math.Abs(dx) < radius * 0.7f / 2 && Math.Abs(dy) < radius * 0.7f / 2)
            {
                // ç‚¹å‡»é¥±å’Œåº¦/æ˜åº¦æ–¹å—
                _isDragging = true;
                UpdateSaturationValue(pos, centerX, centerY, radius * 0.7f);
            }
            
            CaptureMouse();
        }
        
        private void OnMouseMove(object sender, MouseEventArgs e)
        {
            if (!_isDragging && !_isDraggingHue)
                return;
            
            var pos = e.GetPosition(this);
            float width = (float)ActualWidth;
            float height = (float)ActualHeight;
            float centerX = width / 2;
            float centerY = height / 2;
            float radius = Math.Min(width, height) / 2 - 20;
            
            if (_isDraggingHue)
            {
                UpdateHue(pos, centerX, centerY);
            }
            else if (_isDragging)
            {
                UpdateSaturationValue(pos, centerX, centerY, radius * 0.7f);
            }
        }
        
        private void OnMouseUp(object sender, MouseButtonEventArgs e)
        {
            _isDragging = false;
            _isDraggingHue = false;
            ReleaseMouseCapture();
        }
        
        private void UpdateHue(Point pos, float cx, float cy)
        {
            float dx = (float)pos.X - cx;
            float dy = (float)pos.Y - cy;
            float angle = (float)Math.Atan2(dy, dx) * 180 / (float)Math.PI;
            _hue = (angle + 90 + 360) % 360;
            
            InvalidateVisual();
            OnColorChanged();
        }
        
        private void UpdateSaturationValue(Point pos, float cx, float cy, float size)
        {
            float left = cx - size / 2;
            float top = cy - size / 2;
            
            float x = Math.Clamp((float)pos.X - left, 0, size);
            float y = Math.Clamp((float)pos.Y - top, 0, size);
            
            _saturation = x / size;
            _value = 1 - (y / size);
            
            InvalidateVisual();
            OnColorChanged();
        }
        
        private void OnColorChanged()
        {
            ColorChanged?.Invoke(this, new ColorChangedEventArgs(SelectedColor));
        }
        
        // ========== HSV <-> RGB è½¬æ¢ ==========
        
        private SKColor HSVToRGB(float h, float s, float v)
        {
            int hi = (int)(h / 60) % 6;
            float f = h / 60 - hi;
            
            float p = v * (1 - s);
            float q = v * (1 - f * s);
            float t = v * (1 - (1 - f) * s);
            
            float r, g, b;
            switch (hi)
            {
                case 0: r = v; g = t; b = p; break;
                case 1: r = q; g = v; b = p; break;
                case 2: r = p; g = v; b = t; break;
                case 3: r = p; g = q; b = v; break;
                case 4: r = t; g = p; b = v; break;
                default: r = v; g = p; b = q; break;
            }
            
            return new SKColor(
                (byte)(r * 255),
                (byte)(g * 255),
                (byte)(b * 255));
        }
        
        private void RGBToHSV(SKColor color, out float h, out float s, out float v)
        {
            float r = color.Red / 255f;
            float g = color.Green / 255f;
            float b = color.Blue / 255f;
            
            float max = Math.Max(r, Math.Max(g, b));
            float min = Math.Min(r, Math.Min(g, b));
            float delta = max - min;
            
            // è‰²ç›¸
            if (delta == 0)
                h = 0;
            else if (max == r)
                h = 60 * (((g - b) / delta) % 6);
            else if (max == g)
                h = 60 * (((b - r) / delta) + 2);
            else
                h = 60 * (((r - g) / delta) + 4);
            
            if (h < 0) h += 360;
            
            // é¥±å’Œåº¦
            s = max == 0 ? 0 : delta / max;
            
            // æ˜åº¦
            v = max;
        }
    }
    
    public class ColorChangedEventArgs : EventArgs
    {
        public SKColor Color { get; }
        
        public ColorChangedEventArgs(SKColor color)
        {
            Color = color;
        }
    }
}
```

---

## ğŸ’» ColorPickerDialog.xaml.csï¼ˆåç«¯ä»£ç ï¼‰

### 3. å¯¹è¯æ¡†é€»è¾‘å®ç°

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using SkiaSharp;
using ImageColorChanger.Core;

namespace ImageColorChanger.UI.Controls
{
    public partial class ColorPickerDialog : Window
    {
        private ConfigManager _configManager;
        private SKColor _selectedColor;
        private bool _isUpdatingFromCode = false;
        
        public SKColor SelectedColor
        {
            get => _selectedColor;
            set
            {
                _selectedColor = value;
                UpdateUI();
            }
        }
        
        public ColorPickerDialog(ConfigManager configManager, SKColor initialColor)
        {
            InitializeComponent();
            
            _configManager = configManager;
            _selectedColor = initialColor;
            
            LoadPresetColors();
            UpdateUI();
        }
        
        // ========== åŠ è½½é¢„è®¾é¢œè‰² ==========
        
        private void LoadPresetColors()
        {
            var allPresets = _configManager.GetAllColorPresets();
            
            // å†…ç½®é¢œè‰²
            var builtInColors = allPresets.Where(p => p.IsBuiltIn).Select(p => new ColorItem
            {
                Name = p.Name,
                Color = Color.FromRgb(p.R, p.G, p.B)
            }).ToList();
            
            BuiltInColorsPanel.ItemsSource = builtInColors;
            
            // è‡ªå®šä¹‰é¢œè‰²
            var customColors = allPresets.Where(p => !p.IsBuiltIn).Select(p => new ColorItem
            {
                Name = p.Name,
                Color = Color.FromRgb(p.R, p.G, p.B),
                Preset = p
            }).ToList();
            
            CustomColorsPanel.ItemsSource = customColors;
        }
        
        // ========== UI æ›´æ–° ==========
        
        private void UpdateUI()
        {
            _isUpdatingFromCode = true;
            
            // æ›´æ–° HSV è‰²ç›˜
            HsvColorPicker.SelectedColor = _selectedColor;
            
            // æ›´æ–° RGB æ»‘å—
            RedSlider.Value = _selectedColor.Red;
            GreenSlider.Value = _selectedColor.Green;
            BlueSlider.Value = _selectedColor.Blue;
            
            // æ›´æ–°åå…­è¿›åˆ¶è¾“å…¥
            HexTextBox.Text = $"#{_selectedColor.Red:X2}{_selectedColor.Green:X2}{_selectedColor.Blue:X2}";
            
            // æ›´æ–°é¢„è§ˆ
            CurrentColorPreview.Background = new SolidColorBrush(
                Color.FromRgb(_selectedColor.Red, _selectedColor.Green, _selectedColor.Blue));
            CurrentColorText.Text = HexTextBox.Text;
            
            _isUpdatingFromCode = false;
        }
        
        // ========== äº‹ä»¶å¤„ç† ==========
        
        private void OnHsvColorChanged(object sender, ColorChangedEventArgs e)
        {
            if (_isUpdatingFromCode) return;
            _selectedColor = e.Color;
            UpdateUI();
        }
        
        private void OnRgbSliderChanged(object sender, RoutedPropertyChangedEventArgs<double> e)
        {
            if (_isUpdatingFromCode) return;
            
            _selectedColor = new SKColor(
                (byte)RedSlider.Value,
                (byte)GreenSlider.Value,
                (byte)BlueSlider.Value);
            
            UpdateUI();
        }
        
        private void OnHexTextChanged(object sender, TextChangedEventArgs e)
        {
            if (_isUpdatingFromCode) return;
            
            string hex = HexTextBox.Text.Trim();
            if (hex.StartsWith("#"))
                hex = hex.Substring(1);
            
            if (hex.Length == 6 && int.TryParse(hex, System.Globalization.NumberStyles.HexNumber, null, out int colorValue))
            {
                _selectedColor = new SKColor(
                    (byte)((colorValue >> 16) & 0xFF),
                    (byte)((colorValue >> 8) & 0xFF),
                    (byte)(colorValue & 0xFF));
                
                UpdateUI();
            }
        }
        
        private void OnPresetColorClicked(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            var colorItem = button.Tag as ColorItem;
            
            _selectedColor = new SKColor(
                colorItem.Color.R,
                colorItem.Color.G,
                colorItem.Color.B);
            
            UpdateUI();
        }
        
        private void OnAddCustomColorClicked(object sender, RoutedEventArgs e)
        {
            // å¼¹å‡ºè¾“å…¥å¯¹è¯æ¡†
            var inputDialog = new InputDialog("ä¿å­˜é¢œè‰²é¢„è®¾", "è¯·è¾“å…¥é¢„è®¾åç§°:");
            if (inputDialog.ShowDialog() == true)
            {
                string name = inputDialog.InputText;
                bool success = _configManager.AddCustomColorPreset(
                    name,
                    _selectedColor.Red,
                    _selectedColor.Green,
                    _selectedColor.Blue);
                
                if (success)
                {
                    LoadPresetColors();
                    MessageBox.Show($"é¢œè‰²é¢„è®¾ '{name}' å·²ä¿å­˜ï¼", "æˆåŠŸ", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                else
                {
                    MessageBox.Show("è¯¥é¢œè‰²é¢„è®¾å·²å­˜åœ¨ï¼", "æç¤º", MessageBoxButton.OK, MessageBoxImage.Warning);
                }
            }
        }
        
        private void OnDeleteCustomColorClicked(object sender, RoutedEventArgs e)
        {
            var button = sender as Button;
            var colorItem = button.Tag as ColorItem;
            
            var result = MessageBox.Show(
                $"ç¡®å®šè¦åˆ é™¤é¢œè‰²é¢„è®¾ '{colorItem.Name}' å—ï¼Ÿ",
                "ç¡®è®¤åˆ é™¤",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);
            
            if (result == MessageBoxResult.Yes)
            {
                _configManager.RemoveCustomColorPreset(colorItem.Name);
                LoadPresetColors();
            }
        }
        
        private void OnOkClicked(object sender, RoutedEventArgs e)
        {
            DialogResult = true;
            Close();
        }
        
        private void OnCancelClicked(object sender, RoutedEventArgs e)
        {
            DialogResult = false;
            Close();
        }
    }
    
    // ========== è¾…åŠ©ç±» ==========
    
    public class ColorItem
    {
        public string Name { get; set; }
        public Color Color { get; set; }
        public ColorPreset Preset { get; set; }
    }
}
```

---

## ğŸ”Œ é›†æˆåˆ°æ–‡æœ¬ç¼–è¾‘å™¨

### 4. ä½¿ç”¨ç¤ºä¾‹

```csharp
// åœ¨ TextPropertyPanel.xaml.cs ä¸­

private void OnTextColorClicked(object sender, RoutedEventArgs e)
{
    var currentColor = _textProperties.TextColor;
    
    var dialog = new ColorPickerDialog(_configManager, currentColor)
    {
        Owner = Window.GetWindow(this)
    };
    
    if (dialog.ShowDialog() == true)
    {
        _textProperties.TextColor = dialog.SelectedColor;
    }
}

private void OnBackgroundColorClicked(object sender, RoutedEventArgs e)
{
    var currentColor = _textProperties.BackgroundColor;
    
    var dialog = new ColorPickerDialog(_configManager, currentColor)
    {
        Owner = Window.GetWindow(this)
    };
    
    if (dialog.ShowDialog() == true)
    {
        _textProperties.BackgroundColor = dialog.SelectedColor;
    }
}

private void OnBorderColorClicked(object sender, RoutedEventArgs e)
{
    var currentColor = _textProperties.BorderColor;
    
    var dialog = new ColorPickerDialog(_configManager, currentColor)
    {
        Owner = Window.GetWindow(this)
    };
    
    if (dialog.ShowDialog() == true)
    {
        _textProperties.BorderColor = dialog.SelectedColor;
    }
}
```

---

## âœ… åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ğŸ¯ å¸¸è§„é¢œè‰²é¢æ¿ | âœ… | æ˜¾ç¤ºå†…ç½®å’Œè‡ªå®šä¹‰é¢œè‰²é¢„è®¾ |
| ğŸ¯ HSV è‰²ç›˜ | âœ… | è‰²ç›¸ç¯ + é¥±å’Œåº¦/æ˜åº¦æ–¹å— |
| ğŸ¯ RGB æ»‘å— | âœ… | ç²¾ç¡®è°ƒæ•´ RGB å€¼ |
| ğŸ¯ åå…­è¿›åˆ¶è¾“å…¥ | âœ… | æ”¯æŒ #RRGGBB æ ¼å¼ |
| ğŸ¯ å®æ—¶é¢„è§ˆ | âœ… | æ˜¾ç¤ºå½“å‰é€‰ä¸­é¢œè‰² |
| ğŸ¯ æ·»åŠ è‡ªå®šä¹‰é¢œè‰² | âœ… | ä¿å­˜åˆ° ConfigManager |
| ğŸ¯ åˆ é™¤è‡ªå®šä¹‰é¢œè‰² | âœ… | å†…ç½®é¢œè‰²ä¸å¯åˆ é™¤ |
| ğŸ¯ é›†æˆåˆ°æ–‡æœ¬ç¼–è¾‘å™¨ | âœ… | æ–‡å­—ã€èƒŒæ™¯ã€è¾¹æ¡†é¢œè‰²é€‰æ‹© |

---

**æ–‡æ¡£ç»´æŠ¤è€…**: Canvas Cast Team  
**æœ€åæ›´æ–°**: 2025-11-02

