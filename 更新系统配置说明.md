# Canvas Cast 更新系统配置说明

## 📋 概述

更新系统现在支持：
- ✅ 多文件更新（同时更新 `Canvas.Cast.dll` 和 `Resources.pak` 等）
- ✅ 压缩包支持（自动解压 `.zip`、`.7z`、`.rar` 格式）
- ✅ 灵活配置（支持 `files.txt` 或默认列表）

## 🗂️ 服务器目录结构

### 方式一：使用 files.txt（推荐）

```
https://canvas.019890311.xyz/
├── latest.txt          ← 内容: 5.4.0
├── v5.2.9/
│   ├── files.txt       ← 列出需要更新的文件
│   ├── Canvas.Cast.dll
│   └── Resources.pak
├── v5.3.0/
│   ├── files.txt
│   ├── Canvas.Cast.dll
│   └── Resources.pak
└── v5.4.0/
    ├── files.txt
    ├── Canvas.Cast.dll
    └── Resources.pak
```

**files.txt 内容示例：**
```
Canvas.Cast.dll
Resources.pak
```

### 方式二：使用默认文件列表

如果服务器上没有 `files.txt`，系统会自动尝试下载以下默认文件：
- `Canvas.Cast.dll`
- `Resources.pak`

## 📝 配置步骤

### 1. 创建版本目录

在服务器上创建新版本目录，例如 `v5.4.0/`

### 2. 上传更新文件

将需要更新的文件上传到版本目录：
- `Canvas.Cast.dll` - 主程序 DLL
- `Resources.pak` - 资源文件（如果有更新）

### 3. 创建 files.txt（可选但推荐）

在版本目录中创建 `files.txt`，列出本次更新包含的文件：

```txt
Canvas.Cast.dll
Resources.pak
```

**注意：**
- 每行一个文件名
- 不需要路径，只需要文件名
- 如果某个版本只更新 DLL，可以只写一行：
  ```txt
  Canvas.Cast.dll
  ```

### 4. 更新 latest.txt

修改根目录的 `latest.txt`，写入最新版本号：

```txt
5.4.0
```

## 🔄 更新流程

1. **检查更新**
   - 客户端读取 `latest.txt` 获取最新版本号
   - 与当前版本比较

2. **获取文件列表**
   - 尝试读取 `v{version}/files.txt`
   - 如果不存在，使用默认列表

3. **下载文件**
   - 下载所有列表中的文件到临时目录
   - 显示总体下载进度

4. **应用更新**
   - 备份旧文件（.bak）
   - 复制新文件到程序目录
   - 如果失败，自动恢复备份
   - 重启程序

## 💡 使用建议

### 只更新 DLL

如果某个版本只需要更新 DLL，`files.txt` 可以这样写：

```txt
Canvas.Cast.dll
```

### 同时更新多个文件

如果需要更新多个文件：

```txt
Canvas.Cast.dll
Resources.pak
config.json
```

### 不创建 files.txt

如果不创建 `files.txt`，系统会自动尝试下载：
- `Canvas.Cast.dll`
- `Resources.pak`

如果服务器上没有某个文件，下载会失败。

## 🔍 版本号比较规则

系统会智能比较版本号：
- `5.4.0 > 5.3.0 > 5.2.9`
- `5.4 = 5.4.0`（自动补零）
- 逐段比较：主版本号 → 次版本号 → 修订号

## 🐛 调试信息

在 DEBUG 模式下，系统会输出详细日志：
- 检查更新的 URL
- 发现的版本号
- 下载的文件列表
- 下载进度
- 更新脚本内容

## ⚠️ 注意事项

1. **文件名必须准确**
   - `Canvas.Cast.dll`（注意空格和大小写）
   - `Resources.pak`

2. **编码问题**
   - `files.txt` 使用 UTF-8 编码
   - 每行一个文件名，使用 `\n` 或 `\r\n` 换行

3. **权限问题**
   - 如果更新失败，可能需要管理员权限
   - 更新脚本会自动备份和恢复

4. **网络问题**
   - 下载失败会显示错误提示
   - 可以重试更新

## 📦 压缩包支持

### 支持的格式

- ✅ **ZIP** - 使用 .NET 内置解压，无需额外工具
- ✅ **7z** - 需要程序目录下有 `7z.exe`
- ✅ **RAR** - 需要程序目录下有 `7z.exe`

### 自动解压流程

1. 下载压缩包到临时目录
2. 自动检测文件扩展名（.zip、.7z、.rar）
3. 自动解压到临时目录
4. 删除压缩包文件
5. 使用解压后的文件进行更新

### 使用压缩包的优势

- 📉 减少下载大小（压缩后更小）
- 🚀 加快下载速度
- 📦 方便打包多个文件

### 配置示例

**files.txt 内容：**
```txt
update.zip
```

**服务器目录：**
```
v5.4.0/
├── files.txt
└── update.zip        ← 压缩包内包含 Canvas.Cast.dll 和 Resources.pak
```

**update.zip 内容：**
```
Canvas.Cast.dll
Resources.pak
```

### 混合使用

也可以混合使用压缩包和普通文件：

**files.txt：**
```txt
update.zip
config.json
```

系统会：
1. 下载 `update.zip` 并自动解压
2. 下载 `config.json`
3. 使用所有文件进行更新

## 📊 示例场景

### 场景 1：只更新 DLL

```
v5.3.0/
├── files.txt          ← 内容: Canvas.Cast.dll
└── Canvas.Cast.dll
```

### 场景 2：同时更新 DLL 和资源

```
v5.4.0/
├── files.txt          ← 内容: Canvas.Cast.dll\nResources.pak
├── Canvas.Cast.dll
└── Resources.pak
```

### 场景 3：使用 ZIP 压缩包

```
v5.5.0/
├── files.txt          ← 内容: update.zip
└── update.zip         ← 包含 Canvas.Cast.dll 和 Resources.pak
```

### 场景 4：混合使用

```
v5.6.0/
├── files.txt          ← 内容: update.zip\nconfig.json
├── update.zip         ← 包含 Canvas.Cast.dll 和 Resources.pak
└── config.json
```

### 场景 5：不使用 files.txt

```
v5.7.0/
├── Canvas.Cast.dll    ← 系统会自动尝试下载这两个文件
└── Resources.pak
```

