# å¤šåœ£ç»ç‰ˆæœ¬æ•°æ®åº“æ¥å£è®¾è®¡æ–‡æ¡£

> **é¡¹ç›®**: å’æ…•æŠ•å½± - å¤šåœ£ç»ç‰ˆæœ¬æ”¯æŒ  
> **ç‰ˆæœ¬**: v5.6.0+  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-05  
> **æ›´æ–°æ—¥æœŸ**: 2025-11-05

---

## ğŸ“‹ è®¾è®¡ç›®æ ‡

### æ ¸å¿ƒéœ€æ±‚
1. **æ”¯æŒå¤šä¸ªåœ£ç»ç‰ˆæœ¬**ï¼šå’Œåˆæœ¬ä¿®è®¢ç‰ˆã€æ–°è¯‘æœ¬ã€å•æŒ¯ä¸­è¯‘æœ¬ã€NIVã€KJVç­‰
2. **ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£**ï¼šä¸åŒç‰ˆæœ¬ä½¿ç”¨ç›¸åŒçš„APIæ¥å£
3. **çµæ´»çš„ç‰ˆæœ¬åˆ‡æ¢**ï¼šç”¨æˆ·å¯ä»¥éšæ—¶åˆ‡æ¢åœ£ç»ç‰ˆæœ¬
4. **ç‰ˆæœ¬å¯¹ç…§æ˜¾ç¤º**ï¼šæ”¯æŒå¤šç‰ˆæœ¬å¹¶æ’å¯¹ç…§
5. **æ˜“äºæ‰©å±•**ï¼šæ–¹ä¾¿æ·»åŠ æ–°çš„åœ£ç»ç‰ˆæœ¬
6. **é«˜æ€§èƒ½æŸ¥è¯¢**ï¼šç¼“å­˜å’Œç´¢å¼•ä¼˜åŒ–

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UI Layer                              â”‚
â”‚  (MainWindow.Bible.cs - åœ£ç»ç•Œé¢ã€ç‰ˆæœ¬åˆ‡æ¢)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Business Layer                              â”‚
â”‚  BibleVersionManager (ç‰ˆæœ¬ç®¡ç†å™¨)                            â”‚
â”‚  - å½“å‰ç‰ˆæœ¬ç®¡ç†                                              â”‚
â”‚  - ç‰ˆæœ¬åˆ‡æ¢                                                  â”‚
â”‚  - å¤šç‰ˆæœ¬å¯¹ç…§                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Service Layer                              â”‚
â”‚  IBibleDataService (ç»Ÿä¸€æ¥å£)                                â”‚
â”‚  â”œâ”€ BibleDataServiceBase (æŠ½è±¡åŸºç±»)                         â”‚
â”‚  â”œâ”€ CuvBibleService (å’Œåˆæœ¬ä¿®è®¢ç‰ˆ)                          â”‚
â”‚  â”œâ”€ CnvBibleService (æ–°è¯‘æœ¬)                                â”‚
â”‚  â”œâ”€ LzzBibleService (å•æŒ¯ä¸­è¯‘æœ¬)                            â”‚
â”‚  â””â”€ NivBibleService (NIVè‹±æ–‡ç‰ˆ)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Data Layer                                 â”‚
â”‚  Multiple Bible Databases                                    â”‚
â”‚  â”œâ”€ data/assets/bible_cuv.db  (å’Œåˆæœ¬ä¿®è®¢ç‰ˆ B13)            â”‚
â”‚  â”œâ”€ data/assets/bible_cnv.db  (æ–°è¯‘æœ¬)                      â”‚
â”‚  â”œâ”€ data/assets/bible_lzz.db  (å•æŒ¯ä¸­è¯‘æœ¬)                  â”‚
â”‚  â””â”€ data/assets/bible_niv.db  (NIV)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### 1. åœ£ç»ç‰ˆæœ¬å…ƒæ•°æ®æ¨¡å‹

```csharp
/// <summary>
/// åœ£ç»ç‰ˆæœ¬å…ƒæ•°æ®
/// </summary>
public class BibleVersionInfo
{
    /// <summary>
    /// ç‰ˆæœ¬IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
    /// </summary>
    public string VersionId { get; set; }
    
    /// <summary>
    /// ç‰ˆæœ¬ç®€ç§°ï¼ˆå¦‚ï¼šCUVã€CNVã€LZZã€NIVï¼‰
    /// </summary>
    public string ShortName { get; set; }
    
    /// <summary>
    /// ç‰ˆæœ¬å…¨ç§°
    /// </summary>
    public string FullName { get; set; }
    
    /// <summary>
    /// ç‰ˆæœ¬è¯­è¨€
    /// </summary>
    public string Language { get; set; }
    
    /// <summary>
    /// æ•°æ®åº“æ–‡ä»¶å
    /// </summary>
    public string DatabaseFileName { get; set; }
    
    /// <summary>
    /// ç‰ˆæœ¬æè¿°
    /// </summary>
    public string Description { get; set; }
    
    /// <summary>
    /// ç‰ˆæœ¬å¹´ä»½
    /// </summary>
    public int? Year { get; set; }
    
    /// <summary>
    /// æ˜¯å¦å·²å®‰è£…
    /// </summary>
    public bool IsInstalled { get; set; }
    
    /// <summary>
    /// æ•°æ®åº“ç‰ˆæœ¬å·
    /// </summary>
    public string DbVersion { get; set; }
    
    /// <summary>
    /// æ›´æ–°æ—¥æœŸ
    /// </summary>
    public DateTime? UpdateDate { get; set; }
    
    /// <summary>
    /// æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    /// </summary>
    public long FileSize { get; set; }
    
    /// <summary>
    /// æ˜¯å¦ä¸ºé»˜è®¤ç‰ˆæœ¬
    /// </summary>
    public bool IsDefault { get; set; }
    
    /// <summary>
    /// æ’åºåºå·
    /// </summary>
    public int SortOrder { get; set; }
}
```

### 2. é¢„å®šä¹‰çš„åœ£ç»ç‰ˆæœ¬é…ç½®

```csharp
/// <summary>
/// åœ£ç»ç‰ˆæœ¬é…ç½®
/// </summary>
public static class BibleVersionConfig
{
    /// <summary>
    /// æ‰€æœ‰æ”¯æŒçš„åœ£ç»ç‰ˆæœ¬
    /// </summary>
    public static readonly List<BibleVersionInfo> AvailableVersions = new()
    {
        // ä¸­æ–‡ç‰ˆæœ¬
        new BibleVersionInfo
        {
            VersionId = "cuv",
            ShortName = "å’Œåˆæœ¬ä¿®è®¢ç‰ˆ",
            FullName = "å’Œåˆæœ¬ä¿®è®¢ç‰ˆï¼ˆB13ï¼‰",
            Language = "zh-CN",
            DatabaseFileName = "bible_cuv.db",
            Description = "ä¸­æ–‡å’Œåˆæœ¬ä¿®è®¢ç‰ˆï¼Œ2010å¹´å‡ºç‰ˆ",
            Year = 2010,
            IsInstalled = true,
            DbVersion = "B13",
            UpdateDate = new DateTime(2025, 4, 3),
            IsDefault = true,
            SortOrder = 1
        },
        new BibleVersionInfo
        {
            VersionId = "cnv",
            ShortName = "æ–°è¯‘æœ¬",
            FullName = "åœ£ç»æ–°è¯‘æœ¬",
            Language = "zh-CN",
            DatabaseFileName = "bible_cnv.db",
            Description = "åœ£ç»æ–°è¯‘æœ¬ï¼Œç¯çƒåœ£ç»å…¬ä¼š",
            Year = 1992,
            IsInstalled = false,
            SortOrder = 2
        },
        new BibleVersionInfo
        {
            VersionId = "lzz",
            ShortName = "å•æŒ¯ä¸­è¯‘æœ¬",
            FullName = "å•æŒ¯ä¸­è¯‘æœ¬",
            Language = "zh-CN",
            DatabaseFileName = "bible_lzz.db",
            Description = "å•æŒ¯ä¸­è¯‘æœ¬",
            Year = 1970,
            IsInstalled = false,
            SortOrder = 3
        },
        new BibleVersionInfo
        {
            VersionId = "kjv",
            ShortName = "KJV",
            FullName = "King James Version",
            Language = "en",
            DatabaseFileName = "bible_kjv.db",
            Description = "King James Version (1611)",
            Year = 1611,
            IsInstalled = false,
            SortOrder = 10
        },
        new BibleVersionInfo
        {
            VersionId = "niv",
            ShortName = "NIV",
            FullName = "New International Version",
            Language = "en",
            DatabaseFileName = "bible_niv.db",
            Description = "New International Version",
            Year = 2011,
            IsInstalled = false,
            SortOrder = 11
        },
        new BibleVersionInfo
        {
            VersionId = "esv",
            ShortName = "ESV",
            FullName = "English Standard Version",
            Language = "en",
            DatabaseFileName = "bible_esv.db",
            Description = "English Standard Version",
            Year = 2001,
            IsInstalled = false,
            SortOrder = 12
        }
    };
    
    /// <summary>
    /// æ ¹æ®ç‰ˆæœ¬IDè·å–ç‰ˆæœ¬ä¿¡æ¯
    /// </summary>
    public static BibleVersionInfo GetVersion(string versionId)
    {
        return AvailableVersions.FirstOrDefault(v => 
            v.VersionId.Equals(versionId, StringComparison.OrdinalIgnoreCase));
    }
    
    /// <summary>
    /// è·å–å·²å®‰è£…çš„ç‰ˆæœ¬
    /// </summary>
    public static List<BibleVersionInfo> GetInstalledVersions()
    {
        return AvailableVersions.Where(v => v.IsInstalled).ToList();
    }
    
    /// <summary>
    /// è·å–é»˜è®¤ç‰ˆæœ¬
    /// </summary>
    public static BibleVersionInfo GetDefaultVersion()
    {
        return AvailableVersions.FirstOrDefault(v => v.IsDefault) 
               ?? AvailableVersions.First();
    }
    
    /// <summary>
    /// è·å–ä¸­æ–‡ç‰ˆæœ¬
    /// </summary>
    public static List<BibleVersionInfo> GetChineseVersions()
    {
        return AvailableVersions.Where(v => v.Language == "zh-CN").ToList();
    }
    
    /// <summary>
    /// è·å–è‹±æ–‡ç‰ˆæœ¬
    /// </summary>
    public static List<BibleVersionInfo> GetEnglishVersions()
    {
        return AvailableVersions.Where(v => v.Language == "en").ToList();
    }
}
```

---

## ğŸ”Œ æœåŠ¡æ¥å£è®¾è®¡

### 1. ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£

```csharp
/// <summary>
/// åœ£ç»æ•°æ®æœåŠ¡æ¥å£ï¼ˆæ‰€æœ‰ç‰ˆæœ¬é€šç”¨ï¼‰
/// </summary>
public interface IBibleDataService
{
    /// <summary>
    /// ç‰ˆæœ¬ä¿¡æ¯
    /// </summary>
    BibleVersionInfo VersionInfo { get; }
    
    /// <summary>
    /// è·å–å•èŠ‚ç»æ–‡
    /// </summary>
    Task<BibleVerse> GetVerseAsync(int book, int chapter, int verse);
    
    /// <summary>
    /// è·å–æ•´ç« ç»æ–‡
    /// </summary>
    Task<List<BibleVerse>> GetChapterVersesAsync(int book, int chapter);
    
    /// <summary>
    /// è·å–ç« èŠ‚æ ‡é¢˜ï¼ˆå¦‚æœè¯¥ç‰ˆæœ¬æ”¯æŒï¼‰
    /// </summary>
    Task<List<BibleTitle>> GetChapterTitlesAsync(int book, int chapter);
    
    /// <summary>
    /// è·å–æ•´ç« å†…å®¹ï¼ˆç»æ–‡+æ ‡é¢˜æ··åˆï¼‰
    /// </summary>
    Task<List<object>> GetChapterContentAsync(int book, int chapter);
    
    /// <summary>
    /// æœç´¢ç»æ–‡
    /// </summary>
    Task<List<BibleSearchResult>> SearchVersesAsync(string keyword, int? bookId = null);
    
    /// <summary>
    /// è·å–ä¹¦å·ç« æ•°
    /// </summary>
    int GetChapterCount(int book);
    
    /// <summary>
    /// è·å–ç« èŠ‚æ•°
    /// </summary>
    Task<int> GetVerseCountAsync(int book, int chapter);
    
    /// <summary>
    /// æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å¯ç”¨
    /// </summary>
    Task<bool> IsDatabaseAvailableAsync();
    
    /// <summary>
    /// è·å–æ•°æ®åº“å…ƒæ•°æ®
    /// </summary>
    Task<Dictionary<string, string>> GetMetadataAsync();
}
```

### 2. æŠ½è±¡åŸºç±»å®ç°

```csharp
/// <summary>
/// åœ£ç»æ•°æ®æœåŠ¡æŠ½è±¡åŸºç±»
/// </summary>
public abstract class BibleDataServiceBase : IBibleDataService
{
    protected readonly IMemoryCache _cache;
    protected readonly string _databasePath;
    
    public BibleVersionInfo VersionInfo { get; }
    
    protected BibleDataServiceBase(
        BibleVersionInfo versionInfo, 
        IMemoryCache cache)
    {
        VersionInfo = versionInfo;
        _cache = cache;
        
        // æ„å»ºæ•°æ®åº“è·¯å¾„
        _databasePath = Path.Combine(
            AppDomain.CurrentDomain.BaseDirectory,
            "data", "assets", versionInfo.DatabaseFileName);
    }
    
    /// <summary>
    /// è·å–æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
    /// </summary>
    protected virtual string GetConnectionString()
    {
        return $"Data Source={_databasePath};Version=3;";
    }
    
    /// <summary>
    /// åˆ›å»ºæ•°æ®åº“ä¸Šä¸‹æ–‡
    /// </summary>
    protected virtual DbContext CreateDbContext()
    {
        var optionsBuilder = new DbContextOptionsBuilder<BibleDbContext>();
        optionsBuilder.UseSqlite(GetConnectionString());
        return new BibleDbContext(optionsBuilder.Options);
    }
    
    /// <summary>
    /// è·å–å•èŠ‚ç»æ–‡ï¼ˆå¸¦ç¼“å­˜ï¼‰
    /// </summary>
    public virtual async Task<BibleVerse> GetVerseAsync(int book, int chapter, int verse)
    {
        var cacheKey = $"verse_{VersionInfo.VersionId}_{book}_{chapter}_{verse}";
        
        if (_cache.TryGetValue(cacheKey, out BibleVerse cachedVerse))
        {
            #if DEBUG
            Debug.WriteLine($"[åœ£ç»-{VersionInfo.ShortName}] ç¼“å­˜å‘½ä¸­: {cacheKey}");
            #endif
            return cachedVerse;
        }
        
        #if DEBUG
        var sw = Stopwatch.StartNew();
        #endif
        
        using var context = CreateDbContext();
        var result = await context.Set<BibleVerse>()
            .FirstOrDefaultAsync(v => 
                v.Book == book && 
                v.Chapter == chapter && 
                v.Verse == verse);
        
        #if DEBUG
        sw.Stop();
        Debug.WriteLine($"[åœ£ç»-{VersionInfo.ShortName}] æŸ¥è¯¢è€—æ—¶: {sw.ElapsedMilliseconds}ms");
        #endif
        
        if (result != null)
        {
            // ç¼“å­˜10åˆ†é’Ÿ
            _cache.Set(cacheKey, result, TimeSpan.FromMinutes(10));
        }
        
        return result;
    }
    
    /// <summary>
    /// è·å–æ•´ç« ç»æ–‡ï¼ˆå¸¦ç¼“å­˜ï¼‰
    /// </summary>
    public virtual async Task<List<BibleVerse>> GetChapterVersesAsync(int book, int chapter)
    {
        var cacheKey = $"chapter_{VersionInfo.VersionId}_{book}_{chapter}";
        
        if (_cache.TryGetValue(cacheKey, out List<BibleVerse> cachedVerses))
        {
            #if DEBUG
            Debug.WriteLine($"[åœ£ç»-{VersionInfo.ShortName}] ç¼“å­˜å‘½ä¸­: {cacheKey}");
            #endif
            return cachedVerses;
        }
        
        #if DEBUG
        var sw = Stopwatch.StartNew();
        #endif
        
        using var context = CreateDbContext();
        var verses = await context.Set<BibleVerse>()
            .Where(v => v.Book == book && v.Chapter == chapter)
            .OrderBy(v => v.Verse)
            .ToListAsync();
        
        #if DEBUG
        sw.Stop();
        Debug.WriteLine($"[åœ£ç»-{VersionInfo.ShortName}] æŸ¥è¯¢æ•´ç« : {sw.ElapsedMilliseconds}ms, ç»“æœæ•°: {verses.Count}");
        #endif
        
        // ç¼“å­˜30åˆ†é’Ÿ
        _cache.Set(cacheKey, verses, TimeSpan.FromMinutes(30));
        
        return verses;
    }
    
    /// <summary>
    /// æœç´¢ç»æ–‡
    /// </summary>
    public virtual async Task<List<BibleSearchResult>> SearchVersesAsync(
        string keyword, int? bookId = null)
    {
        if (string.IsNullOrWhiteSpace(keyword))
            return new List<BibleSearchResult>();
        
        #if DEBUG
        var sw = Stopwatch.StartNew();
        #endif
        
        using var context = CreateDbContext();
        var query = context.Set<BibleVerse>().AsQueryable();
        
        if (bookId.HasValue)
        {
            query = query.Where(v => v.Book == bookId.Value);
        }
        
        query = query.Where(v => v.Scripture.Contains(keyword));
        
        var results = await query
            .Take(100)
            .Select(v => new BibleSearchResult
            {
                Book = v.Book,
                Chapter = v.Chapter,
                Verse = v.Verse,
                Scripture = v.Scripture,
                BookName = BibleBookConfig.GetBook(v.Book).Name,
                Reference = $"{BibleBookConfig.GetBook(v.Book).Name} {v.Chapter}:{v.Verse}",
                VersionId = VersionInfo.VersionId
            })
            .ToListAsync();
        
        #if DEBUG
        sw.Stop();
        Debug.WriteLine($"[åœ£ç»-{VersionInfo.ShortName}] æœç´¢ '{keyword}': {sw.ElapsedMilliseconds}ms, ç»“æœæ•°: {results.Count}");
        #endif
        
        return results;
    }
    
    /// <summary>
    /// æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å¯ç”¨
    /// </summary>
    public virtual async Task<bool> IsDatabaseAvailableAsync()
    {
        try
        {
            if (!File.Exists(_databasePath))
            {
                #if DEBUG
                Debug.WriteLine($"[åœ£ç»-{VersionInfo.ShortName}] æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨: {_databasePath}");
                #endif
                return false;
            }
            
            using var context = CreateDbContext();
            var count = await context.Set<BibleVerse>().CountAsync();
            
            #if DEBUG
            Debug.WriteLine($"[åœ£ç»-{VersionInfo.ShortName}] æ•°æ®åº“å¯ç”¨ï¼Œç»æ–‡æ•°: {count}");
            #endif
            
            return count > 0;
        }
        catch (Exception ex)
        {
            #if DEBUG
            Debug.WriteLine($"[åœ£ç»-{VersionInfo.ShortName}] æ•°æ®åº“æ£€æŸ¥å¤±è´¥: {ex.Message}");
            #endif
            return false;
        }
    }
    
    // å…¶ä»–æ¥å£æ–¹æ³•çš„é»˜è®¤å®ç°...
    public abstract Task<List<BibleTitle>> GetChapterTitlesAsync(int book, int chapter);
    public abstract Task<List<object>> GetChapterContentAsync(int book, int chapter);
    public abstract int GetChapterCount(int book);
    public abstract Task<int> GetVerseCountAsync(int book, int chapter);
    public abstract Task<Dictionary<string, string>> GetMetadataAsync();
}
```

### 3. å…·ä½“ç‰ˆæœ¬å®ç°ç¤ºä¾‹

```csharp
/// <summary>
/// å’Œåˆæœ¬ä¿®è®¢ç‰ˆæ•°æ®æœåŠ¡
/// </summary>
public class CuvBibleService : BibleDataServiceBase
{
    public CuvBibleService(IMemoryCache cache) 
        : base(BibleVersionConfig.GetVersion("cuv"), cache)
    {
    }
    
    /// <summary>
    /// è·å–ç« èŠ‚æ ‡é¢˜ï¼ˆå’Œåˆæœ¬ä¿®è®¢ç‰ˆæ”¯æŒæ ‡é¢˜ï¼‰
    /// </summary>
    public override async Task<List<BibleTitle>> GetChapterTitlesAsync(int book, int chapter)
    {
        var cacheKey = $"titles_{VersionInfo.VersionId}_{book}_{chapter}";
        
        if (_cache.TryGetValue(cacheKey, out List<BibleTitle> cachedTitles))
            return cachedTitles;
        
        using var context = CreateDbContext();
        var titles = await context.Set<BibleTitle>()
            .Where(t => t.Book == book && t.Chapter == chapter)
            .OrderBy(t => t.Verse)
            .ToListAsync();
        
        _cache.Set(cacheKey, titles, TimeSpan.FromMinutes(30));
        return titles;
    }
    
    /// <summary>
    /// è·å–æ•´ç« å†…å®¹ï¼ˆç»æ–‡+æ ‡é¢˜æ··åˆï¼‰
    /// </summary>
    public override async Task<List<object>> GetChapterContentAsync(int book, int chapter)
    {
        var verses = await GetChapterVersesAsync(book, chapter);
        var titles = await GetChapterTitlesAsync(book, chapter);
        
        // åˆå¹¶ç»æ–‡å’Œæ ‡é¢˜ï¼ŒæŒ‰èŠ‚å·æ’åº
        var content = new List<object>();
        var titleDict = titles.ToDictionary(t => t.Verse);
        
        foreach (var verse in verses)
        {
            // å¦‚æœè¯¥èŠ‚æœ‰æ ‡é¢˜ï¼Œå…ˆæ·»åŠ æ ‡é¢˜
            if (titleDict.ContainsKey(verse.Verse))
            {
                content.Add(titleDict[verse.Verse]);
            }
            
            // æ·»åŠ ç»æ–‡
            content.Add(verse);
        }
        
        return content;
    }
    
    public override int GetChapterCount(int book)
    {
        return BibleBookConfig.GetBook(book)?.ChapterCount ?? 0;
    }
    
    public override async Task<int> GetVerseCountAsync(int book, int chapter)
    {
        var cacheKey = $"versecount_{VersionInfo.VersionId}_{book}_{chapter}";
        
        if (_cache.TryGetValue(cacheKey, out int cachedCount))
            return cachedCount;
        
        using var context = CreateDbContext();
        var count = await context.Set<BibleVerse>()
            .CountAsync(v => v.Book == book && v.Chapter == chapter);
        
        _cache.Set(cacheKey, count, TimeSpan.FromHours(1));
        return count;
    }
    
    public override async Task<Dictionary<string, string>> GetMetadataAsync()
    {
        using var context = CreateDbContext();
        var metadata = await context.Set<BibleMetadata>()
            .ToDictionaryAsync(m => m.Name, m => m.Value);
        return metadata;
    }
}

/// <summary>
/// æ–°è¯‘æœ¬æ•°æ®æœåŠ¡
/// </summary>
public class CnvBibleService : BibleDataServiceBase
{
    public CnvBibleService(IMemoryCache cache) 
        : base(BibleVersionConfig.GetVersion("cnv"), cache)
    {
    }
    
    // æ–°è¯‘æœ¬å¯èƒ½æ²¡æœ‰ç« èŠ‚æ ‡é¢˜
    public override async Task<List<BibleTitle>> GetChapterTitlesAsync(int book, int chapter)
    {
        return new List<BibleTitle>(); // è¿”å›ç©ºåˆ—è¡¨
    }
    
    // å…¶ä»–æ–¹æ³•å®ç°...
}
```

---

## ğŸ›ï¸ ç‰ˆæœ¬ç®¡ç†å™¨è®¾è®¡

```csharp
/// <summary>
/// åœ£ç»ç‰ˆæœ¬ç®¡ç†å™¨
/// </summary>
public class BibleVersionManager
{
    private readonly IServiceProvider _serviceProvider;
    private readonly IMemoryCache _cache;
    private readonly Dictionary<string, IBibleDataService> _services;
    
    private string _currentVersionId;
    
    public BibleVersionManager(IServiceProvider serviceProvider, IMemoryCache cache)
    {
        _serviceProvider = serviceProvider;
        _cache = cache;
        _services = new Dictionary<string, IBibleDataService>();
        
        // è®¾ç½®é»˜è®¤ç‰ˆæœ¬
        _currentVersionId = BibleVersionConfig.GetDefaultVersion().VersionId;
    }
    
    /// <summary>
    /// å½“å‰ç‰ˆæœ¬ID
    /// </summary>
    public string CurrentVersionId => _currentVersionId;
    
    /// <summary>
    /// å½“å‰ç‰ˆæœ¬ä¿¡æ¯
    /// </summary>
    public BibleVersionInfo CurrentVersionInfo => 
        BibleVersionConfig.GetVersion(_currentVersionId);
    
    /// <summary>
    /// å½“å‰ç‰ˆæœ¬æœåŠ¡
    /// </summary>
    public IBibleDataService CurrentService => GetService(_currentVersionId);
    
    /// <summary>
    /// è·å–æŒ‡å®šç‰ˆæœ¬çš„æœåŠ¡
    /// </summary>
    public IBibleDataService GetService(string versionId)
    {
        if (_services.ContainsKey(versionId))
        {
            return _services[versionId];
        }
        
        // åˆ›å»ºæœåŠ¡å®ä¾‹
        var versionInfo = BibleVersionConfig.GetVersion(versionId);
        if (versionInfo == null)
        {
            throw new ArgumentException($"æœªçŸ¥çš„åœ£ç»ç‰ˆæœ¬: {versionId}");
        }
        
        IBibleDataService service = versionId.ToLower() switch
        {
            "cuv" => new CuvBibleService(_cache),
            "cnv" => new CnvBibleService(_cache),
            "lzz" => new LzzBibleService(_cache),
            "kjv" => new KjvBibleService(_cache),
            "niv" => new NivBibleService(_cache),
            "esv" => new EsvBibleService(_cache),
            _ => throw new NotImplementedException($"ç‰ˆæœ¬ {versionId} å°šæœªå®ç°")
        };
        
        _services[versionId] = service;
        return service;
    }
    
    /// <summary>
    /// åˆ‡æ¢ç‰ˆæœ¬
    /// </summary>
    public async Task<bool> SwitchVersionAsync(string versionId)
    {
        var versionInfo = BibleVersionConfig.GetVersion(versionId);
        if (versionInfo == null)
        {
            #if DEBUG
            Debug.WriteLine($"[ç‰ˆæœ¬ç®¡ç†å™¨] æœªçŸ¥ç‰ˆæœ¬: {versionId}");
            #endif
            return false;
        }
        
        if (!versionInfo.IsInstalled)
        {
            #if DEBUG
            Debug.WriteLine($"[ç‰ˆæœ¬ç®¡ç†å™¨] ç‰ˆæœ¬æœªå®‰è£…: {versionId}");
            #endif
            return false;
        }
        
        var service = GetService(versionId);
        if (!await service.IsDatabaseAvailableAsync())
        {
            #if DEBUG
            Debug.WriteLine($"[ç‰ˆæœ¬ç®¡ç†å™¨] æ•°æ®åº“ä¸å¯ç”¨: {versionId}");
            #endif
            return false;
        }
        
        _currentVersionId = versionId;
        
        #if DEBUG
        Debug.WriteLine($"[ç‰ˆæœ¬ç®¡ç†å™¨] åˆ‡æ¢åˆ°ç‰ˆæœ¬: {versionInfo.ShortName}");
        #endif
        
        return true;
    }
    
    /// <summary>
    /// è·å–å¤šä¸ªç‰ˆæœ¬çš„åŒä¸€èŠ‚ç»æ–‡ï¼ˆç”¨äºå¯¹ç…§ï¼‰
    /// </summary>
    public async Task<Dictionary<string, BibleVerse>> GetVerseComparisonAsync(
        int book, int chapter, int verse, List<string> versionIds)
    {
        var result = new Dictionary<string, BibleVerse>();
        
        var tasks = versionIds.Select(async versionId =>
        {
            try
            {
                var service = GetService(versionId);
                var verseData = await service.GetVerseAsync(book, chapter, verse);
                return (versionId, verseData);
            }
            catch (Exception ex)
            {
                #if DEBUG
                Debug.WriteLine($"[ç‰ˆæœ¬ç®¡ç†å™¨] è·å–ç‰ˆæœ¬ {versionId} å¤±è´¥: {ex.Message}");
                #endif
                return (versionId, null);
            }
        });
        
        var results = await Task.WhenAll(tasks);
        
        foreach (var (versionId, verseData) in results)
        {
            if (verseData != null)
            {
                result[versionId] = verseData;
            }
        }
        
        return result;
    }
    
    /// <summary>
    /// è·å–å·²å®‰è£…çš„ç‰ˆæœ¬åˆ—è¡¨
    /// </summary>
    public List<BibleVersionInfo> GetInstalledVersions()
    {
        return BibleVersionConfig.GetInstalledVersions();
    }
    
    /// <summary>
    /// è·å–æ‰€æœ‰å¯ç”¨çš„ç‰ˆæœ¬åˆ—è¡¨
    /// </summary>
    public List<BibleVersionInfo> GetAllVersions()
    {
        return BibleVersionConfig.AvailableVersions;
    }
    
    /// <summary>
    /// æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å·²å®‰è£…
    /// </summary>
    public async Task<bool> CheckVersionInstalledAsync(string versionId)
    {
        var versionInfo = BibleVersionConfig.GetVersion(versionId);
        if (versionInfo == null)
            return false;
        
        var dbPath = Path.Combine(
            AppDomain.CurrentDomain.BaseDirectory,
            "data", "assets", versionInfo.DatabaseFileName);
        
        return File.Exists(dbPath);
    }
    
    /// <summary>
    /// æ‰«æå¹¶æ›´æ–°å·²å®‰è£…ç‰ˆæœ¬çŠ¶æ€
    /// </summary>
    public async Task ScanInstalledVersionsAsync()
    {
        foreach (var version in BibleVersionConfig.AvailableVersions)
        {
            version.IsInstalled = await CheckVersionInstalledAsync(version.VersionId);
            
            if (version.IsInstalled)
            {
                try
                {
                    var dbPath = Path.Combine(
                        AppDomain.CurrentDomain.BaseDirectory,
                        "data", "assets", version.DatabaseFileName);
                    
                    var fileInfo = new FileInfo(dbPath);
                    version.FileSize = fileInfo.Length;
                }
                catch { }
            }
        }
        
        #if DEBUG
        var installedCount = BibleVersionConfig.AvailableVersions.Count(v => v.IsInstalled);
        Debug.WriteLine($"[ç‰ˆæœ¬ç®¡ç†å™¨] å·²å®‰è£…ç‰ˆæœ¬æ•°: {installedCount}");
        #endif
    }
}
```

---

## ğŸ¨ UI ç•Œé¢æ‰©å±•

### 1. ç‰ˆæœ¬é€‰æ‹©å™¨ UI

```csharp
/// <summary>
/// åœ¨ MainWindow.Bible.cs ä¸­æ·»åŠ ç‰ˆæœ¬é€‰æ‹©ç›¸å…³æ–¹æ³•
/// </summary>
public partial class MainWindow
{
    private BibleVersionManager _versionManager;
    
    /// <summary>
    /// æ˜¾ç¤ºç‰ˆæœ¬é€‰æ‹©å™¨
    /// </summary>
    private void ShowVersionSelector()
    {
        var contextMenu = new ContextMenu();
        contextMenu.Style = (Style)FindResource("NoBorderContextMenuStyle");
        
        var installedVersions = _versionManager.GetInstalledVersions();
        
        foreach (var version in installedVersions)
        {
            var menuItem = new MenuItem
            {
                Header = version.ShortName,
                IsCheckable = true,
                IsChecked = version.VersionId == _versionManager.CurrentVersionId
            };
            
            menuItem.Click += async (s, e) =>
            {
                await SwitchBibleVersionAsync(version.VersionId);
            };
            
            contextMenu.Items.Add(menuItem);
        }
        
        contextMenu.Items.Add(new Separator());
        
        var manageItem = new MenuItem { Header = "ç®¡ç†ç‰ˆæœ¬..." };
        manageItem.Click += (s, e) => ShowVersionManager();
        contextMenu.Items.Add(manageItem);
        
        contextMenu.IsOpen = true;
    }
    
    /// <summary>
    /// åˆ‡æ¢åœ£ç»ç‰ˆæœ¬
    /// </summary>
    private async Task SwitchBibleVersionAsync(string versionId)
    {
        var success = await _versionManager.SwitchVersionAsync(versionId);
        
        if (success)
        {
            #if DEBUG
            Debug.WriteLine($"[åœ£ç»] ç‰ˆæœ¬åˆ‡æ¢æˆåŠŸ: {versionId}");
            #endif
            
            // é‡æ–°åŠ è½½å½“å‰æ˜¾ç¤ºçš„å†…å®¹
            await ReloadCurrentBibleContentAsync();
            
            // æ›´æ–°UIæç¤º
            ShowVersionSwitchNotification(_versionManager.CurrentVersionInfo.ShortName);
        }
        else
        {
            MessageBox.Show("ç‰ˆæœ¬åˆ‡æ¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚", 
                          "é”™è¯¯", MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }
    
    /// <summary>
    /// æ˜¾ç¤ºç‰ˆæœ¬ç®¡ç†çª—å£
    /// </summary>
    private void ShowVersionManager()
    {
        var window = new BibleVersionManagerWindow(_versionManager);
        window.Owner = this;
        window.ShowDialog();
    }
}
```

### 2. ç‰ˆæœ¬ç®¡ç†çª—å£ XAML

```xml
<!-- UI/Windows/BibleVersionManagerWindow.xaml -->
<Window x:Class="ImageColorChanger.UI.Windows.BibleVersionManagerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="åœ£ç»ç‰ˆæœ¬ç®¡ç†" Height="500" Width="700"
        WindowStartupLocation="CenterOwner"
        Background="#F5F5F5">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- æ ‡é¢˜ -->
        <TextBlock Grid.Row="0" 
                   Text="åœ£ç»ç‰ˆæœ¬ç®¡ç†" 
                   FontSize="24" 
                   FontWeight="Bold"
                   Margin="0,0,0,20"/>
        
        <!-- ç‰ˆæœ¬åˆ—è¡¨ -->
        <DataGrid Grid.Row="1" 
                  x:Name="VersionDataGrid"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  SelectionMode="Single">
            <DataGrid.Columns>
                <DataGridCheckBoxColumn Header="å·²å®‰è£…" 
                                       Binding="{Binding IsInstalled}" 
                                       IsReadOnly="True"
                                       Width="80"/>
                <DataGridTextColumn Header="ç®€ç§°" 
                                   Binding="{Binding ShortName}" 
                                   IsReadOnly="True"
                                   Width="150"/>
                <DataGridTextColumn Header="å…¨ç§°" 
                                   Binding="{Binding FullName}" 
                                   IsReadOnly="True"
                                   Width="*"/>
                <DataGridTextColumn Header="è¯­è¨€" 
                                   Binding="{Binding Language}" 
                                   IsReadOnly="True"
                                   Width="80"/>
                <DataGridTextColumn Header="å¹´ä»½" 
                                   Binding="{Binding Year}" 
                                   IsReadOnly="True"
                                   Width="80"/>
                <DataGridTemplateColumn Header="æ“ä½œ" Width="150">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <Button Content="ä¸‹è½½" 
                                       Width="60" 
                                       Height="25"
                                       Margin="2"
                                       Click="DownloadButton_Click"
                                       Visibility="{Binding IsInstalled, 
                                                   Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                                <Button Content="åˆ é™¤" 
                                       Width="60" 
                                       Height="25"
                                       Margin="2"
                                       Click="DeleteButton_Click"
                                       Visibility="{Binding IsInstalled, 
                                                   Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </StackPanel>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>
        
        <!-- åº•éƒ¨æŒ‰é’® -->
        <StackPanel Grid.Row="2" 
                    Orientation="Horizontal" 
                    HorizontalAlignment="Right"
                    Margin="0,20,0,0">
            <Button Content="æ‰«æå·²å®‰è£…ç‰ˆæœ¬" 
                   Width="120" 
                   Height="35"
                   Margin="0,0,10,0"
                   Click="ScanButton_Click"/>
            <Button Content="å…³é—­" 
                   Width="80" 
                   Height="35"
                   Click="CloseButton_Click"/>
        </StackPanel>
    </Grid>
</Window>
```

### 3. ç‰ˆæœ¬å¯¹ç…§æ˜¾ç¤ºUI

```xml
<!-- ç‰ˆæœ¬å¯¹ç…§æ˜¾ç¤ºåŒºåŸŸï¼ˆåœ¨ MainWindow.xaml ä¸­æ·»åŠ ï¼‰ -->
<ScrollViewer x:Name="BibleComparisonScrollViewer" 
              Grid.Row="1" 
              Visibility="Collapsed"
              Background="#2D2D30">
    <StackPanel Margin="20">
        <!-- ç« èŠ‚æ ‡é¢˜ -->
        <TextBlock x:Name="ComparisonChapterTitle" 
                   Text="åˆ›ä¸–è®° 1:1" 
                   FontSize="28" 
                   FontWeight="Bold" 
                   Foreground="#FF5722"
                   HorizontalAlignment="Center"
                   Margin="0,20,0,30"/>
        
        <!-- ç‰ˆæœ¬å¯¹ç…§åˆ—è¡¨ -->
        <ItemsControl x:Name="VersionComparisonList">
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Border Background="#3C3C3C" 
                            BorderBrush="#555" 
                            BorderThickness="1"
                            CornerRadius="4"
                            Margin="0,10,0,10"
                            Padding="20">
                        <StackPanel>
                            <!-- ç‰ˆæœ¬åç§° -->
                            <TextBlock Text="{Binding VersionName}" 
                                      FontSize="18" 
                                      FontWeight="Bold" 
                                      Foreground="#FFC107"
                                      Margin="0,0,0,10"/>
                            <!-- ç»æ–‡å†…å®¹ -->
                            <TextBlock Text="{Binding Scripture}" 
                                      FontSize="20" 
                                      Foreground="White"
                                      TextWrapping="Wrap"
                                      LineHeight="32"/>
                        </StackPanel>
                    </Border>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>
    </StackPanel>
</ScrollViewer>
```

---

## ğŸ“ ä¾èµ–æ³¨å…¥é…ç½®

```csharp
/// <summary>
/// åœ¨ ServiceCollectionExtensions.cs ä¸­æ³¨å†ŒæœåŠ¡
/// </summary>
public static class ServiceCollectionExtensions
{
    public static IServiceCollection AddCanvasCastServices(this IServiceCollection services)
    {
        // ... ç°æœ‰æœåŠ¡æ³¨å†Œ ...
        
        // æ³¨å†Œåœ£ç»ç‰ˆæœ¬ç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
        services.AddSingleton<BibleVersionManager>();
        
        // æ³¨å†Œå†…å­˜ç¼“å­˜ï¼ˆå¦‚æœè¿˜æ²¡æœ‰æ³¨å†Œï¼‰
        services.AddMemoryCache();
        
        return services;
    }
}
```

---

## ğŸ—‚ï¸ æ•°æ®åº“æ–‡ä»¶å‘½åè§„èŒƒ

### æ–‡ä»¶å‘½åæ ¼å¼
```
bible_<ç‰ˆæœ¬ID>.db
```

### ç¤ºä¾‹
- `bible_cuv.db` - å’Œåˆæœ¬ä¿®è®¢ç‰ˆ
- `bible_cnv.db` - æ–°è¯‘æœ¬
- `bible_lzz.db` - å•æŒ¯ä¸­è¯‘æœ¬
- `bible_kjv.db` - King James Version
- `bible_niv.db` - New International Version
- `bible_esv.db` - English Standard Version

### å­˜æ”¾ä½ç½®
```
D:\img\CCanvas\
  â””â”€ data\
      â””â”€ assets\
          â”œâ”€ bible_cuv.db  (å’Œåˆæœ¬ä¿®è®¢ç‰ˆ)
          â”œâ”€ bible_cnv.db  (æ–°è¯‘æœ¬ï¼Œå¯é€‰)
          â”œâ”€ bible_lzz.db  (å•æŒ¯ä¸­è¯‘æœ¬ï¼Œå¯é€‰)
          â”œâ”€ bible_kjv.db  (KJVï¼Œå¯é€‰)
          â”œâ”€ bible_niv.db  (NIVï¼Œå¯é€‰)
          â””â”€ bible_esv.db  (ESVï¼Œå¯é€‰)
```

---

## ğŸ”„ æ•°æ®åº“ç»“æ„æ ‡å‡†åŒ–

### æ‰€æœ‰ç‰ˆæœ¬æ•°æ®åº“å¿…é¡»åŒ…å«çš„è¡¨

#### 1. Bible è¡¨ï¼ˆå¿…éœ€ï¼‰
```sql
CREATE TABLE Bible (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    Book INTEGER NOT NULL,
    Chapter INTEGER NOT NULL,
    Verse INTEGER NOT NULL,
    Scripture TEXT NOT NULL
);

CREATE INDEX idx_bible_book_chapter ON Bible(Book, Chapter);
CREATE INDEX idx_bible_book_chapter_verse ON Bible(Book, Chapter, Verse);
```

#### 2. Titles è¡¨ï¼ˆå¯é€‰ï¼Œå»ºè®®åŒ…å«ï¼‰
```sql
CREATE TABLE Titles (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    Book INTEGER NOT NULL,
    Chapter INTEGER NOT NULL,
    Verse INTEGER NOT NULL,
    Scripture TEXT NOT NULL
);

CREATE INDEX idx_titles_book_chapter ON Titles(Book, Chapter);
```

#### 3. metadata è¡¨ï¼ˆå¿…éœ€ï¼‰
```sql
CREATE TABLE metadata (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    value TEXT NOT NULL
);

-- å¿…éœ€çš„å…ƒæ•°æ®
INSERT INTO metadata (name, value) VALUES ('id', 'CUV');
INSERT INTO metadata (name, value) VALUES ('version', '1.0');
INSERT INTO metadata (name, value) VALUES ('date', '20250405');
INSERT INTO metadata (name, value) VALUES ('lang', 'zh-CN');
INSERT INTO metadata (name, value) VALUES ('name', 'å’Œåˆæœ¬ä¿®è®¢ç‰ˆ');
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç¼“å­˜ç­–ç•¥
- **å•èŠ‚ç»æ–‡**ï¼šç¼“å­˜ 10 åˆ†é’Ÿ
- **æ•´ç« ç»æ–‡**ï¼šç¼“å­˜ 30 åˆ†é’Ÿ
- **ç« èŠ‚æ ‡é¢˜**ï¼šç¼“å­˜ 30 åˆ†é’Ÿ
- **èŠ‚æ•°ç»Ÿè®¡**ï¼šç¼“å­˜ 1 å°æ—¶
- **æœç´¢ç»“æœ**ï¼šä¸ç¼“å­˜ï¼ˆç»“æœå¯èƒ½è¾ƒå¤§ï¼‰

### 2. é¢„åŠ è½½ç­–ç•¥
```csharp
/// <summary>
/// é¢„åŠ è½½ç›¸é‚»ç« èŠ‚
/// </summary>
private async Task PreloadAdjacentChaptersAsync(int book, int chapter)
{
    var tasks = new List<Task>();
    
    // é¢„åŠ è½½ä¸Šä¸€ç« 
    if (chapter > 1)
    {
        tasks.Add(CurrentService.GetChapterVersesAsync(book, chapter - 1));
    }
    
    // é¢„åŠ è½½ä¸‹ä¸€ç« 
    var maxChapter = CurrentService.GetChapterCount(book);
    if (chapter < maxChapter)
    {
        tasks.Add(CurrentService.GetChapterVersesAsync(book, chapter + 1));
    }
    
    await Task.WhenAll(tasks);
}
```

### 3. æ‰¹é‡æ“ä½œä¼˜åŒ–
```csharp
/// <summary>
/// æ‰¹é‡è·å–å¤šä¸ªç‰ˆæœ¬çš„æ•´ç« ç»æ–‡
/// </summary>
public async Task<Dictionary<string, List<BibleVerse>>> GetChapterComparisonAsync(
    int book, int chapter, List<string> versionIds)
{
    var tasks = versionIds.Select(async versionId =>
    {
        var service = GetService(versionId);
        var verses = await service.GetChapterVersesAsync(book, chapter);
        return (versionId, verses);
    });
    
    var results = await Task.WhenAll(tasks);
    
    return results.ToDictionary(r => r.versionId, r => r.verses);
}
```

---

## ğŸ“¦ ç‰ˆæœ¬ä¸‹è½½å’Œå®‰è£…

### ç‰ˆæœ¬ä¸‹è½½åŠŸèƒ½è®¾è®¡

```csharp
/// <summary>
/// åœ£ç»ç‰ˆæœ¬ä¸‹è½½æœåŠ¡
/// </summary>
public class BibleVersionDownloadService
{
    private readonly HttpClient _httpClient;
    private const string DownloadBaseUrl = "https://example.com/bibles/";
    
    public BibleVersionDownloadService()
    {
        _httpClient = new HttpClient();
    }
    
    /// <summary>
    /// ä¸‹è½½åœ£ç»ç‰ˆæœ¬æ•°æ®åº“
    /// </summary>
    public async Task<bool> DownloadVersionAsync(
        string versionId, 
        IProgress<DownloadProgress> progress = null)
    {
        var versionInfo = BibleVersionConfig.GetVersion(versionId);
        if (versionInfo == null)
            return false;
        
        var url = $"{DownloadBaseUrl}{versionInfo.DatabaseFileName}";
        var localPath = Path.Combine(
            AppDomain.CurrentDomain.BaseDirectory,
            "data", "assets", versionInfo.DatabaseFileName);
        
        try
        {
            using var response = await _httpClient.GetAsync(url, HttpCompletionOption.ResponseHeadersRead);
            response.EnsureSuccessStatusCode();
            
            var totalBytes = response.Content.Headers.ContentLength ?? -1L;
            var canReportProgress = totalBytes != -1 && progress != null;
            
            using var contentStream = await response.Content.ReadAsStreamAsync();
            using var fileStream = new FileStream(localPath, FileMode.Create, FileAccess.Write, FileShare.None, 8192, true);
            
            var buffer = new byte[8192];
            long totalRead = 0;
            int bytesRead;
            
            while ((bytesRead = await contentStream.ReadAsync(buffer, 0, buffer.Length)) > 0)
            {
                await fileStream.WriteAsync(buffer, 0, bytesRead);
                totalRead += bytesRead;
                
                if (canReportProgress)
                {
                    progress.Report(new DownloadProgress
                    {
                        BytesReceived = totalRead,
                        TotalBytes = totalBytes,
                        ProgressPercentage = (int)((totalRead * 100) / totalBytes)
                    });
                }
            }
            
            versionInfo.IsInstalled = true;
            return true;
        }
        catch (Exception ex)
        {
            #if DEBUG
            Debug.WriteLine($"[ä¸‹è½½æœåŠ¡] ä¸‹è½½å¤±è´¥: {ex.Message}");
            #endif
            
            // åˆ é™¤ä¸å®Œæ•´çš„æ–‡ä»¶
            if (File.Exists(localPath))
            {
                File.Delete(localPath);
            }
            
            return false;
        }
    }
}

/// <summary>
/// ä¸‹è½½è¿›åº¦ä¿¡æ¯
/// </summary>
public class DownloadProgress
{
    public long BytesReceived { get; set; }
    public long TotalBytes { get; set; }
    public int ProgressPercentage { get; set; }
}
```

---

## âœ… å®æ–½æ¸…å•

### é˜¶æ®µä¸€ï¼šåŸºç¡€æ¶æ„ï¼ˆ2å¤©ï¼‰
- [ ] åˆ›å»º `BibleVersionInfo` æ¨¡å‹
- [ ] åˆ›å»º `BibleVersionConfig` é™æ€é…ç½®ç±»
- [ ] åˆ›å»º `IBibleDataService` æ¥å£
- [ ] åˆ›å»º `BibleDataServiceBase` æŠ½è±¡åŸºç±»
- [ ] åˆ›å»º `CuvBibleService` å®ç°ç±»

### é˜¶æ®µäºŒï¼šç‰ˆæœ¬ç®¡ç†å™¨ï¼ˆ1å¤©ï¼‰
- [ ] åˆ›å»º `BibleVersionManager` ç±»
- [ ] å®ç°ç‰ˆæœ¬åˆ‡æ¢åŠŸèƒ½
- [ ] å®ç°ç‰ˆæœ¬å¯¹ç…§åŠŸèƒ½
- [ ] åœ¨ä¾èµ–æ³¨å…¥ä¸­æ³¨å†ŒæœåŠ¡

### é˜¶æ®µä¸‰ï¼šUI æ‰©å±•ï¼ˆ2å¤©ï¼‰
- [ ] æ·»åŠ ç‰ˆæœ¬é€‰æ‹©å™¨æŒ‰é’®å’Œèœå•
- [ ] åˆ›å»ºç‰ˆæœ¬ç®¡ç†çª—å£
- [ ] å®ç°ç‰ˆæœ¬å¯¹ç…§æ˜¾ç¤ºUI
- [ ] å®ç°ç‰ˆæœ¬åˆ‡æ¢çš„UIäº¤äº’

### é˜¶æ®µå››ï¼šå…¶ä»–ç‰ˆæœ¬å®ç°ï¼ˆæŒ‰éœ€ï¼‰
- [ ] å®ç° `CnvBibleService`ï¼ˆæ–°è¯‘æœ¬ï¼‰
- [ ] å®ç° `LzzBibleService`ï¼ˆå•æŒ¯ä¸­è¯‘æœ¬ï¼‰
- [ ] å®ç° `KjvBibleService`ï¼ˆKJVï¼‰
- [ ] å®ç°å…¶ä»–ç‰ˆæœ¬...

### é˜¶æ®µäº”ï¼šä¸‹è½½åŠŸèƒ½ï¼ˆå¯é€‰ï¼Œ1å¤©ï¼‰
- [ ] åˆ›å»ºä¸‹è½½æœåŠ¡
- [ ] å®ç°ä¸‹è½½è¿›åº¦æ˜¾ç¤º
- [ ] å®ç°ç‰ˆæœ¬å®‰è£…åŠŸèƒ½

### é˜¶æ®µå…­ï¼šæµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ1å¤©ï¼‰
- [ ] ç‰ˆæœ¬åˆ‡æ¢æµ‹è¯•
- [ ] å¤šç‰ˆæœ¬å¯¹ç…§æµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜æµ‹è¯•
- [ ] é”™è¯¯å¤„ç†æµ‹è¯•

---

## ğŸ“š ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ç”¨æ³•

```csharp
// åœ¨ MainWindow.cs ä¸­åˆå§‹åŒ–
private BibleVersionManager _versionManager;

private void InitializeBibleVersionManager()
{
    _versionManager = App.GetRequiredService<BibleVersionManager>();
    
    // æ‰«æå·²å®‰è£…ç‰ˆæœ¬
    await _versionManager.ScanInstalledVersionsAsync();
    
    // è·å–å½“å‰ç‰ˆæœ¬
    var currentVersion = _versionManager.CurrentVersionInfo;
    Debug.WriteLine($"å½“å‰ç‰ˆæœ¬: {currentVersion.ShortName}");
}

// è·å–ç»æ–‡ï¼ˆä½¿ç”¨å½“å‰ç‰ˆæœ¬ï¼‰
private async Task LoadVerseAsync(int book, int chapter, int verse)
{
    var verseData = await _versionManager.CurrentService
        .GetVerseAsync(book, chapter, verse);
    
    // æ˜¾ç¤ºç»æ–‡...
}

// åˆ‡æ¢ç‰ˆæœ¬
private async Task SwitchToNewVersion()
{
    var success = await _versionManager.SwitchVersionAsync("cnv");
    if (success)
    {
        // é‡æ–°åŠ è½½å½“å‰å†…å®¹
        await ReloadCurrentContent();
    }
}

// ç‰ˆæœ¬å¯¹ç…§
private async Task ShowVersionComparison()
{
    var versions = new List<string> { "cuv", "cnv", "lzz" };
    var comparison = await _versionManager.GetVerseComparisonAsync(
        1, 1, 1, versions);
    
    // æ˜¾ç¤ºå¯¹ç…§ç»“æœ...
    foreach (var (versionId, verse) in comparison)
    {
        Debug.WriteLine($"{versionId}: {verse.Scripture}");
    }
}
```

---

## ğŸ“ æ€»ç»“

è¿™ä»½è®¾è®¡æ–‡æ¡£æä¾›äº†ï¼š

1. âœ… **ç»Ÿä¸€çš„æ¥å£è®¾è®¡** - æ‰€æœ‰ç‰ˆæœ¬ä½¿ç”¨ç›¸åŒçš„API
2. âœ… **çµæ´»çš„æ‰©å±•æ€§** - æ˜“äºæ·»åŠ æ–°ç‰ˆæœ¬
3. âœ… **é«˜æ€§èƒ½ç¼“å­˜** - å¤šçº§ç¼“å­˜ç­–ç•¥
4. âœ… **ç‰ˆæœ¬ç®¡ç†å™¨** - é›†ä¸­ç®¡ç†æ‰€æœ‰ç‰ˆæœ¬
5. âœ… **ç‰ˆæœ¬å¯¹ç…§åŠŸèƒ½** - æ”¯æŒå¤šç‰ˆæœ¬å¹¶æ’æ˜¾ç¤º
6. âœ… **ä¸‹è½½å®‰è£…åŠŸèƒ½** - å¯é€‰çš„ç‰ˆæœ¬ä¸‹è½½
7. âœ… **å®Œæ•´çš„ä»£ç ç¤ºä¾‹** - æ‰€æœ‰å…³é”®ç»„ä»¶çš„å®ç°

é€šè¿‡è¿™ä¸ªè®¾è®¡ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ°ï¼š
- æ·»åŠ æ–°çš„åœ£ç»ç‰ˆæœ¬ï¼ˆåªéœ€å®ç°ä¸€ä¸ªServiceç±»ï¼‰
- åˆ‡æ¢ä¸åŒç‰ˆæœ¬ï¼ˆä¸€è¡Œä»£ç ï¼‰
- å¯¹ç…§å¤šä¸ªç‰ˆæœ¬ï¼ˆå¹¶æ’æ˜¾ç¤ºï¼‰
- ç®¡ç†å·²å®‰è£…çš„ç‰ˆæœ¬ï¼ˆç»Ÿä¸€ç•Œé¢ï¼‰

---

**åˆ›å»ºè€…**: AI Assistant  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-05

---

**ç¥å¼€å‘é¡ºåˆ©ï¼ğŸš€**

