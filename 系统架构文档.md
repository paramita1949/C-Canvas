# Canvas Cast ç³»ç»Ÿæ¶æ„æ–‡æ¡£

> **ç‰ˆæœ¬**ï¼š2.5.5  
> **æŠ€æœ¯æ ˆ**ï¼šWPF + .NET 8.0 + Entity Framework Core + SQLite  
> **é¡¹ç›®ç±»å‹**ï¼šä¸“ä¸šå›¾ç‰‡æµè§ˆä¸ç®¡ç†å·¥å…·  
> **æ–‡æ¡£ç”Ÿæˆæ—¶é—´**ï¼š2025-10-13

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
4. [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
5. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
6. [æœåŠ¡å±‚æ¶æ„](#æœåŠ¡å±‚æ¶æ„)
7. [ä¸šåŠ¡é€»è¾‘æµç¨‹](#ä¸šåŠ¡é€»è¾‘æµç¨‹)
8. [è°ƒç”¨å…³ç³»å›¾](#è°ƒç”¨å…³ç³»å›¾)
9. [æ‰©å±•æŒ‡å—](#æ‰©å±•æŒ‡å—)

---

## ğŸ“Œ é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®å®šä½

**Canvas Cast** æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ WPF æ¡Œé¢åº”ç”¨ç¨‹åºï¼Œä¸»è¦ç”¨äºï¼š
- **å›¾ç‰‡æµè§ˆå’Œç®¡ç†**ï¼šæ”¯æŒå¤§é‡å›¾ç‰‡çš„å¿«é€Ÿæµè§ˆå’Œç»„ç»‡
- **å…³é”®å¸§æ’­æ”¾**ï¼šæ”¯æŒå›¾ç‰‡åºåˆ—çš„å…³é”®å¸§å½•åˆ¶å’Œè‡ªåŠ¨æ’­æ”¾
- **åŸå›¾æ¨¡å¼**ï¼šæ”¯æŒç›¸ä¼¼å›¾ç‰‡çš„æ™ºèƒ½åˆ‡æ¢å’Œæ—¶é—´ç®¡ç†
- **æŠ•å½±åŠŸèƒ½**ï¼šæ”¯æŒå¤šå±å¹•æŠ•å½±æ˜¾ç¤º
- **è§†é¢‘æ’­æ”¾**ï¼šé›†æˆLibVLCæ”¯æŒè§†é¢‘åª’ä½“æ’­æ”¾
- **GPUåŠ é€Ÿ**ï¼šä½¿ç”¨ComputeSharpå®ç°é«˜æ€§èƒ½å›¾åƒå¤„ç†

### 1.2 æ ¸å¿ƒç‰¹æ€§

| åŠŸèƒ½æ¨¡å— | æè¿° | æŠ€æœ¯å®ç° |
|---------|------|---------|
| **å…³é”®å¸§æ¨¡å¼** | è®°å½•å›¾ç‰‡æµè§ˆåºåˆ—ï¼Œæ”¯æŒè‡ªåŠ¨æ’­æ”¾å’Œå¾ªç¯ | KeyframePlaybackService + KeyframeRecordingService |
| **åŸå›¾æ¨¡å¼** | æ™ºèƒ½è¯†åˆ«ç›¸ä¼¼å›¾ç‰‡ï¼Œè‡ªåŠ¨åˆ‡æ¢æ’­æ”¾ | OriginalPlaybackService + OriginalRecordingService |
| **æ—¶é—´ç®¡ç†** | æ”¯æŒæš‚åœæ—¶é—´ç´¯åŠ ã€æ‰‹åŠ¨è·³è½¬æ—¶é—´ä¿®æ­£ | PauseTimeAccumulator + å®æ—¶æ—¶é—´è®¡ç®— |
| **å¤šå±æŠ•å½±** | æ”¯æŒå°†å›¾ç‰‡æŠ•å½±åˆ°ç¬¬äºŒå±å¹• | ProjectionManager + WPFå¤šçª—å£ |
| **GPUå¤„ç†** | GPUåŠ é€Ÿçš„å›¾åƒæ¸²æŸ“å’Œè‰²å½©å¤„ç† | ComputeSharp + Direct2D |
| **æ•°æ®æŒä¹…åŒ–** | SQLiteæ•°æ®åº“å­˜å‚¨æ‰€æœ‰é…ç½®å’Œè®°å½• | Entity Framework Core |

### 1.3 ä¾èµ–åŒ…

```xml
<!-- æ ¸å¿ƒæ¡†æ¶ -->
<PackageReference Include="Microsoft.NETCore.App" Version="8.0" />

<!-- UIæ¡†æ¶ -->
<PackageReference Include="MaterialDesignThemes" Version="5.1.0" />
<PackageReference Include="MaterialDesignColors" Version="3.1.0" />

<!-- æ•°æ®åº“ -->
<PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" Version="8.0.0" />
<PackageReference Include="EFCore.BulkExtensions" Version="8.1.1" />

<!-- å›¾åƒå¤„ç† -->
<PackageReference Include="SixLabors.ImageSharp" Version="3.1.7" />
<PackageReference Include="ComputeSharp" Version="3.2.0" />

<!-- è§†é¢‘æ’­æ”¾ -->
<PackageReference Include="LibVLCSharp" Version="3.8.5" />
<PackageReference Include="VideoLAN.LibVLC.Windows" Version="3.0.20" />

<!-- ä¾èµ–æ³¨å…¥ -->
<PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="8.0.0" />
<PackageReference Include="CommunityToolkit.Mvvm" Version="8.2.2" />
```

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Presentation Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  MainWindow  â”‚  â”‚  ViewModels  â”‚  â”‚   Controls   â”‚      â”‚
â”‚  â”‚   (XAML)     â”‚  â”‚    (MVVM)    â”‚  â”‚ (ScriptEdit) â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Business Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Managers   â”‚  â”‚  Services   â”‚  â”‚ Algorithms  â”‚         â”‚
â”‚  â”‚ (ä¸šåŠ¡ç®¡ç†å™¨) â”‚  â”‚ (æ’­æ”¾/å½•åˆ¶)  â”‚  â”‚ (ç®—æ³•é€»è¾‘)  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Data Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚Repositories â”‚  â”‚  DbContext  â”‚  â”‚   Models    â”‚         â”‚
â”‚  â”‚ (æ•°æ®è®¿é—®)   â”‚  â”‚    (EF)     â”‚  â”‚  (å®ä½“)     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  SQLite æ•°æ®åº“  â”‚
                    â”‚  pyimages.db   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è®¾è®¡æ¨¡å¼

| æ¨¡å¼ | åº”ç”¨åœºæ™¯ | å®ç°ä½ç½® |
|-----|---------|---------|
| **MVVM** | UIå±‚ä¸ä¸šåŠ¡å±‚åˆ†ç¦» | ViewModels + MainWindow |
| **Repository** | æ•°æ®è®¿é—®æŠ½è±¡ | Repositories/ |
| **Factory** | æœåŠ¡åˆ›å»ºå’Œç®¡ç† | PlaybackServiceFactory |
| **Dependency Injection** | ä¾èµ–æ³¨å…¥å’Œæ§åˆ¶åè½¬ | ServiceCollectionExtensions |
| **State Machine** | æ’­æ”¾çŠ¶æ€ç®¡ç† | PlaybackStateMachine |
| **Strategy** | ä¸åŒæ’­æ”¾æ¨¡å¼åˆ‡æ¢ | IPlaybackServiceæ¥å£ |
| **Observer** | äº‹ä»¶é©±åŠ¨é€šä¿¡ | Eventäº‹ä»¶ç³»ç»Ÿ |

### 2.3 æ¶æ„åŸåˆ™

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
2. **ä¾èµ–å€’ç½®**ï¼šé«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼Œéƒ½ä¾èµ–æŠ½è±¡
3. **æ¥å£éš”ç¦»**ï¼šä½¿ç”¨æ¥å£å®šä¹‰æœåŠ¡å¥‘çº¦
4. **å¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­

---

## ğŸ“ ç›®å½•ç»“æ„

### 3.1 C# é¡¹ç›®ç»“æ„

```
CCanvas/
â”œâ”€â”€ App.xaml / App.xaml.cs           # åº”ç”¨ç¨‹åºå…¥å£
â”œâ”€â”€ Core/                            # æ ¸å¿ƒåŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ ConfigManager.cs             # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ Constants.cs                 # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ GPUProcessor.cs              # GPUå¤„ç†å™¨
â”‚   â”œâ”€â”€ ImageProcessor.cs            # å›¾åƒå¤„ç†
â”‚   â””â”€â”€ ServiceCollectionExtensions.cs # DIæ³¨å†Œ
â”œâ”€â”€ Database/                        # æ•°æ®åº“å±‚
â”‚   â”œâ”€â”€ CanvasDbContext.cs           # EF Coreä¸Šä¸‹æ–‡
â”‚   â”œâ”€â”€ DatabaseManager.cs           # æ•°æ®åº“ç®¡ç†å™¨
â”‚   â””â”€â”€ Models/                      # æ•°æ®æ¨¡å‹
â”‚       â”œâ”€â”€ DTOs/                    # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚       â”‚   â”œâ”€â”€ KeyframeSequenceDto.cs
â”‚       â”‚   â”œâ”€â”€ OriginalTimingSequenceDto.cs
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ Enums/                   # æšä¸¾ç±»å‹
â”‚       â”‚   â”œâ”€â”€ PlaybackMode.cs      # æ’­æ”¾æ¨¡å¼
â”‚       â”‚   â”œâ”€â”€ PlaybackStatus.cs    # æ’­æ”¾çŠ¶æ€
â”‚       â”‚   â”œâ”€â”€ LocationType.cs      # ä½ç½®ç±»å‹
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ Folder.cs                # æ–‡ä»¶å¤¹å®ä½“
â”‚       â”œâ”€â”€ MediaFile.cs             # åª’ä½“æ–‡ä»¶å®ä½“
â”‚       â”œâ”€â”€ Keyframe.cs              # å…³é”®å¸§å®ä½“
â”‚       â”œâ”€â”€ KeyframeTiming.cs        # å…³é”®å¸§æ—¶é—´è®°å½•
â”‚       â”œâ”€â”€ OriginalMark.cs          # åŸå›¾æ ‡è®°
â”‚       â”œâ”€â”€ OriginalModeTiming.cs    # åŸå›¾æ—¶é—´è®°å½•
â”‚       â””â”€â”€ Setting.cs               # è®¾ç½®å®ä½“
â”œâ”€â”€ Repositories/                    # ä»“å‚¨å±‚
â”‚   â”œâ”€â”€ Interfaces/                  # ä»“å‚¨æ¥å£
â”‚   â”‚   â”œâ”€â”€ IRepository.cs
â”‚   â”‚   â”œâ”€â”€ IKeyframeRepository.cs
â”‚   â”‚   â”œâ”€â”€ ITimingRepository.cs
â”‚   â”‚   â”œâ”€â”€ IOriginalModeRepository.cs
â”‚   â”‚   â””â”€â”€ IMediaFileRepository.cs
â”‚   â””â”€â”€ Implementations/             # ä»“å‚¨å®ç°
â”‚       â”œâ”€â”€ RepositoryBase.cs        # ä»“å‚¨åŸºç±»
â”‚       â”œâ”€â”€ KeyframeRepositoryImpl.cs
â”‚       â”œâ”€â”€ TimingRepository.cs
â”‚       â”œâ”€â”€ OriginalModeRepositoryImpl.cs
â”‚       â””â”€â”€ MediaFileRepositoryImpl.cs
â”œâ”€â”€ Services/                        # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ Interfaces/                  # æœåŠ¡æ¥å£
â”‚   â”‚   â”œâ”€â”€ IPlaybackService.cs      # æ’­æ”¾æœåŠ¡æ¥å£
â”‚   â”‚   â”œâ”€â”€ IRecordingService.cs     # å½•åˆ¶æœåŠ¡æ¥å£
â”‚   â”‚   â””â”€â”€ ICountdownService.cs     # å€’è®¡æ—¶æœåŠ¡æ¥å£
â”‚   â”œâ”€â”€ Implementations/             # æœåŠ¡å®ç°
â”‚   â”‚   â”œâ”€â”€ KeyframePlaybackService.cs    # å…³é”®å¸§æ’­æ”¾
â”‚   â”‚   â”œâ”€â”€ KeyframeRecordingService.cs   # å…³é”®å¸§å½•åˆ¶
â”‚   â”‚   â”œâ”€â”€ OriginalPlaybackService.cs    # åŸå›¾æ’­æ”¾
â”‚   â”‚   â”œâ”€â”€ OriginalRecordingService.cs   # åŸå›¾å½•åˆ¶
â”‚   â”‚   â””â”€â”€ CountdownService.cs           # å€’è®¡æ—¶æœåŠ¡
â”‚   â”œâ”€â”€ Algorithms/                  # ç®—æ³•æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ PauseTimeAccumulator.cs  # æš‚åœæ—¶é—´ç´¯åŠ 
â”‚   â”‚   â”œâ”€â”€ PlayCountJudge.cs        # æ’­æ”¾æ¬¡æ•°åˆ¤æ–­
â”‚   â”‚   â””â”€â”€ SmartJumpDecider.cs      # æ™ºèƒ½è·³è½¬å†³ç­–
â”‚   â”œâ”€â”€ StateMachine/                # çŠ¶æ€æœº
â”‚   â”‚   â””â”€â”€ PlaybackStateMachine.cs  # æ’­æ”¾çŠ¶æ€æœº
â”‚   â””â”€â”€ PlaybackServiceFactory.cs    # æœåŠ¡å·¥å‚
â”œâ”€â”€ Managers/                        # ä¸šåŠ¡ç®¡ç†å™¨
â”‚   â”œâ”€â”€ Keyframes/                   # å…³é”®å¸§ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ KeyframeManager.cs       # å…³é”®å¸§ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ KeyframeNavigator.cs     # å…³é”®å¸§å¯¼èˆª
â”‚   â”‚   â””â”€â”€ KeyframeRepository.cs    # å…³é”®å¸§ä»“å‚¨(æ—§)
â”‚   â”œâ”€â”€ ImportManager.cs             # å¯¼å…¥ç®¡ç†å™¨
â”‚   â”œâ”€â”€ OriginalManager.cs           # åŸå›¾ç®¡ç†å™¨
â”‚   â”œâ”€â”€ ProjectionManager.cs         # æŠ•å½±ç®¡ç†å™¨
â”‚   â”œâ”€â”€ SearchManager.cs             # æœç´¢ç®¡ç†å™¨
â”‚   â”œâ”€â”€ SortManager.cs               # æ’åºç®¡ç†å™¨
â”‚   â”œâ”€â”€ VideoPlayerManager.cs        # è§†é¢‘æ’­æ”¾å™¨ç®¡ç†
â”‚   â””â”€â”€ ImageSaveManager.cs          # å›¾ç‰‡ä¿å­˜ç®¡ç†
â”œâ”€â”€ ViewModels/                      # è§†å›¾æ¨¡å‹
â”‚   â”œâ”€â”€ ViewModelBase.cs             # ViewModelåŸºç±»
â”‚   â””â”€â”€ PlaybackControlViewModel.cs # æ’­æ”¾æ§åˆ¶ViewModel
â”œâ”€â”€ UI/                              # ç”¨æˆ·ç•Œé¢
â”‚   â”œâ”€â”€ MainWindow.xaml              # ä¸»çª—å£ç•Œé¢
â”‚   â”œâ”€â”€ MainWindow.xaml.cs           # ä¸»çª—å£é€»è¾‘
â”‚   â”œâ”€â”€ MainWindow.Keyframe.cs       # å…³é”®å¸§æ¨¡å¼æ‰©å±•
â”‚   â”œâ”€â”€ MainWindow.Original.cs       # åŸå›¾æ¨¡å¼æ‰©å±•
â”‚   â”œâ”€â”€ ScriptEditWindow.xaml        # è„šæœ¬ç¼–è¾‘çª—å£
â”‚   â””â”€â”€ ScriptEditWindow.xaml.cs     # è„šæœ¬ç¼–è¾‘é€»è¾‘
â””â”€â”€ Utils/                           # å·¥å…·ç±»
    â”œâ”€â”€ Logger.cs                    # æ—¥å¿—å·¥å…·
    â”œâ”€â”€ ImageCache.cs                # å›¾ç‰‡ç¼“å­˜
    â”œâ”€â”€ AnimationHelper.cs           # åŠ¨ç”»è¾…åŠ©
    â””â”€â”€ EasingFunctions.cs           # ç¼“åŠ¨å‡½æ•°
```

### 3.2 Python å‚è€ƒé¡¹ç›®ï¼ˆCanvas/ï¼‰

```
Canvas/                              # Pythonç‰ˆæœ¬å‚è€ƒä»£ç 
â”œâ”€â”€ main.py                          # ä¸»å…¥å£
â”œâ”€â”€ config/                          # é…ç½®æ¨¡å—
â”œâ”€â”€ core/                            # æ ¸å¿ƒåŠŸèƒ½
â”œâ”€â”€ database/                        # æ•°æ®åº“ç®¡ç†
â”œâ”€â”€ keyframes/                       # å…³é”®å¸§åŠŸèƒ½
â”œâ”€â”€ managers/                        # ä¸šåŠ¡ç®¡ç†å™¨
â”œâ”€â”€ playback/                        # æ’­æ”¾æ§åˆ¶
â”‚   â”œâ”€â”€ keytime.py                   # å…³é”®å¸§å’ŒåŸå›¾æ’­æ”¾é€»è¾‘
â”‚   â””â”€â”€ playback_controller.py       # æ’­æ”¾æ§åˆ¶å™¨
â”œâ”€â”€ projection/                      # æŠ•å½±åŠŸèƒ½
â”œâ”€â”€ ui/                              # UIç»„ä»¶
â””â”€â”€ palysdocs/                       # é€»è¾‘åˆ†ææ–‡æ¡£
    â”œâ”€â”€ LOGIC_ANALYSIS_03_å…³é”®å¸§æ¨¡å¼é€»è¾‘.md
    â”œâ”€â”€ LOGIC_ANALYSIS_04_åŸå›¾æ¨¡å¼é€»è¾‘.md
    â””â”€â”€ LOGIC_ANALYSIS_05_æŒ‰é’®é€»è¾‘æµç¨‹.md
```

---

## ğŸ¯ æ ¸å¿ƒæ¨¡å—

### 4.1 åº”ç”¨ç¨‹åºå…¥å£ï¼ˆApp.xaml.csï¼‰

**èŒè´£**ï¼š
- åº”ç”¨ç¨‹åºç”Ÿå‘½å‘¨æœŸç®¡ç†
- ä¾èµ–æ³¨å…¥å®¹å™¨åˆå§‹åŒ–
- å…¨å±€å¼‚å¸¸å¤„ç†
- æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–

**å…³é”®ä»£ç **ï¼š
```csharp
public partial class App : System.Windows.Application
{
    public static IServiceProvider ServiceProvider { get; private set; }
    
    protected override void OnStartup(StartupEventArgs e)
    {
        // 1. åˆå§‹åŒ–æ—¥å¿—
        Logger.Initialize();
        
        // 2. é…ç½®ä¾èµ–æ³¨å…¥
        var services = new ServiceCollection();
        ConfigureServices(services);
        ServiceProvider = services.BuildServiceProvider();
        
        // 3. å…¨å±€å¼‚å¸¸å¤„ç†
        AppDomain.CurrentDomain.UnhandledException += OnUnhandledException;
        DispatcherUnhandledException += OnDispatcherUnhandledException;
    }
}
```

**è°ƒç”¨å…³ç³»**ï¼š
```
App.OnStartup()
  â””â”€> ServiceCollectionExtensions.AddCanvasCastServices()
       â”œâ”€> AddDatabase()          # æ³¨å†Œæ•°æ®åº“æœåŠ¡
       â”œâ”€> AddRepositories()      # æ³¨å†Œä»“å‚¨å±‚
       â”œâ”€> AddCoreServices()      # æ³¨å†Œæ ¸å¿ƒæœåŠ¡
       â”œâ”€> AddManagers()          # æ³¨å†Œç®¡ç†å™¨
       â””â”€> AddViewModels()        # æ³¨å†ŒViewModel
```

---

### 4.2 æ•°æ®åº“å±‚ï¼ˆDatabase/ï¼‰

#### 4.2.1 CanvasDbContext

**èŒè´£**ï¼šEntity Framework Coreæ•°æ®åº“ä¸Šä¸‹æ–‡

**ä¸»è¦å®ä½“**ï¼š
| å®ä½“ | è¡¨å | ç”¨é€” |
|-----|------|------|
| `MediaFile` | images | åª’ä½“æ–‡ä»¶ï¼ˆå›¾ç‰‡/è§†é¢‘ï¼‰ |
| `Folder` | folders | æ–‡ä»¶å¤¹ |
| `Keyframe` | keyframes | å…³é”®å¸§è®°å½• |
| `KeyframeTiming` | keyframe_timings | å…³é”®å¸§æ—¶é—´åºåˆ— |
| `OriginalMark` | original_marks | åŸå›¾æ¨¡å¼æ ‡è®° |
| `OriginalModeTiming` | original_mode_timings | åŸå›¾æ—¶é—´åºåˆ— |
| `Setting` | settings | åº”ç”¨è®¾ç½® |
| `ManualSortFolder` | manual_sort_folders | æ‰‹åŠ¨æ’åºæ–‡ä»¶å¤¹ |
| `ImageDisplayLocation` | image_display_locations | å›¾ç‰‡æ˜¾ç¤ºä½ç½® |

**å…³ç³»å›¾**ï¼š
```
Folder (1) â”€â”€< (N) MediaFile
  â”‚                    â”‚
  â”‚                    â”œâ”€â”€< (N) Keyframe
  â”‚                    â”‚       â””â”€â”€< (N) KeyframeTiming
  â”‚                    â”‚
  â”‚                    â””â”€â”€< (N) ImageDisplayLocation
  â”‚
  â””â”€â”€< (1) ManualSortFolder
```

#### 4.2.2 DatabaseManager

**èŒè´£**ï¼šæ•°æ®åº“åˆå§‹åŒ–å’Œè¿ç§»ç®¡ç†

**å…³é”®åŠŸèƒ½**ï¼š
```csharp
public class DatabaseManager
{
    public void InitializeDatabase()
    {
        // 1. ç¡®ä¿æ•°æ®åº“æ–‡ä»¶å­˜åœ¨
        // 2. åˆ›å»ºè¡¨ç»“æ„
        // 3. åˆ›å»ºç´¢å¼•
        // 4. æ‰§è¡Œæ•°æ®è¿ç§»
        // 5. SQLiteæ€§èƒ½ä¼˜åŒ–é…ç½®
    }
}
```

---

### 4.3 ä»“å‚¨å±‚ï¼ˆRepositories/ï¼‰

**è®¾è®¡æ¨¡å¼**ï¼šRepository Pattern + Unit of Work

#### 4.3.1 æ¥å£å®šä¹‰

```csharp
public interface IRepository<T> where T : class
{
    Task<T> GetByIdAsync(int id);
    Task<List<T>> GetAllAsync();
    Task<T> AddAsync(T entity);
    Task UpdateAsync(T entity);
    Task DeleteAsync(int id);
}

public interface IKeyframeRepository : IRepository<Keyframe>
{
    Task<List<Keyframe>> GetKeyframesByImageIdAsync(int imageId);
    Task<int> GetKeyframeCountAsync(int imageId);
    Task DeleteAllKeyframesAsync(int imageId);
}

public interface IOriginalModeRepository
{
    Task<List<OriginalTimingSequenceDto>> GetOriginalTimingSequenceAsync(int baseImageId);
    Task UpdateOriginalDurationAsync(int baseImageId, int similarImageId, double duration);
    Task<bool> HasOriginalTimingDataAsync(int imageId);
}
```

#### 4.3.2 å®ç°ç±»

| å®ç°ç±» | èŒè´£ |
|-------|------|
| `KeyframeRepositoryImpl` | å…³é”®å¸§æ•°æ®è®¿é—® |
| `TimingRepository` | æ—¶é—´è®°å½•æ•°æ®è®¿é—® |
| `OriginalModeRepositoryImpl` | åŸå›¾æ¨¡å¼æ•°æ®è®¿é—® |
| `MediaFileRepositoryImpl` | åª’ä½“æ–‡ä»¶æ•°æ®è®¿é—® |

---

### 4.4 æœåŠ¡å±‚ï¼ˆServices/ï¼‰

#### 4.4.1 æœåŠ¡æ¥å£

```csharp
public interface IPlaybackService
{
    PlaybackMode Mode { get; }
    bool IsPlaying { get; }
    bool IsPaused { get; }
    int PlayCount { get; set; }
    int CompletedPlayCount { get; }
    
    Task StartPlaybackAsync(int imageId, CancellationToken ct);
    Task StopPlaybackAsync();
    Task PausePlaybackAsync();
    Task ResumePlaybackAsync();
    
    event EventHandler<PlaybackProgressEventArgs> ProgressUpdated;
    event EventHandler PlaybackCompleted;
}

public interface IRecordingService
{
    PlaybackMode Mode { get; }
    bool IsRecording { get; }
    
    Task StartRecordingAsync(int imageId);
    Task StopRecordingAsync();
    Task RecordKeyframeAsync(int imageId, double position, int yPosition);
}
```

#### 4.4.2 æœåŠ¡å®ç°

**å…³é”®å¸§æ’­æ”¾æœåŠ¡ï¼ˆKeyframePlaybackServiceï¼‰**

```
åŠŸèƒ½ï¼šæŒ‰é¢„è®¾çš„å…³é”®å¸§åºåˆ—è‡ªåŠ¨æ’­æ”¾
é€»è¾‘ï¼š
  1. åŠ è½½å…³é”®å¸§åºåˆ—
  2. æŒ‰é¡ºåºè·³è½¬åˆ°æ¯ä¸ªå…³é”®å¸§
  3. ç­‰å¾…æŒ‡å®šæ—¶é—´
  4. å¾ªç¯æ’­æ”¾æŒ‡å®šæ¬¡æ•°
  5. æ”¯æŒæš‚åœ/ç»§ç»­
```

**åŸå›¾æ’­æ”¾æœåŠ¡ï¼ˆOriginalPlaybackServiceï¼‰**

```
åŠŸèƒ½ï¼šåœ¨ç›¸ä¼¼å›¾ç‰‡ä¹‹é—´æ™ºèƒ½åˆ‡æ¢
æ ¸å¿ƒç‰¹æ€§ï¼š
  1. åŠ è½½æ—¶é—´åºåˆ—ï¼ˆFromImageId -> ToImageId, Durationï¼‰
  2. ç¬¬ä¸€å¸§ç‰¹æ®Šå¤„ç†ï¼šæ˜¾ç¤ºFromImageIdï¼Œç­‰å¾…Durationï¼Œåˆ‡æ¢åˆ°ToImageId
  3. æ™®é€šå¸§ï¼šå·²åœ¨FromImageIdï¼Œç­‰å¾…Durationï¼Œåˆ‡æ¢åˆ°ToImageId
  4. æœ€åä¸€å¸§å¾ªç¯ä¼˜åŒ–ï¼šå¦‚æœToImageIdæ˜¯ç¬¬ä¸€å¼ å›¾ï¼Œè·³è¿‡é‡å¤åˆ‡æ¢
  5. æš‚åœæ—¶é—´ç´¯åŠ ï¼šæš‚åœæœŸé—´å¢åŠ çš„æ—¶é—´ç´¯åŠ åˆ°Duration
  6. æ‰‹åŠ¨è·³è½¬æ—¶é—´ä¿®æ­£ï¼šè®°å½•å®é™…åœç•™æ—¶é—´å¹¶æ›´æ–°
```

**å‚è€ƒPythonå®ç°**ï¼š
- `Canvas/playback/keytime.py` è¡Œ1708-1828ï¼ˆæ’­æ”¾é€»è¾‘ï¼‰
- `Canvas/playback/keytime.py` è¡Œ1546-1634ï¼ˆæš‚åœæ—¶é—´ç´¯åŠ ï¼‰
- `Canvas/playback/keytime.py` è¡Œ834-875ï¼ˆæ‰‹åŠ¨æ—¶é—´ä¿®æ­£ï¼‰

#### 4.4.3 æœåŠ¡å·¥å‚ï¼ˆPlaybackServiceFactoryï¼‰

```csharp
public class PlaybackServiceFactory
{
    public IPlaybackService GetPlaybackService(PlaybackMode mode)
    {
        return mode switch
        {
            PlaybackMode.Keyframe => _keyframePlaybackService,
            PlaybackMode.Original => _originalPlaybackService,
            _ => throw new ArgumentException($"æœªçŸ¥æ’­æ”¾æ¨¡å¼: {mode}")
        };
    }
    
    public IRecordingService GetRecordingService(PlaybackMode mode)
    {
        return mode switch
        {
            PlaybackMode.Keyframe => _keyframeRecordingService,
            PlaybackMode.Original => _originalRecordingService,
            _ => throw new ArgumentException($"æœªçŸ¥æ’­æ”¾æ¨¡å¼: {mode}")
        };
    }
}
```

---

### 4.5 ç®—æ³•æ¨¡å—ï¼ˆServices/Algorithms/ï¼‰

#### 4.5.1 æš‚åœæ—¶é—´ç´¯åŠ ï¼ˆPauseTimeAccumulatorï¼‰

**åŠŸèƒ½**ï¼šè®¡ç®—æš‚åœæœŸé—´ç´¯åŠ çš„æ—¶é—´

```csharp
public static class PauseTimeAccumulator
{
    public static double CalculateFinalTime(
        double pausedElapsed,      // æš‚åœæ—¶å·²æ’­æ”¾çš„æ—¶é—´
        double pauseDuration,      // æœ¬æ¬¡æš‚åœçš„æ—¶é•¿
        double totalPauseDuration) // ç´¯è®¡æš‚åœæ—¶é•¿
    {
        // å…¬å¼ï¼šæœ€ç»ˆæ—¶é—´ = å·²æ’­æ”¾æ—¶é—´ + æ€»æš‚åœæ—¶é•¿
        return pausedElapsed + totalPauseDuration + pauseDuration;
    }
}
```

#### 4.5.2 æ’­æ”¾æ¬¡æ•°åˆ¤æ–­ï¼ˆPlayCountJudgeï¼‰

**åŠŸèƒ½**ï¼šåˆ¤æ–­æ˜¯å¦åº”è¯¥ç»§ç»­æ’­æ”¾

```csharp
public static class PlayCountJudge
{
    public static bool ShouldContinue(int targetCount, int completedCount)
    {
        if (targetCount == -1) return true;  // æ— é™å¾ªç¯
        return completedCount < targetCount;
    }
}
```

#### 4.5.3 æ™ºèƒ½è·³è½¬å†³ç­–ï¼ˆSmartJumpDeciderï¼‰

**åŠŸèƒ½**ï¼šå†³å®šå…³é”®å¸§è·³è½¬æ–¹å¼ï¼ˆç›´æ¥è·³è½¬ vs å¹³æ»‘æ»šåŠ¨ï¼‰

```csharp
public static class SmartJumpDecider
{
    public static bool ShouldUseDirectJump(
        double currentPosition,
        double targetPosition,
        double threshold = 0.3)
    {
        // å¦‚æœè·ç¦»è¶…è¿‡é˜ˆå€¼ï¼Œä½¿ç”¨ç›´æ¥è·³è½¬
        return Math.Abs(targetPosition - currentPosition) > threshold;
    }
}
```

---

### 4.6 çŠ¶æ€æœºï¼ˆStateMachine/ï¼‰

#### 4.6.1 PlaybackStateMachine

**çŠ¶æ€å®šä¹‰**ï¼š
```csharp
public enum PlaybackStatus
{
    Idle,       // ç©ºé—²
    Playing,    // æ’­æ”¾ä¸­
    Paused,     // å·²æš‚åœ
    Recording   // å½•åˆ¶ä¸­
}
```

**çŠ¶æ€è½¬æ¢è§„åˆ™**ï¼š
```
Idle â”€â”€â”
  â†‘    â”‚
  â”‚    â†“
  â”‚  Playing â‡„ Paused
  â”‚    â†“
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Idle â†’ Recording â†’ Idle
```

**å®ç°**ï¼š
```csharp
public class PlaybackStateMachine
{
    private PlaybackStatus _currentStatus = PlaybackStatus.Idle;
    
    public event EventHandler<PlaybackStatus> StatusChanged;
    
    public bool TryTransition(PlaybackStatus newStatus)
    {
        if (!IsValidTransition(_currentStatus, newStatus))
            return false;
            
        _currentStatus = newStatus;
        StatusChanged?.Invoke(this, newStatus);
        return true;
    }
}
```

---

### 4.7 è§†å›¾æ¨¡å‹ï¼ˆViewModels/ï¼‰

#### 4.7.1 PlaybackControlViewModel

**èŒè´£**ï¼š
- ç®¡ç†æ’­æ”¾/å½•åˆ¶çŠ¶æ€
- æä¾›UIå‘½ä»¤ç»‘å®š
- å¤„ç†å€’è®¡æ—¶æ˜¾ç¤º
- åè°ƒæœåŠ¡å±‚è°ƒç”¨

**å…³é”®å±æ€§**ï¼š
```csharp
public partial class PlaybackControlViewModel : ViewModelBase
{
    [ObservableProperty]
    private int _currentImageId;
    
    [ObservableProperty]
    private PlaybackMode _currentMode;
    
    [ObservableProperty]
    private bool _isRecording;
    
    [ObservableProperty]
    private bool _isPlaying;
    
    [ObservableProperty]
    private bool _isPaused;
    
    [ObservableProperty]
    private int _playCount = 5;  // é»˜è®¤æ’­æ”¾5æ¬¡
    
    [ObservableProperty]
    private int _completedPlayCount;
    
    [ObservableProperty]
    private string _countdownText = "--";
}
```

**å…³é”®å‘½ä»¤**ï¼š
```csharp
[RelayCommand]
private async Task ToggleRecordingAsync();

[RelayCommand]
private async Task TogglePlaybackAsync();

[RelayCommand]
private async Task TogglePauseAsync();

[RelayCommand]
private void SetPlayCount(int count);

[RelayCommand]
private async Task ClearTimingDataAsync();
```

**äº‹ä»¶è®¢é˜…**ï¼š
```csharp
// è®¢é˜…æ’­æ”¾æœåŠ¡äº‹ä»¶
playbackService.ProgressUpdated += OnPlaybackProgressUpdated;
playbackService.PlaybackCompleted += OnPlaybackCompleted;

// è®¢é˜…å€’è®¡æ—¶æœåŠ¡
_countdownService.CountdownUpdated += OnCountdownUpdated;
_countdownService.CountdownCompleted += OnCountdownCompleted;
```

---

### 4.8 ä¸»çª—å£ï¼ˆUI/MainWindowï¼‰

#### 4.8.1 æ–‡ä»¶ç»„ç»‡ï¼ˆPartial Classï¼‰

```csharp
MainWindow.xaml.cs         // ä¸»é€»è¾‘å’Œåˆå§‹åŒ–
MainWindow.Keyframe.cs     // å…³é”®å¸§æ¨¡å¼æ‰©å±•
MainWindow.Original.cs     // åŸå›¾æ¨¡å¼æ‰©å±•
```

#### 4.8.2 MainWindow.xaml.cs - æ ¸å¿ƒåŠŸèƒ½

**åˆå§‹åŒ–æµç¨‹**ï¼š
```csharp
public partial class MainWindow : Window
{
    protected override void OnInitialized(EventArgs e)
    {
        base.OnInitialized(e);
        
        // 1. åˆå§‹åŒ–æ’­æ”¾æ§åˆ¶ViewModel
        InitializePlaybackViewModel();
        
        // 2. åˆå§‹åŒ–æ•°æ®åº“
        dbManager = App.GetRequiredService<DatabaseManager>();
        
        // 3. åˆå§‹åŒ–å…³é”®å¸§ç³»ç»Ÿ
        _keyframeManager = new KeyframeManager(...);
        _keyframeNavigator = new KeyframeNavigator(...);
        
        // 4. åˆå§‹åŒ–è§†é¢‘æ’­æ”¾å™¨
        _videoPlayerManager = new VideoPlayerManager(...);
        
        // 5. åŠ è½½é¡¹ç›®æ ‘
        LoadProjectTree();
        
        // 6. åŠ è½½é…ç½®
        LoadSettings();
    }
}
```

**äº‹ä»¶è®¢é˜…**ï¼š
```csharp
private void InitializePlaybackViewModel()
{
    _playbackViewModel = App.GetRequiredService<PlaybackControlViewModel>();
    
    // è®¢é˜…å±æ€§å˜åŒ–
    _playbackViewModel.PropertyChanged += (s, e) => {
        switch (e.PropertyName)
        {
            case "IsRecording":
                BtnRecord.Content = _playbackViewModel.IsRecording ? "â¹ åœæ­¢" : "âº å½•åˆ¶";
                break;
            case "IsPlaying":
                BtnPlay.Content = _playbackViewModel.IsPlaying ? "â¹ åœæ­¢" : "â–¶ æ’­æ”¾";
                break;
            case "PlayCount":
                BtnPlayCount.Content = $"ğŸ”„ {_playbackViewModel.PlayCount}æ¬¡";
                break;
        }
    };
    
    // æ‰‹åŠ¨åˆå§‹åŒ–UIçŠ¶æ€ï¼ˆé¿å…åˆå§‹åŒ–é¡ºåºé—®é¢˜ï¼‰
    Dispatcher.Invoke(() => {
        BtnPlayCount.Content = $"ğŸ”„ {_playbackViewModel.PlayCount}æ¬¡";
    });
}
```

#### 4.8.3 MainWindow.Keyframe.cs - å…³é”®å¸§æ¨¡å¼

**èŒè´£**ï¼šå…³é”®å¸§æ¨¡å¼çš„æ‰€æœ‰ä¸šåŠ¡é€»è¾‘

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```csharp
// è·³è½¬åˆ°å…³é”®å¸§
private async Task JumpToKeyframeAsync(int keyframeId, bool useDirectJump)

// æ·»åŠ å…³é”®å¸§
private async Task AddKeyframeAtCurrentPositionAsync()

// åˆ é™¤å…³é”®å¸§
private async Task DeleteKeyframeAsync(int keyframeId)

// æ›´æ–°å…³é”®å¸§ä½ç½®
private async Task UpdateKeyframePositionAsync(int keyframeId, double newPosition)
```

#### 4.8.4 MainWindow.Original.cs - åŸå›¾æ¨¡å¼

**èŒè´£**ï¼šåŸå›¾æ¨¡å¼çš„æ‰€æœ‰ä¸šåŠ¡é€»è¾‘

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```csharp
// æ£€æŸ¥æ˜¯å¦åº”è¯¥ä½¿ç”¨åŸå›¾æ¨¡å¼
private bool ShouldUseOriginalMode()

// æŸ¥æ‰¾ç›¸ä¼¼å›¾ç‰‡
private List<SimilarImage> FindSimilarImages(int imageId)

// å¼€å§‹åŸå›¾æ’­æ”¾
private async Task StartOriginalModePlaybackAsync()

// åœæ­¢åŸå›¾æ’­æ”¾
private async Task StopOriginalModePlaybackAsync()

// å¤„ç†å›¾ç‰‡åˆ‡æ¢äº‹ä»¶
private void OnOriginalPlaybackSwitchImageRequested(object sender, SwitchImageEventArgs e)

// å¾ªç¯å½•åˆ¶è‡ªåŠ¨å®Œæˆ
private async Task AutoCompleteLoopRecordingAsync()
```

**åŸå›¾æ¨¡å¼æ ¸å¿ƒé€»è¾‘**ï¼š
```csharp
private async Task StartOriginalModePlaybackAsync()
{
    // 1. æ£€æŸ¥æ˜¯å¦æœ‰ç›¸ä¼¼å›¾ç‰‡
    if (!HasSimilarImagesForOriginalMode()) return;
    
    // 2. è·å–æ’­æ”¾æœåŠ¡
    var playbackService = App.GetRequiredService<PlaybackServiceFactory>()
        .GetPlaybackService(PlaybackMode.Original);
    
    // 3. è®¢é˜…å›¾ç‰‡åˆ‡æ¢äº‹ä»¶
    if (playbackService is OriginalPlaybackService originalPlayback)
    {
        originalPlayback.SwitchImageRequested -= OnOriginalPlaybackSwitchImageRequested;
        originalPlayback.SwitchImageRequested += OnOriginalPlaybackSwitchImageRequested;
    }
    
    // 4. ä½¿ç”¨ViewModelå‘½ä»¤å¯åŠ¨æ’­æ”¾
    _playbackViewModel.CurrentImageId = currentImageId;
    _playbackViewModel.CurrentMode = PlaybackMode.Original;
    await _playbackViewModel.StartPlaybackCommand.ExecuteAsync(null);
}
```

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### 5.1 æ•°æ®åº“æ–‡ä»¶

**ä½ç½®**ï¼š`{åº”ç”¨ç¨‹åºç›®å½•}/pyimages.db`  
**ç±»å‹**ï¼šSQLite 3  
**ORM**ï¼šEntity Framework Core 8.0

### 5.2 è¡¨ç»“æ„

#### 5.2.1 MediaFiles (images) - åª’ä½“æ–‡ä»¶è¡¨

```sql
CREATE TABLE MediaFiles (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Name TEXT NOT NULL,                    -- æ–‡ä»¶å
    Path TEXT NOT NULL UNIQUE,             -- æ–‡ä»¶è·¯å¾„
    FolderId INTEGER,                      -- æ‰€å±æ–‡ä»¶å¤¹ID
    FileTypeString TEXT,                   -- æ–‡ä»¶ç±»å‹(Image/Video)
    OrderIndex INTEGER NOT NULL,           -- æ’åºç´¢å¼•
    ThumbnailPath TEXT,                    -- ç¼©ç•¥å›¾è·¯å¾„
    FileSize INTEGER,                      -- æ–‡ä»¶å¤§å°
    Width INTEGER,                         -- å®½åº¦
    Height INTEGER,                        -- é«˜åº¦
    CreatedAt TEXT,                        -- åˆ›å»ºæ—¶é—´
    ModifiedAt TEXT,                       -- ä¿®æ”¹æ—¶é—´
    FOREIGN KEY (FolderId) REFERENCES Folders(Id) ON DELETE SET NULL
);

CREATE INDEX idx_folder_id ON MediaFiles(FolderId);
CREATE INDEX idx_order_images ON MediaFiles(OrderIndex);
CREATE INDEX idx_images_folder_order ON MediaFiles(FolderId, OrderIndex);
```

#### 5.2.2 Keyframes - å…³é”®å¸§è¡¨

```sql
CREATE TABLE Keyframes (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    ImageId INTEGER NOT NULL,              -- å›¾ç‰‡ID
    Position REAL NOT NULL,                -- æ»šåŠ¨ä½ç½®(0-1)
    YPosition INTEGER NOT NULL,            -- Yåæ ‡ä½ç½®
    OrderIndex INTEGER NOT NULL,           -- åºåˆ—é¡ºåº
    LoopCount INTEGER,                     -- å¾ªç¯æ¬¡æ•°
    FOREIGN KEY (ImageId) REFERENCES MediaFiles(Id) ON DELETE CASCADE
);

CREATE INDEX idx_keyframes_image ON Keyframes(ImageId);
CREATE INDEX idx_keyframes_order ON Keyframes(OrderIndex);
```

#### 5.2.3 KeyframeTimings - å…³é”®å¸§æ—¶é—´è®°å½•è¡¨

```sql
CREATE TABLE KeyframeTimings (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    ImageId INTEGER NOT NULL,              -- å›¾ç‰‡ID
    KeyframeId INTEGER NOT NULL,           -- å…³é”®å¸§ID
    SequenceOrder INTEGER NOT NULL,        -- åºåˆ—é¡ºåº
    Duration REAL NOT NULL,                -- åœç•™æ—¶é•¿(ç§’)
    CreatedAt TEXT DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (ImageId) REFERENCES MediaFiles(Id) ON DELETE CASCADE,
    FOREIGN KEY (KeyframeId) REFERENCES Keyframes(Id) ON DELETE CASCADE
);

CREATE INDEX idx_timing_image ON KeyframeTimings(ImageId);
CREATE INDEX idx_timing_sequence ON KeyframeTimings(ImageId, SequenceOrder);
```

#### 5.2.4 OriginalMarks - åŸå›¾æ ‡è®°è¡¨

```sql
CREATE TABLE OriginalMarks (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    ItemTypeString TEXT NOT NULL,          -- é¡¹ç›®ç±»å‹(Folder/File)
    ItemId INTEGER NOT NULL,               -- é¡¹ç›®ID
    BaseImageId INTEGER,                   -- åŸºç¡€å›¾ç‰‡ID
    MarkTypeString TEXT,                   -- æ ‡è®°ç±»å‹
    CreatedAt TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_original_marks ON OriginalMarks(ItemTypeString, ItemId);
```

#### 5.2.5 OriginalModeTimings - åŸå›¾æ—¶é—´åºåˆ—è¡¨

```sql
CREATE TABLE OriginalModeTimings (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    BaseImageId INTEGER NOT NULL,          -- åŸºç¡€å›¾ç‰‡ID
    FromImageId INTEGER NOT NULL,          -- æºå›¾ç‰‡ID
    ToImageId INTEGER NOT NULL,            -- ç›®æ ‡å›¾ç‰‡ID
    SimilarImageId INTEGER NOT NULL,       -- ç›¸ä¼¼å›¾ç‰‡ID
    Duration REAL NOT NULL,                -- åœç•™æ—¶é•¿(ç§’)
    SequenceOrder INTEGER NOT NULL,        -- åºåˆ—é¡ºåº
    SimilarImagePath TEXT,                 -- ç›¸ä¼¼å›¾ç‰‡è·¯å¾„
    CreatedAt TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_original_base ON OriginalModeTimings(BaseImageId);
CREATE INDEX idx_original_sequence ON OriginalModeTimings(BaseImageId, SequenceOrder);
```

#### 5.2.6 Settings - è®¾ç½®è¡¨

```sql
CREATE TABLE Settings (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    Key TEXT NOT NULL UNIQUE,              -- è®¾ç½®é”®
    Value TEXT                             -- è®¾ç½®å€¼
);

-- å¸¸ç”¨è®¾ç½®ï¼š
-- play_count: æ’­æ”¾æ¬¡æ•°(5/-1è¡¨ç¤ºæ— é™å¾ªç¯)
-- target_color: ç›®æ ‡é¢œè‰²
-- zoom_level: ç¼©æ”¾çº§åˆ«
```

### 5.3 æ•°æ®å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Folders   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚
       â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MediaFiles     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ N               â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Keyframes  â”‚   â”‚ ImageDisplayLocations  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KeyframeTimings    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OriginalMarks       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OriginalModeTimings  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ä¸šåŠ¡é€»è¾‘æµç¨‹

### 6.1 å…³é”®å¸§å½•åˆ¶æµç¨‹

```mermaid
sequenceDiagram
    participant U as User
    participant UI as MainWindow
    participant VM as PlaybackControlViewModel
    participant RS as KeyframeRecordingService
    participant KM as KeyframeManager
    participant DB as Database

    U->>UI: ç‚¹å‡»"å½•åˆ¶"æŒ‰é’®
    UI->>VM: ToggleRecordingCommand
    VM->>RS: StartRecordingAsync(imageId)
    RS->>DB: æ¸…é™¤æ—§çš„å…³é”®å¸§æ•°æ®
    RS-->>VM: å½•åˆ¶å·²å¯åŠ¨
    
    loop ç”¨æˆ·æµè§ˆå›¾ç‰‡
        U->>UI: æ»šåŠ¨åˆ°æŸä¸ªä½ç½®
        UI->>KM: RecordKeyframe(imageId, position, yPosition)
        KM->>DB: INSERT INTO Keyframes
    end
    
    U->>UI: ç‚¹å‡»"åœæ­¢å½•åˆ¶"
    UI->>VM: ToggleRecordingCommand
    VM->>RS: StopRecordingAsync()
    RS->>DB: ä¿å­˜æ—¶é—´åºåˆ—
    RS-->>VM: å½•åˆ¶å·²å®Œæˆ
```

### 6.2 å…³é”®å¸§æ’­æ”¾æµç¨‹

```mermaid
sequenceDiagram
    participant U as User
    participant UI as MainWindow
    participant VM as PlaybackControlViewModel
    participant PS as KeyframePlaybackService
    participant DB as Database
    participant CS as CountdownService

    U->>UI: ç‚¹å‡»"æ’­æ”¾"æŒ‰é’®
    UI->>VM: TogglePlaybackCommand
    VM->>PS: StartPlaybackAsync(imageId)
    PS->>DB: åŠ è½½å…³é”®å¸§åºåˆ—
    
    loop æ’­æ”¾å¾ªç¯(PlayCountæ¬¡)
        loop éå†å…³é”®å¸§åºåˆ—
            PS->>UI: JumpToKeyframeRequested(keyframeId)
            UI->>UI: è·³è½¬åˆ°å…³é”®å¸§ä½ç½®
            PS->>VM: ProgressUpdated(currentIndex, remainingTime)
            VM->>CS: Start(duration)
            CS->>VM: CountdownUpdated(æ¯100ms)
            VM->>UI: æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
            PS->>PS: await WaitForDuration(duration)
        end
        PS->>PS: CompletedPlayCount++
    end
    
    PS->>VM: PlaybackCompleted
    VM->>UI: æ¢å¤åˆå§‹çŠ¶æ€
```

### 6.3 åŸå›¾æ¨¡å¼å½•åˆ¶æµç¨‹

```mermaid
sequenceDiagram
    participant U as User
    participant UI as MainWindow.Original
    participant VM as PlaybackControlViewModel
    participant RS as OriginalRecordingService
    participant DB as Database

    U->>UI: ç‚¹å‡»"å½•åˆ¶"(åŸå›¾æ¨¡å¼)
    UI->>VM: ToggleRecordingCommand
    VM->>RS: StartRecordingAsync(baseImageId)
    RS->>DB: æ¸…é™¤æ—§çš„æ—¶é—´åºåˆ—
    RS-->>VM: å½•åˆ¶å·²å¯åŠ¨
    
    loop å¾ªç¯å½•åˆ¶
        U->>UI: åˆ‡æ¢åˆ°ç›¸ä¼¼å›¾ç‰‡
        UI->>RS: RecordSimilarImageSwitch(fromId, toId)
        RS->>RS: è®°å½•æ—¶é—´æˆ³
        RS->>DB: INSERT INTO OriginalModeTimings
    end
    
    Note over UI,RS: æ£€æµ‹åˆ°å¾ªç¯å®Œæˆ(å›åˆ°ç¬¬ä¸€å¼ å›¾)
    UI->>UI: AutoCompleteLoopRecordingAsync()
    UI->>RS: StopRecordingAsync()
    RS->>DB: ä¿å­˜å®Œæ•´åºåˆ—
    RS-->>VM: å½•åˆ¶å·²å®Œæˆ
    UI->>UI: è‡ªåŠ¨å¼€å§‹æ’­æ”¾
```

### 6.4 åŸå›¾æ¨¡å¼æ’­æ”¾æµç¨‹

```mermaid
sequenceDiagram
    participant U as User
    participant UI as MainWindow.Original
    participant VM as PlaybackControlViewModel
    participant PS as OriginalPlaybackService
    participant DB as Database

    U->>UI: ç‚¹å‡»"æ’­æ”¾"(åŸå›¾æ¨¡å¼)
    UI->>UI: StartOriginalModePlaybackAsync()
    UI->>PS: è®¢é˜…SwitchImageRequestedäº‹ä»¶
    UI->>VM: StartPlaybackCommand
    VM->>PS: StartPlaybackAsync(baseImageId)
    PS->>DB: åŠ è½½æ—¶é—´åºåˆ—
    
    loop æ’­æ”¾å¾ªç¯(PlayCountæ¬¡)
        Note over PS: ç¬¬ä¸€å¸§ç‰¹æ®Šå¤„ç†
        PS->>UI: SwitchImageRequested(fromImageId)
        UI->>UI: LoadImage(fromImageId)
        PS->>PS: await WaitForDuration(duration)
        PS->>UI: SwitchImageRequested(toImageId)
        UI->>UI: LoadImage(toImageId)
        
        loop æ™®é€šå¸§
            PS->>VM: ProgressUpdated(currentIndex, duration)
            VM->>UI: æ›´æ–°å€’è®¡æ—¶
            PS->>PS: await WaitForDuration(duration)
            PS->>UI: SwitchImageRequested(toImageId)
            UI->>UI: LoadImage(toImageId)
        end
        
        Note over PS: æœ€åä¸€å¸§ä¼˜åŒ–
        alt toImageId == firstImageId
            PS->>PS: è·³è¿‡é‡å¤åˆ‡æ¢
        else
            PS->>UI: SwitchImageRequested(toImageId)
        end
        
        PS->>PS: CompletedPlayCount++
    end
    
    PS->>VM: PlaybackCompleted
    UI->>UI: StopOriginalModePlaybackAsync()
    UI->>PS: å–æ¶ˆè®¢é˜…äº‹ä»¶
```

### 6.5 æš‚åœæ—¶é—´ç´¯åŠ æµç¨‹

```mermaid
sequenceDiagram
    participant U as User
    participant VM as PlaybackControlViewModel
    participant PS as OriginalPlaybackService
    participant DB as Database

    Note over PS: æ­£åœ¨æ’­æ”¾å›¾ç‰‡2
    PS->>PS: _currentFrameStartTime = now()
    PS->>PS: await WaitForDuration(5s)
    
    U->>VM: ç‚¹å‡»"æš‚åœ"
    VM->>PS: PausePlaybackAsync()
    PS->>PS: _pauseStartTime = elapsed(3.5s)
    PS->>PS: _pauseStartRealTime = now()
    PS->>PS: _stopwatch.Stop()
    
    Note over U,PS: ç”¨æˆ·æ€è€ƒ3ç§’...
    
    U->>VM: ç‚¹å‡»"ç»§ç»­"
    VM->>PS: ResumePlaybackAsync()
    PS->>PS: pauseDuration = now() - _pauseStartRealTime = 3s
    PS->>PS: _totalPauseDuration += 3s
    PS->>PS: finalTime = 3.5s + 3s = 6.5s
    
    PS->>DB: UpdateOriginalDurationAsync(baseId, similarId, 6.5s)
    DB-->>PS: æ›´æ–°æˆåŠŸ
    PS->>PS: é‡æ–°åŠ è½½æ—¶é—´åºåˆ—
    PS->>PS: _skipToNextFrame = true
    PS->>VM: ç«‹å³è·³åˆ°ä¸‹ä¸€å¸§
```

### 6.6 æ‰‹åŠ¨è·³è½¬æ—¶é—´ä¿®æ­£æµç¨‹

```mermaid
sequenceDiagram
    participant U as User
    participant UI as MainWindow
    participant PS as OriginalPlaybackService
    participant DB as Database

    Note over PS: æ­£åœ¨æ’­æ”¾å›¾ç‰‡3ï¼Œå·²æ’­æ”¾2.5ç§’
    PS->>PS: _currentFrameStartTime = T0
    PS->>PS: _currentIndex = 2
    
    U->>UI: æ‰‹åŠ¨åˆ‡æ¢åˆ°å›¾ç‰‡4
    UI->>UI: SwitchSimilarImage(isNext=true)
    UI->>PS: RecordManualSwitchAsync(fromId=3, toId=4)
    
    PS->>PS: actualDuration = now() - T0 = 2.5s
    PS->>PS: currentTiming = _timingSequence[2]
    PS->>PS: correctFromId = currentTiming.FromImageId
    PS->>PS: correctToId = currentTiming.ToImageId
    
    PS->>DB: UpdateTimingDurationAsync(baseId, correctFromId, correctToId, 2.5s)
    DB-->>PS: æ›´æ–°æˆåŠŸ
    
    PS->>PS: UpdateTimingSequenceInMemory(2.5s)
    PS->>PS: _currentFrameStartTime = now()
    PS->>PS: _skipToNextFrame = true
    
    Note over PS: ç«‹å³è·³åˆ°ä¸‹ä¸€å¸§ï¼Œå¯åŠ¨æ–°çš„å€’è®¡æ—¶
```

---

## ğŸ“Š è°ƒç”¨å…³ç³»å›¾

### 7.1 ä¾èµ–æ³¨å…¥æœåŠ¡å…³ç³»

```
App
  â””â”€> ServiceCollectionExtensions.AddCanvasCastServices()
       â”‚
       â”œâ”€> DatabaseManager (Singleton)
       â”‚    â””â”€> CanvasDbContext (Scoped)
       â”‚
       â”œâ”€> Repositories (Scoped)
       â”‚    â”œâ”€> KeyframeRepositoryImpl
       â”‚    â”œâ”€> TimingRepository
       â”‚    â”œâ”€> OriginalModeRepositoryImpl
       â”‚    â””â”€> MediaFileRepositoryImpl
       â”‚
       â”œâ”€> Services (Scoped/Singleton)
       â”‚    â”œâ”€> PlaybackStateMachine (Singleton)
       â”‚    â”œâ”€> CountdownService (Singleton)
       â”‚    â”œâ”€> KeyframePlaybackService (Scoped)
       â”‚    â”œâ”€> KeyframeRecordingService (Scoped)
       â”‚    â”œâ”€> OriginalPlaybackService (Scoped)
       â”‚    â”œâ”€> OriginalRecordingService (Scoped)
       â”‚    â””â”€> PlaybackServiceFactory (Scoped)
       â”‚
       â””â”€> ViewModels (Transient)
            â””â”€> PlaybackControlViewModel
```

### 7.2 æ’­æ”¾ç³»ç»Ÿè°ƒç”¨é“¾

```
MainWindow
  â”‚
  â”œâ”€> PlaybackControlViewModel
  â”‚    â”‚
  â”‚    â”œâ”€> PlaybackServiceFactory
  â”‚    â”‚    â”‚
  â”‚    â”‚    â”œâ”€> KeyframePlaybackService
  â”‚    â”‚    â”‚    â”œâ”€> KeyframeRepository
  â”‚    â”‚    â”‚    â”œâ”€> TimingRepository
  â”‚    â”‚    â”‚    â””â”€> PlayCountJudge
  â”‚    â”‚    â”‚
  â”‚    â”‚    â””â”€> OriginalPlaybackService
  â”‚    â”‚         â”œâ”€> OriginalModeRepository
  â”‚    â”‚         â”œâ”€> PlayCountJudge
  â”‚    â”‚         â””â”€> PauseTimeAccumulator
  â”‚    â”‚
  â”‚    â”œâ”€> CountdownService
  â”‚    â””â”€> PlaybackStateMachine
  â”‚
  â”œâ”€> KeyframeManager
  â”‚    â””â”€> KeyframeRepository
  â”‚
  â””â”€> OriginalManager
       â””â”€> OriginalModeRepository
```

### 7.3 æ•°æ®æµå‘

```
UI Layer (MainWindow)
      â†“ Commands / Events
ViewModel Layer (PlaybackControlViewModel)
      â†“ Service Calls
Service Layer (PlaybackService / RecordingService)
      â†“ Data Access
Repository Layer (IRepository implementations)
      â†“ Entity Framework
Data Layer (CanvasDbContext)
      â†“ SQL
Database (pyimages.db)
```

---

## ğŸš€ æ‰©å±•æŒ‡å—

### 8.1 æ·»åŠ æ–°çš„æ’­æ”¾æ¨¡å¼

**æ­¥éª¤ 1ï¼šå®šä¹‰æšä¸¾**
```csharp
// Database/Models/Enums/PlaybackMode.cs
public enum PlaybackMode
{
    Keyframe = 0,
    Original = 1,
    NewMode = 2  // æ–°å¢
}
```

**æ­¥éª¤ 2ï¼šåˆ›å»ºæœåŠ¡å®ç°**
```csharp
// Services/Implementations/NewModePlaybackService.cs
public class NewModePlaybackService : IPlaybackService
{
    public PlaybackMode Mode => PlaybackMode.NewMode;
    
    public async Task StartPlaybackAsync(int imageId, CancellationToken ct)
    {
        // å®ç°æ’­æ”¾é€»è¾‘
    }
    
    // å®ç°å…¶ä»–æ¥å£æ–¹æ³•...
}
```

**æ­¥éª¤ 3ï¼šæ³¨å†ŒæœåŠ¡**
```csharp
// Core/ServiceCollectionExtensions.cs
services.AddScoped<NewModePlaybackService>();
```

**æ­¥éª¤ 4ï¼šæ›´æ–°å·¥å‚**
```csharp
// Services/PlaybackServiceFactory.cs
public IPlaybackService GetPlaybackService(PlaybackMode mode)
{
    return mode switch
    {
        PlaybackMode.Keyframe => _keyframePlaybackService,
        PlaybackMode.Original => _originalPlaybackService,
        PlaybackMode.NewMode => _newModePlaybackService,  // æ–°å¢
        _ => throw new ArgumentException($"æœªçŸ¥æ’­æ”¾æ¨¡å¼: {mode}")
    };
}
```

**æ­¥éª¤ 5ï¼šUIé›†æˆ**
```csharp
// UI/MainWindow.NewMode.cs (æ–°å»ºpartial class)
public partial class MainWindow
{
    private async Task StartNewModePlaybackAsync()
    {
        var playbackService = App.GetRequiredService<PlaybackServiceFactory>()
            .GetPlaybackService(PlaybackMode.NewMode);
        
        // è®¢é˜…äº‹ä»¶
        playbackService.ProgressUpdated += OnProgressUpdated;
        
        // å¯åŠ¨æ’­æ”¾
        _playbackViewModel.CurrentMode = PlaybackMode.NewMode;
        await _playbackViewModel.StartPlaybackCommand.ExecuteAsync(null);
    }
}
```

---

### 8.2 æ·»åŠ æ–°çš„æ•°æ®å®ä½“

**æ­¥éª¤ 1ï¼šåˆ›å»ºå®ä½“ç±»**
```csharp
// Database/Models/NewEntity.cs
public class NewEntity
{
    public int Id { get; set; }
    public string Name { get; set; }
    public DateTime CreatedAt { get; set; }
}
```

**æ­¥éª¤ 2ï¼šæ·»åŠ åˆ°DbContext**
```csharp
// Database/CanvasDbContext.cs
public DbSet<NewEntity> NewEntities { get; set; }

protected override void OnModelCreating(ModelBuilder modelBuilder)
{
    modelBuilder.Entity<NewEntity>(entity =>
    {
        entity.HasIndex(e => e.Name);
    });
}
```

**æ­¥éª¤ 3ï¼šåˆ›å»ºRepository**
```csharp
// Repositories/Interfaces/INewEntityRepository.cs
public interface INewEntityRepository : IRepository<NewEntity>
{
    Task<List<NewEntity>> GetByNameAsync(string name);
}

// Repositories/Implementations/NewEntityRepositoryImpl.cs
public class NewEntityRepositoryImpl : RepositoryBase<NewEntity>, INewEntityRepository
{
    public async Task<List<NewEntity>> GetByNameAsync(string name)
    {
        return await _dbSet.Where(e => e.Name.Contains(name)).ToListAsync();
    }
}
```

**æ­¥éª¤ 4ï¼šæ³¨å†ŒRepository**
```csharp
// Core/ServiceCollectionExtensions.cs
services.AddScoped<INewEntityRepository, NewEntityRepositoryImpl>();
```

---

### 8.3 æ·»åŠ æ–°çš„ç®—æ³•æ¨¡å—

**æ­¥éª¤ 1ï¼šåˆ›å»ºç®—æ³•ç±»**
```csharp
// Services/Algorithms/NewAlgorithm.cs
public static class NewAlgorithm
{
    public static double Calculate(double input1, double input2)
    {
        // å®ç°ç®—æ³•é€»è¾‘
        return result;
    }
}
```

**æ­¥éª¤ 2ï¼šåœ¨Serviceä¸­ä½¿ç”¨**
```csharp
// Services/Implementations/SomeService.cs
public class SomeService
{
    public void DoSomething()
    {
        var result = NewAlgorithm.Calculate(a, b);
    }
}
```

---

### 8.4 æ·»åŠ æ–°çš„UIåŠŸèƒ½

**æ­¥éª¤ 1ï¼šåˆ›å»ºViewModelï¼ˆå¦‚éœ€è¦ï¼‰**
```csharp
// ViewModels/NewFeatureViewModel.cs
public partial class NewFeatureViewModel : ViewModelBase
{
    [ObservableProperty]
    private string _title;
    
    [RelayCommand]
    private void DoAction()
    {
        // å®ç°åŠŸèƒ½
    }
}
```

**æ­¥éª¤ 2ï¼šåˆ›å»ºWindow/UserControl**
```xaml
<!-- UI/NewFeatureWindow.xaml -->
<Window x:Class="ImageColorChanger.UI.NewFeatureWindow"
        xmlns:vm="clr-namespace:ImageColorChanger.ViewModels">
    <Window.DataContext>
        <vm:NewFeatureViewModel/>
    </Window.DataContext>
    
    <!-- UIå®šä¹‰ -->
</Window>
```

**æ­¥éª¤ 3ï¼šæ³¨å†Œåˆ°DIï¼ˆå¦‚éœ€è¦ï¼‰**
```csharp
// Core/ServiceCollectionExtensions.cs
services.AddTransient<NewFeatureViewModel>();
```

---

### 8.5 æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 8.5.1 æ•°æ®åº“ä¼˜åŒ–

```csharp
// 1. ä½¿ç”¨æ‰¹é‡æ“ä½œ
await _dbContext.BulkInsertAsync(entities);

// 2. ä½¿ç”¨AsNoTrackingï¼ˆåªè¯»æŸ¥è¯¢ï¼‰
var items = await _dbContext.MediaFiles.AsNoTracking().ToListAsync();

// 3. ä½¿ç”¨ç´¢å¼•
entity.HasIndex(e => e.PropertyName);

// 4. å»¶è¿ŸåŠ è½½å…³é—­ï¼ˆé»˜è®¤ï¼‰
optionsBuilder.UseLazyLoadingProxies(false);
```

#### 8.5.2 UIæ€§èƒ½ä¼˜åŒ–

```csharp
// 1. è™šæ‹ŸåŒ–TreeView
<TreeView VirtualizingPanel.IsVirtualizing="True"
          VirtualizingPanel.VirtualizationMode="Recycling"/>

// 2. å›¾ç‰‡ç¼“å­˜
var cachedImage = ImageCache.Get(imageId);

// 3. å¼‚æ­¥åŠ è½½
await Dispatcher.InvokeAsync(() => LoadImage(), DispatcherPriority.Background);

// 4. GPUåŠ é€Ÿ
imageProcessor.UseGPU = true;
```

#### 8.5.3 å†…å­˜ç®¡ç†

```csharp
// 1. åŠæ—¶é‡Šæ”¾èµ„æº
using var dbContext = new CanvasDbContext(dbPath);

// 2. å¼±å¼•ç”¨ç¼“å­˜
WeakReference<BitmapImage> weakRef = new WeakReference<BitmapImage>(image);

// 3. æ‰‹åŠ¨GCï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
GC.Collect();
GC.WaitForPendingFinalizers();
```

---

### 8.6 æµ‹è¯•æŒ‡å—

#### 8.6.1 å•å…ƒæµ‹è¯•

```csharp
[TestClass]
public class PlayCountJudgeTests
{
    [TestMethod]
    public void ShouldContinue_InfiniteLoop_ReturnsTrue()
    {
        // Arrange
        int targetCount = -1;
        int completedCount = 100;
        
        // Act
        var result = PlayCountJudge.ShouldContinue(targetCount, completedCount);
        
        // Assert
        Assert.IsTrue(result);
    }
}
```

#### 8.6.2 é›†æˆæµ‹è¯•

```csharp
[TestClass]
public class OriginalPlaybackServiceTests
{
    [TestMethod]
    public async Task StartPlaybackAsync_ValidImageId_StartsPlayback()
    {
        // Arrange
        var service = CreateService();
        
        // Act
        await service.StartPlaybackAsync(1);
        
        // Assert
        Assert.IsTrue(service.IsPlaying);
    }
}
```

---

### 8.7 è°ƒè¯•æŠ€å·§

#### 8.7.1 å¯ç”¨è¯¦ç»†æ—¥å¿—

```csharp
// Utils/Logger.cs
Logger.SetMinimumLevel(LogLevel.Debug);
```

#### 8.7.2 æ–­ç‚¹è°ƒè¯•å…³é”®ç‚¹

```
1. PlaybackLoopAsync() - æ’­æ”¾å¾ªç¯å…¥å£
2. PlayNextFrameAsync() - å¸§åˆ‡æ¢é€»è¾‘
3. OnOriginalPlaybackSwitchImageRequested() - å›¾ç‰‡åˆ‡æ¢äº‹ä»¶
4. RecordManualSwitchAsync() - æ‰‹åŠ¨è·³è½¬è®°å½•
5. ResumePlaybackAsync() - æš‚åœæ¢å¤é€»è¾‘
```

#### 8.7.3 æ€§èƒ½åˆ†æ

```csharp
// ä½¿ç”¨Stopwatchæµ‹é‡
var sw = Stopwatch.StartNew();
// æ‰§è¡Œæ“ä½œ
sw.Stop();
Logger.Debug("æ“ä½œè€—æ—¶: {0}ms", sw.ElapsedMilliseconds);
```

---

## ğŸ“ é™„å½•

### é™„å½• Aï¼šå…³é”®é…ç½®æ–‡ä»¶

**config.json**
```json
{
  "original_mode": 1,
  "zoom": 1.0,
  "target_color": {
    "r": 174,
    "g": 159,
    "b": 112
  }
}
```

### é™„å½• Bï¼šå¸¸ç”¨å¿«æ·é”®ï¼ˆå»ºè®®ï¼‰

| å¿«æ·é”® | åŠŸèƒ½ |
|-------|------|
| `Space` | æ’­æ”¾/æš‚åœ |
| `R` | å¼€å§‹/åœæ­¢å½•åˆ¶ |
| `Left` | ä¸Šä¸€å¼ å›¾ç‰‡ |
| `Right` | ä¸‹ä¸€å¼ å›¾ç‰‡ |
| `Up` | ä¸Šä¸€ä¸ªå…³é”®å¸§ |
| `Down` | ä¸‹ä¸€ä¸ªå…³é”®å¸§ |
| `Ctrl+K` | æ·»åŠ å…³é”®å¸§ |
| `Ctrl+S` | ä¿å­˜è„šæœ¬ |

### é™„å½• Cï¼šPythonç‰ˆæœ¬å‚è€ƒ

C#ç‰ˆæœ¬æ˜¯ä»Pythonç‰ˆæœ¬è¿ç§»è€Œæ¥ï¼Œé‡è¦çš„å‚è€ƒæ–‡æ¡£ï¼š

- `Canvas/palysdocs/LOGIC_ANALYSIS_03_å…³é”®å¸§æ¨¡å¼é€»è¾‘.md`
- `Canvas/palysdocs/LOGIC_ANALYSIS_04_åŸå›¾æ¨¡å¼é€»è¾‘.md`
- `Canvas/playback/keytime.py` - æ ¸å¿ƒæ’­æ”¾é€»è¾‘å®ç°

### é™„å½• Dï¼šç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|-----|------|---------|
| 2.5.5 | 2025-10 | åŸå›¾æ¨¡å¼å®Œå–„ï¼Œä¿®å¤å›¾ç‰‡åˆ‡æ¢é—®é¢˜ |
| 2.5.0 | 2025-09 | MVVMæ¶æ„è¿ç§»ï¼Œä¾èµ–æ³¨å…¥é‡æ„ |
| 2.0.0 | 2025-08 | ä»Pythonè¿ç§»åˆ°C# WPF |

---

## ğŸ“ æ€»ç»“

Canvas Cast æ˜¯ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œã€æ¶æ„æ¸…æ™°çš„ä¸“ä¸šå›¾ç‰‡ç®¡ç†å·¥å…·ã€‚ä¸»è¦ç‰¹ç‚¹ï¼š

1. **åˆ†å±‚æ¶æ„**ï¼šUI â†’ ViewModel â†’ Service â†’ Repository â†’ Database
2. **ä¾èµ–æ³¨å…¥**ï¼šä½¿ç”¨Microsoft.Extensions.DependencyInjection
3. **MVVMæ¨¡å¼**ï¼šCommunityToolkit.Mvvmå®ç°æ•°æ®ç»‘å®š
4. **åŒæ¨¡å¼æ’­æ”¾**ï¼šå…³é”®å¸§æ¨¡å¼ + åŸå›¾æ¨¡å¼
5. **æ™ºèƒ½æ—¶é—´ç®¡ç†**ï¼šæš‚åœç´¯åŠ ã€æ‰‹åŠ¨ä¿®æ­£ã€å®æ—¶æ›´æ–°
6. **é«˜æ€§èƒ½**ï¼šGPUåŠ é€Ÿã€å›¾ç‰‡ç¼“å­˜ã€è™šæ‹ŸåŒ–UI
7. **å¯æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ·»åŠ æ–°åŠŸèƒ½

**æ ¸å¿ƒè®¾è®¡æ€æƒ³**ï¼š
- å•ä¸€èŒè´£åŸåˆ™
- ä¾èµ–å€’ç½®åŸåˆ™
- æ¥å£éš”ç¦»
- äº‹ä»¶é©±åŠ¨
- çŠ¶æ€ç®¡ç†

å¸Œæœ›è¿™ä»½æ–‡æ¡£èƒ½å¸®åŠ©ä½ å¿«é€Ÿç†è§£ç³»ç»Ÿæ¶æ„ï¼Œä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•æä¾›æŒ‡å¯¼ï¼

---

**æ–‡æ¡£ç»´æŠ¤è€…**ï¼šAI Assistant  
**æœ€åæ›´æ–°**ï¼š2025-10-13  
**è”ç³»æ–¹å¼**ï¼šé€šè¿‡é¡¹ç›®Issueåé¦ˆé—®é¢˜

