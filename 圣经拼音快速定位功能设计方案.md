# 圣经拼音快速定位功能设计方案

## 一、核心规则

### 输入格式
```
书卷拼音 [空格] 章号 [空格] 起始节-结束节
```

### 显示格式（自动替换为中文书卷名）
- 输入 `csj` → 匹配唯一书卷 → 自动显示 `创世记`
- 输入 `创世记 1` + 空格 → 显示 `创世记1:`
- 输入 `创世记 1 1-12` + 空格 → 显示 `创世记1:1-12`

### 自动处理
1. **超出章节** → 自动使用最后一章
2. **超出节号** → 自动使用最后一节
3. **点击窗口外** → 自动退出

---

## 二、66卷书拼音缩写

### 旧约 (39卷)
| 书卷 | 缩写 | 书卷 | 缩写 |
|------|------|------|------|
| 创世记 | csj | 传道书 | cds |
| 出埃及记 | ceji | 雅歌 | yg |
| 利未记 | lwj | 以赛亚书 | ysys |
| 民数记 | msj | 耶利米书 | ylms |
| 申命记 | smj | 耶利米哀歌 | ylmag |
| 约书亚记 | ysyj | 以西结书 | yxjs |
| 士师记 | ssj | 但以理书 | dyls |
| 路得记 | ldj | 何西阿书 | hxas |
| 撒母耳记上 | smejs | 约珥书 | yes |
| 撒母耳记下 | smejx | 阿摩司书 | ams |
| 列王纪上 | lwjs | 俄巴底亚书 | ebdys |
| 列王纪下 | lwjx | 约拿书 | yns |
| 历代志上 | ldzs | 弥迦书 | mjs |
| 历代志下 | ldzx | 那鸿书 | nhs |
| 以斯拉记 | yslj | 哈巴谷书 | hbgs |
| 尼希米记 | nxmj | 西番雅书 | xfys |
| 以斯帖记 | ystj | 哈该书 | hgs |
| 约伯记 | ybj | 撒迦利亚书 | sjlys |
| 诗篇 | sp | 玛拉基书 | mljs |
| 箴言 | zy | | |

### 新约 (27卷)
| 书卷 | 缩写 | 书卷 | 缩写 |
|------|------|------|------|
| 马太福音 | mtfy | 提摩太前书 | tmtqs |
| 马可福音 | mkfy | 提摩太后书 | tmths |
| 路加福音 | ljfy | 提多书 | tds |
| 约翰福音 | yhfy | 腓利门书 | flms |
| 使徒行传 | stxz | 希伯来书 | xbls |
| 罗马书 | lms | 雅各书 | ygs |
| 哥林多前书 | gldqs | 彼得前书 | bdqs |
| 哥林多后书 | gldhs | 彼得后书 | bdhs |
| 加拉太书 | jlts | 约翰一书 | yhys |
| 以弗所书 | yfss | 约翰二书 | yhes |
| 腓立比书 | flbs | 约翰三书 | yhss |
| 歌罗西书 | glxs | 犹大书 | yds |
| 帖撒罗尼迦前书 | tslnjqs | 启示录 | qsl |
| 帖撒罗尼迦后书 | tslnjhs | | |

---

## 三、UI交互示意图

```
┌─────────────────────────────────────────────────────────────┐
│  经文显示区 (BibleVerseScrollViewer)                         │
│                                                             │
│  创世记 1章                                                  │
│  1 起初神创造天地。                                          │
│  2 地是空虚混沌，渊面黑暗；神的灵运行在水面上。              │
│  3 神说："要有光"，就有了光。                                │
│  ...                                                        │
│                                                             │
│         [用户按下字母键 'c']                                 │
│                  ↓                                          │
│    ┌──────────────────────────────────────────────┐        │
│    │  🔍 快速定位                                  │  ← 悬浮提示框自动弹出
│    ├──────────────────────────────────────────────┤        │
│    │  输入: c                                     │        │
│    ├──────────────────────────────────────────────┤        │
│    │  匹配: 创世记  出埃及记  传道书              │        │
│    └──────────────────────────────────────────────┘        │
│                                                             │
│         [继续输入 's']                                       │
│                  ↓                                          │
│    ┌──────────────────────────────────────────────┐        │
│    │  🔍 快速定位                                  │        │
│    ├──────────────────────────────────────────────┤        │
│    │  输入: cs                                    │        │
│    ├──────────────────────────────────────────────┤        │
│    │  匹配: 创世记                                │        │
│    └──────────────────────────────────────────────┘        │
│                                                             │
│         [继续输入 'j']                                       │
│                  ↓                                          │
│    ┌──────────────────────────────────────────────┐        │
│    │  🔍 快速定位                                  │        │
│    ├──────────────────────────────────────────────┤        │
│    │  创世记                                      │        │
│    └──────────────────────────────────────────────┘        │
│                                                             │
│         [输入 '1' 然后按空格]                                │
│                  ↓                                          │
│    ┌──────────────────────────────────────────────┐        │
│    │  🔍 快速定位                                  │        │
│    ├──────────────────────────────────────────────┤        │
│    │  创世记1:                                    │        │
│    └──────────────────────────────────────────────┘        │
│                                                             │
│         [输入 '1-12' 然后按空格]                             │
│                  ↓                                          │
│    ┌──────────────────────────────────────────────┐        │
│    │  🔍 快速定位                                  │        │
│    ├──────────────────────────────────────────────┤        │
│    │  创世记1:1-12                                │        │
│    └──────────────────────────────────────────────┘        │
│                  ↓                                          │
│         [提示框消失，经文区显示创世记1:1-12]                 │
│                                                             │
│  创世记 1章 1-12节                                           │
│  1 起初神创造天地。                                          │
│  2 地是空虚混沌，渊面黑暗；神的灵运行在水面上。              │
│  ...                                                        │
│  12 于是地发生了青草和结种子的菜蔬...                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘

提示框样式说明:
• 书卷匹配时：横向排列，每行最多5个书卷名
• 超过5个：自动换行显示
• 示例: 输入 'm' 匹配到多个书卷时
  ┌──────────────────────────────────────────────┐
  │  匹配: 马太福音  马可福音  民数记  弥迦书  │
  │        玛拉基书                              │
  └──────────────────────────────────────────────┘

退出方式:
• 按 ESC → 关闭提示框
• 点击经文区外 → 关闭提示框
• 完成跳转 → 自动关闭
```

## 四、输入示例

```
步骤1: 输入拼音
输入: csj
显示: 创世记 (拼音自动替换为中文书卷名)

步骤2: 输入章号
输入: 创世记 1
显示: 创世记 1
操作: 按空格 → 显示 "创世记1:" → 加载创世记第1章

步骤3: 输入节范围
输入: 创世记 1 1-12
显示: 创世记 1 1-12
操作: 按空格 → 显示 "创世记1:1-12" → 加载创世记1章1-12节

完整示例:
c → s → j (显示: 创世记)
1 → 空格 (显示: 创世记1:)
1 → - → 1 → 2 → 空格 (显示: 创世记1:1-12，执行跳转)
```

---

## 四、核心类实现

### BiblePinyinService.cs
```csharp
public class BiblePinyinService
{
    private static readonly Dictionary<string, int> PinyinMap = new()
    {
        {"csj", 1}, {"ceji", 2}, {"lwj", 3}, {"msj", 4}, {"smj", 5},
        {"ysyj", 6}, {"ssj", 7}, {"ldj", 8}, {"smejs", 9}, {"smejx", 10},
        {"lwjs", 11}, {"lwjx", 12}, {"ldzs", 13}, {"ldzx", 14}, {"yslj", 15},
        {"nxmj", 16}, {"ystj", 17}, {"ybj", 18}, {"sp", 19}, {"zy", 20},
        {"cds", 21}, {"yg", 22}, {"ysys", 23}, {"ylms", 24}, {"ylmag", 25},
        {"yxjs", 26}, {"dyls", 27}, {"hxas", 28}, {"yes", 29}, {"ams", 30},
        {"ebdys", 31}, {"yns", 32}, {"mjs", 33}, {"nhs", 34}, {"hbgs", 35},
        {"xfys", 36}, {"hgs", 37}, {"sjlys", 38}, {"mljs", 39},
        {"mtfy", 40}, {"mkfy", 41}, {"ljfy", 42}, {"yhfy", 43}, {"stxz", 44},
        {"lms", 45}, {"gldqs", 46}, {"gldhs", 47}, {"jlts", 48}, {"yfss", 49},
        {"flbs", 50}, {"glxs", 51}, {"tslnjqs", 52}, {"tslnjhs", 53},
        {"tmtqs", 54}, {"tmths", 55}, {"tds", 56}, {"flms", 57}, {"xbls", 58},
        {"ygs", 59}, {"bdqs", 60}, {"bdhs", 61}, {"yhys", 62}, {"yhes", 63},
        {"yhss", 64}, {"yds", 65}, {"qsl", 66}
    };

    public ParseResult Parse(string input)
    {
        var parts = input.Trim().Split(' ');
        
        // 解析书卷（支持拼音或中文书卷名）
        int bookId;
        if (PinyinMap.TryGetValue(parts[0], out bookId))
        {
            // 拼音匹配成功
        }
        else
        {
            // 尝试按中文书卷名查找
            var book = BibleBookConfig.Books.FirstOrDefault(b => b.Name == parts[0]);
            if (book == null)
                return new ParseResult { Success = false };
            bookId = book.BookId;
        }

        var bookInfo = BibleBookConfig.GetBook(bookId);
        
        // 只有书卷
        if (parts.Length == 1)
            return new ParseResult { Success = true, BookId = bookId, BookName = bookInfo.Name, Type = LocationType.Book };

        // 解析章号
        if (!int.TryParse(parts[1], out int chapter))
            return new ParseResult { Success = false };

        // 超出章数，使用最后一章
        if (chapter > bookInfo.ChapterCount)
            chapter = bookInfo.ChapterCount;

        // 只有章号
        if (parts.Length == 2)
            return new ParseResult { Success = true, BookId = bookId, BookName = bookInfo.Name, Chapter = chapter, Type = LocationType.Chapter };

        // 解析节号范围
        var verseParts = parts[2].Split('-');
        if (verseParts.Length != 2)
            return new ParseResult { Success = false };

        if (!int.TryParse(verseParts[0], out int startVerse) || !int.TryParse(verseParts[1], out int endVerse))
            return new ParseResult { Success = false };

        // 获取该章节数，超出则使用最大值
        int maxVerse = GetVerseCount(bookId, chapter);
        if (startVerse > maxVerse) startVerse = maxVerse;
        if (endVerse > maxVerse) endVerse = maxVerse;

        return new ParseResult
        {
            Success = true,
            BookId = bookId,
            BookName = bookInfo.Name,
            Chapter = chapter,
            StartVerse = startVerse,
            EndVerse = endVerse,
            Type = LocationType.VerseRange
        };
    }

    public string FormatDisplay(string input)
    {
        var result = Parse(input);
        if (!result.Success)
            return input;

        // 只有书卷拼音 → 显示中文书卷名
        if (result.Type == LocationType.Book)
            return result.BookName;

        // 有章号 → 书卷名+章号+冒号
        if (result.Type == LocationType.Chapter)
            return $"{result.BookName}{result.Chapter}:";

        // 有节范围 → 书卷名+章号+冒号+节范围
        return $"{result.BookName}{result.Chapter}:{result.StartVerse}-{result.EndVerse}";
    }
    
    public string ReplaceWithBookName(string input)
    {
        // 自动替换拼音为书卷名
        var parts = input.Trim().Split(' ');
        if (PinyinMap.TryGetValue(parts[0], out int bookId))
        {
            var book = BibleBookConfig.GetBook(bookId);
            parts[0] = book.Name;
            return string.Join(" ", parts);
        }
        return input;
    }
}

public class ParseResult
{
    public bool Success { get; set; }
    public int? BookId { get; set; }
    public string BookName { get; set; }  // 中文书卷名
    public int? Chapter { get; set; }
    public int? StartVerse { get; set; }
    public int? EndVerse { get; set; }
    public LocationType Type { get; set; }
}

public enum LocationType
{
    Book,
    Chapter,
    VerseRange
}
```

### BiblePinyinInputManager.cs
```csharp
public class BiblePinyinInputManager
{
    private bool _isActive;
    private string _currentInput = "";
    private BiblePinyinService _service;

    public void ProcessKey(Key key)
    {
        if (!_isActive) return;

        if (key == Key.Escape)
        {
            Deactivate();
            return;
        }

        if (key == Key.Back)
        {
            if (_currentInput.Length > 0)
                _currentInput = _currentInput.Substring(0, _currentInput.Length - 1);
            UpdateHint();
            return;
        }

        if (key == Key.Space)
        {
            _currentInput += " ";
            UpdateHint();
            
            // 检查是否可以执行跳转
            var result = _service.Parse(_currentInput.Trim());
            if (result.Success && result.Type == LocationType.VerseRange)
            {
                ExecuteJump(result);
                Deactivate();
            }
            return;
        }

        // 字母、数字、连字符
        char c = KeyToChar(key);
        if (c != '\0')
        {
            _currentInput += c;
            
            // 检查是否需要自动替换拼音为书卷名
            var replaced = _service.ReplaceWithBookName(_currentInput);
            if (replaced != _currentInput)
            {
                _currentInput = replaced;
            }
            
            UpdateHint();
        }
    }

    private void UpdateHint()
    {
        var display = _service.FormatDisplay(_currentInput);
        // 更新UI显示
    }
}
```

---

## 五、实施清单

- [x] 创建 `BiblePinyinService.cs`
- [x] 创建 `BiblePinyinInputManager.cs`
- [x] 创建提示框UI控件
- [x] 集成到 `MainWindow.Bible.cs`
- [x] 监听键盘和鼠标事件
- [x] 测试所有书卷定位
- [x] **新增：自动历史记录功能**

---

## 六、更新日志

### v1.1 (2025-11-06)
**新增功能：**
- ✨ **智能自动历史记录**：拼音定位成功后自动保存到历史槽位
  - 定位到书卷：保存该书第一章全部经文
  - 定位到章：保存该章全部经文  
  - 定位到节范围：保存精确的节范围
- 🔧 自动获取章节最大节数，确保历史记录准确性
- 📝 DEBUG模式下输出历史记录日志，便于调试

**智能槽位分配策略：**
1. **优先填充空槽位**：自动查找第一个空槽位（DisplayText为空或BookId为0）
2. **槽位满时的策略**：
   - 如果有勾选的槽位 → 覆盖第一个勾选的槽位
   - 如果没有勾选的槽位 → 覆盖最后一个槽位（槽位20）
3. **不会覆盖未选中的已有记录**：保护用户已保存的历史记录

**技术实现：**
```csharp
// 新增专用方法 AddPinyinHistoryToEmptySlot
private void AddPinyinHistoryToEmptySlot(int bookId, int chapter, int startVerse, int endVerse)
{
    // 1. 优先查找空槽位
    var emptySlot = _historySlots.FirstOrDefault(s => 
        string.IsNullOrWhiteSpace(s.DisplayText) || s.BookId == 0);
    
    if (emptySlot != null)
    {
        // 找到空槽位，直接填充
        emptySlot.DisplayText = displayText;
    }
    else
    {
        // 2. 槽位满了，覆盖勾选的槽位或最后一个槽位
        var checkedSlots = _historySlots.Where(s => s.IsChecked).ToList();
        var targetSlot = checkedSlots.Count > 0 ? checkedSlots[0] : _historySlots.Last();
        targetSlot.DisplayText = displayText;
    }
}
```

**用户体验提升：**
- ✅ 无需手动保存，定位即存档
- ✅ 与现有历史记录系统完美集成
- ✅ 智能避免覆盖重要历史记录
- ✅ 20个槽位充分利用，不会造成浪费
- ✅ 历史记录显示格式：`创世记1章1-12节`
