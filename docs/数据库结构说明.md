# Canvas Cast 数据库结构说明

## 数据库概述

Canvas Cast 使用 SQLite 数据库存储项目数据、设置、关键帧信息和时间记录等。

**数据库文件名：** `pyimages.db`

## 数据表结构

### 1. UI设置表 (ui_settings)

存储用户界面相关的设置

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| key | TEXT | PRIMARY KEY | 设置键名 |
| value | TEXT | NOT NULL | 设置值（JSON字符串） |

**用途：** 存储窗口大小、位置、布局等UI相关设置

---

### 2. 通用设置表 (settings)

存储应用程序的通用设置

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| key | TEXT | PRIMARY KEY | 设置键名 |
| value | TEXT | NOT NULL | 设置值 |

**用途：** 存储缩放比例、滚动速度、颜色设置等

---

### 3. 文件夹表 (folders)

存储导入的文件夹信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 文件夹ID |
| name | TEXT | NOT NULL | 文件夹名称 |
| path | TEXT | UNIQUE NOT NULL | 文件夹路径（唯一） |
| order_index | INTEGER | - | 显示顺序索引 |
| created_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- `idx_order_folders` ON `order_index`

---

### 4. 媒体文件表 (images)

存储图片、视频和音频文件信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 文件ID |
| name | TEXT | NOT NULL | 文件名（不含扩展名） |
| path | TEXT | UNIQUE NOT NULL | 文件完整路径（唯一） |
| folder_id | INTEGER | FOREIGN KEY | 所属文件夹ID（可为NULL） |
| last_modified | TIMESTAMP | - | 最后修改时间 |
| order_index | INTEGER | - | 在文件夹内的显示顺序 |
| file_type | TEXT | DEFAULT 'image' | 文件类型：image/video/audio |

**约束：**
- `file_type` CHECK (file_type IN ('image', 'video', 'audio'))
- `FOREIGN KEY (folder_id) REFERENCES folders(id)`
- `UNIQUE(path)` - 文件路径必须唯一

**索引：**
- `idx_folder_id` ON `folder_id`
- `idx_order_images` ON `order_index`
- `idx_images_name` ON `name`
- `idx_images_folder_order` ON `folder_id, order_index` (复合索引)
- `idx_images_file_type` ON `file_type`

**支持的文件类型：**
- **图片：** .jpg, .jpeg, .png, .bmp, .gif, .tif
- **视频：** .mp4, .avi, .mkv, .mov, .wmv, .flv, .f4v, .rm, .rmvb
- **音频：** .mp3, .wav, .flac, .ogg, .m4a, .aac

---

### 5. 关键帧表 (keyframes)

存储图片的关键帧位置信息

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 关键帧ID |
| image_id | INTEGER | NOT NULL, FOREIGN KEY | 所属图片ID |
| position | REAL | NOT NULL | 相对位置（0.0-1.0） |
| y_position | INTEGER | NOT NULL | Y轴位置（像素） |
| order_index | INTEGER | - | 关键帧顺序 |

**约束：**
- `FOREIGN KEY (image_id) REFERENCES images(id)`

**索引：**
- `idx_keyframes_image` ON `image_id`
- `idx_keyframes_order` ON `order_index`

**说明：**
- `position`: 关键帧在图片中的相对位置（0.0表示顶部，1.0表示底部）
- `y_position`: 滚动条的Y轴位置（像素值）

---

### 6. 关键帧时间记录表 (keyframe_timings)

存储关键帧之间的时间记录

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 记录ID |
| image_id | INTEGER | NOT NULL, FOREIGN KEY | 所属图片ID |
| keyframe_id | INTEGER | NOT NULL, FOREIGN KEY | 关键帧ID |
| duration | REAL | NOT NULL | 持续时间（秒） |
| sequence_order | INTEGER | NOT NULL | 序列顺序 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**约束：**
- `FOREIGN KEY (image_id) REFERENCES images(id)`
- `FOREIGN KEY (keyframe_id) REFERENCES keyframes(id)`

**索引：**
- `idx_timing_image` ON `image_id`
- `idx_timing_sequence` ON `image_id, sequence_order` (复合索引)

---

### 7. 原图模式时间记录表 (original_mode_timings)

存储原图模式下图片切换的时间记录

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 记录ID |
| base_image_id | INTEGER | NOT NULL, FOREIGN KEY | 基础图片ID |
| from_image_id | INTEGER | NOT NULL, FOREIGN KEY | 起始图片ID |
| to_image_id | INTEGER | NOT NULL, FOREIGN KEY | 目标图片ID |
| duration | REAL | NOT NULL | 持续时间（秒） |
| sequence_order | INTEGER | NOT NULL | 序列顺序 |
| mark_type | TEXT | DEFAULT 'loop' | 标记类型：loop/sequence |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**约束：**
- `FOREIGN KEY (base_image_id) REFERENCES images(id)`
- `FOREIGN KEY (from_image_id) REFERENCES images(id)`
- `FOREIGN KEY (to_image_id) REFERENCES images(id)`

**索引：**
- `idx_original_base` ON `base_image_id`
- `idx_original_sequence` ON `base_image_id, sequence_order` (复合索引)

**说明：**
- 用于记录原图模式下图片之间的切换时间
- `mark_type`: loop=循环模式，sequence=顺序模式

---

### 8. 原图标记表 (original_marks)

标记哪些文件夹或图片为原图模式

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 标记ID |
| item_type | TEXT | NOT NULL | 项目类型：folder/image |
| item_id | INTEGER | NOT NULL | 项目ID |
| mark_type | TEXT | NOT NULL, DEFAULT 'loop' | 标记类型：loop/sequence |
| created_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**约束：**
- `item_type` CHECK (item_type IN ('folder', 'image'))
- `mark_type` CHECK (mark_type IN ('loop', 'sequence'))
- `UNIQUE(item_type, item_id)` - 同一项目只能有一个标记

**索引：**
- `idx_original_marks` ON `item_type, item_id` (复合索引)

**说明：**
- `item_type='folder'`: 标记整个文件夹为原图模式
- `item_type='image'`: 标记单张图片为原图模式
- `mark_type='loop'`: 循环播放
- `mark_type='sequence'`: 顺序播放

---

### 9. 手动排序文件夹表 (manual_sort_folders)

标记哪些文件夹启用了手动排序

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| folder_id | INTEGER | PRIMARY KEY, FOREIGN KEY | 文件夹ID |
| is_manual_sort | BOOLEAN | DEFAULT 0 | 是否手动排序 |
| last_manual_sort_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 最后手动排序时间 |

**约束：**
- `FOREIGN KEY (folder_id) REFERENCES folders(id) ON DELETE CASCADE`

**索引：**
- `idx_manual_sort` ON `folder_id`

**说明：**
- `is_manual_sort=1`: 文件夹内的图片按用户手动拖拽的顺序排列
- `is_manual_sort=0`: 文件夹内的图片按文件名自动排序

---

### 10. 图片显示位置表 (image_display_locations)

支持同一张图片在多个位置显示

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 位置ID |
| image_id | INTEGER | NOT NULL, FOREIGN KEY | 图片ID |
| location_type | TEXT | NOT NULL | 位置类型：folder/root |
| folder_id | INTEGER | FOREIGN KEY | 文件夹ID（可为NULL） |
| order_index | INTEGER | - | 显示顺序 |
| created_time | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |

**约束：**
- `location_type` CHECK (location_type IN ('folder', 'root'))
- `FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE`
- `FOREIGN KEY (folder_id) REFERENCES folders(id) ON DELETE CASCADE`
- `UNIQUE(image_id, location_type, folder_id)` - 同一位置不能重复

**说明：**
- 支持一张图片同时显示在根目录和多个文件夹中
- `location_type='root'`: 显示在项目树根目录
- `location_type='folder'`: 显示在某个文件夹内

---

## 数据库优化设置

Python版本使用的SQLite优化配置：

```python
# WAL模式（Write-Ahead Logging）
PRAGMA journal_mode = WAL

# 同步模式（NORMAL平衡性能和安全性）
PRAGMA synchronous = NORMAL

# 内存缓存（10MB）
PRAGMA cache_size = -10000

# 启用外键约束
PRAGMA foreign_keys = ON

# Mmap大小（256MB）
PRAGMA mmap_size = 268435456

# 临时存储使用内存
PRAGMA temp_store = MEMORY
```

---

## 数据库关系图

```
folders (文件夹)
    ↓ (1对多)
images (媒体文件)
    ↓ (1对多)
keyframes (关键帧)
    ↓ (1对多)
keyframe_timings (时间记录)

folders/images
    ↓ (1对1)
original_marks (原图标记)

folders
    ↓ (1对1)
manual_sort_folders (手动排序标记)

images
    ↓ (1对多)
image_display_locations (显示位置)
```

---

## C# 实现建议

### 1. 使用 Entity Framework Core

推荐使用 EF Core 作为 ORM：
- 支持 SQLite
- 类型安全
- 迁移管理
- LINQ 查询

### 2. 数据模型类

需要创建以下 Entity 类：
- `Folder` - 文件夹
- `MediaFile` (或 `ImageFile`) - 媒体文件
- `Keyframe` - 关键帧
- `KeyframeTiming` - 关键帧时间记录
- `OriginalModeTiming` - 原图模式时间记录
- `OriginalMark` - 原图标记
- `ManualSortFolder` - 手动排序文件夹
- `ImageDisplayLocation` - 图片显示位置
- `UISetting` - UI设置
- `Setting` - 通用设置

### 3. DbContext 类

创建一个 `CanvasDbContext` 类：
- 配置表关系
- 配置索引
- 配置约束
- 配置级联删除

### 4. 迁移策略

- 初始迁移创建所有表
- 数据库升级时保持向后兼容
- 支持从旧版本数据库迁移

---

## 数据库使用场景

### 场景1：导入文件夹
1. 在 `folders` 表中创建记录
2. 扫描文件夹中的所有媒体文件
3. 在 `images` 表中批量插入文件记录
4. 根据排序规则设置 `order_index`

### 场景2：添加关键帧
1. 用户在图片上设置关键帧位置
2. 在 `keyframes` 表中插入记录
3. 记录 `position` 和 `y_position`

### 场景3：录制时间
1. 用户播放并记录每个关键帧的时间
2. 在 `keyframe_timings` 表中保存时间记录
3. 回放时按照记录的时间自动播放

### 场景4：原图模式
1. 用户标记文件夹或图片为原图模式
2. 在 `original_marks` 表中添加标记
3. 原图模式播放时按标记的图片顺序切换
4. 在 `original_mode_timings` 表中记录切换时间

### 场景5：手动排序
1. 用户在文件夹内拖拽调整图片顺序
2. 在 `manual_sort_folders` 表中标记为手动排序
3. 更新 `images` 表中的 `order_index`
4. 下次打开时保持用户自定义的顺序

---

## 文件类型支持

### 图片文件 (file_type='image')
- 扩展名：.jpg, .jpeg, .png, .bmp, .gif, .tif
- 用途：显示、变色、投影
- 支持关键帧功能

### 视频文件 (file_type='video')
- 扩展名：.mp4, .avi, .mkv, .mov, .wmv, .flv, .f4v, .rm, .rmvb
- 用途：播放视频
- 使用媒体播放器组件

### 音频文件 (file_type='audio')
- 扩展名：.mp3, .wav, .flac, .ogg, .m4a, .aac
- 用途：播放音频
- 使用媒体播放器组件

---

## 性能优化要点

### 1. 批量操作
- 导入文件夹时使用批量插入
- 更新排序时使用批量更新
- 减少数据库往返次数

### 2. 索引优化
- 在常用查询字段上创建索引
- 使用复合索引优化多字段查询
- 避免过度索引影响写入性能

### 3. 事务管理
- 批量操作使用事务
- 减少事务嵌套
- 及时提交事务

### 4. 连接管理
- 使用连接池
- 避免频繁打开关闭连接
- 使用 WAL 模式支持并发读写

---

## 数据迁移注意事项

如果需要从Python版本迁移数据到C#版本：

1. **数据库兼容性**
   - C# 版本应能直接读取 Python 创建的数据库
   - 保持表结构完全一致
   - 保持字段类型兼容

2. **编码问题**
   - 确保文本字段使用 UTF-8 编码
   - 文件路径正确处理中文

3. **时间戳格式**
   - SQLite 时间戳格式保持一致
   - 使用 ISO 8601 格式或 Unix 时间戳

4. **外键约束**
   - 确保启用外键约束
   - 级联删除规则保持一致

