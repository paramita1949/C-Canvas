# åŸå›¾æ¨¡å¼æŠ•å½±åŠŸèƒ½å®ç°æ€»ç»“

## ä¸€ã€é—®é¢˜èƒŒæ™¯

åœ¨å®ç°åŸå›¾æ¨¡å¼çš„æŠ•å½±åŠŸèƒ½æ—¶,é‡åˆ°äº†æŠ•å½±å±å¹•æ˜¾ç¤ºä¸æ­£ç¡®çš„é—®é¢˜:
- å›¾ç‰‡è¢«è¿‡åº¦æ‹‰ä¼¸æˆ–å˜å½¢
- å›¾ç‰‡æ— æ³•å®Œæ•´æ˜¾ç¤º
- ä½ç½®åç§»ä¸æ­£ç¡®

ç»è¿‡å¤šæ¬¡è°ƒè¯•å’Œæ·±å…¥åˆ†æPythonæºä»£ç ,æœ€ç»ˆæ‰¾åˆ°äº†æ ¹æœ¬åŸå› å¹¶æˆåŠŸè§£å†³ã€‚

## äºŒã€æ ¸å¿ƒé—®é¢˜åˆ†æ

### 2.1 DPIç¼©æ”¾é—®é¢˜

**å…³é”®å‘ç°**: WPFä½¿ç”¨**è®¾å¤‡ç‹¬ç«‹å•ä½(DIU)**,è€Œä¸æ˜¯ç‰©ç†åƒç´ !

åœ¨é«˜DPIå±å¹•(å¦‚200%ç¼©æ”¾)ä¸Š:
- å±å¹•ç‰©ç†åˆ†è¾¨ç‡: `3840x2160`
- ScrollViewerçš„DIUå°ºå¯¸: `1920x1080` (ActualWidth/ActualHeight)
- ä¸¤è€…æ¯”ä¾‹: `2:1` (200% DPIç¼©æ”¾)

**é”™è¯¯åšæ³•**:
```csharp
// âŒ ä½¿ç”¨å±å¹•ç‰©ç†åˆ†è¾¨ç‡è®¡ç®—å›¾ç‰‡å°ºå¯¸
double canvasWidth = screenWidth;  // 3840
double canvasHeight = screenHeight; // 2160
// ç»“æœ: å›¾ç‰‡å°ºå¯¸ = 3840x2160,ä½†WPFå¸ƒå±€ç³»ç»ŸæœŸæœ›1920x1080!
```

**æ­£ç¡®åšæ³•**:
```csharp
// âœ… ä½¿ç”¨ScrollViewerçš„ActualWidth/ActualHeight (DIUå•ä½)
double canvasWidth = _projectionScrollViewer?.ActualWidth ?? screenWidth;
double canvasHeight = _projectionScrollViewer?.ActualHeight ?? screenHeight;
// ç»“æœ: å›¾ç‰‡å°ºå¯¸ = 1920x1080,ä¸WPFå¸ƒå±€ç³»ç»Ÿä¸€è‡´!
```

### 2.2 å®šä½æ–¹å¼é—®é¢˜

**Pythonçš„å®šä½é€»è¾‘**:
```python
# è®¡ç®—å±…ä¸­ä½ç½®
x = max(0, (screen_width - new_width) // 2)
y = max(0, (screen_height - new_height) // 2)

# ä½¿ç”¨ç»å¯¹åæ ‡å®šä½
canvas.create_image(x, y, anchor=tk.NW, image=photo)
```

**WPFçš„é”™è¯¯åšæ³•**:
```csharp
// âŒ ä½¿ç”¨WPFçš„å¯¹é½å±æ€§(Center/Stretch)
_projectionImageControl.HorizontalAlignment = HorizontalAlignment.Center;
_projectionImageControl.VerticalAlignment = VerticalAlignment.Center;
// é—®é¢˜: åœ¨æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´å›¾ç‰‡è¢«æ‹‰ä¼¸å˜å½¢
```

**WPFçš„æ­£ç¡®åšæ³•**:
```csharp
// âœ… æ¨¡ä»¿Pythonçš„ç»å¯¹åæ ‡å®šä½,ä½¿ç”¨Margin
double x = Math.Max(0, (containerWidth - newWidth) / 2.0);
double y = Math.Max(0, (containerHeight - newHeight) / 2.0);

_projectionImageControl.HorizontalAlignment = HorizontalAlignment.Left;
_projectionImageControl.VerticalAlignment = VerticalAlignment.Top;
_projectionImageControl.Margin = new Thickness(x, y, 0, 0);
```

## ä¸‰ã€æœ€ç»ˆè§£å†³æ–¹æ¡ˆ

### 3.1 å›¾ç‰‡å°ºå¯¸è®¡ç®—

```csharp
private (int width, int height) CalculateImageSize(int screenWidth, int screenHeight)
{
    // å…³é”®: WPFä½¿ç”¨è®¾å¤‡ç‹¬ç«‹å•ä½(DIU),éœ€è¦è€ƒè™‘DPIç¼©æ”¾
    // è·å–æŠ•å½±ScrollViewerçš„å®é™…DIUå°ºå¯¸(å¦‚æœå·²æ¸²æŸ“)
    double canvasWidth = _projectionScrollViewer?.ActualWidth ?? screenWidth;
    double canvasHeight = _projectionScrollViewer?.ActualHeight ?? screenHeight;
    
    // å¦‚æœScrollViewerè¿˜æ²¡æœ‰æ¸²æŸ“,åˆ™å‡è®¾ä½¿ç”¨å±å¹•ç‰©ç†å°ºå¯¸
    if (canvasWidth <= 0) canvasWidth = screenWidth;
    if (canvasHeight <= 0) canvasHeight = screenHeight;
    
    if (_isOriginalMode)
    {
        // åŸå›¾æ¨¡å¼ï¼šæ ¹æ®æ˜¾ç¤ºæ¨¡å¼æ™ºèƒ½ç¼©æ”¾
        double widthRatio = canvasWidth / _currentImage.Width;
        double heightRatio = canvasHeight / _currentImage.Height;
        
        double scaleRatio;
        if (_originalDisplayMode == OriginalDisplayMode.Stretch)
        {
            // æ‹‰ä¼¸æ¨¡å¼ï¼šå®½åº¦å¡«æ»¡,é«˜åº¦æŒ‰æ¯”ä¾‹
            scaleRatio = heightRatio;
            newWidth = (int)canvasWidth;
            newHeight = (int)(_currentImage.Height * scaleRatio);
        }
        else
        {
            // é€‚ä¸­æ¨¡å¼ï¼šé«˜åº¦å¡«æ»¡,å®½åº¦æŒ‰æ¯”ä¾‹
            scaleRatio = Math.Min(widthRatio, heightRatio);
            newWidth = (int)(_currentImage.Width * scaleRatio);
            newHeight = (int)(_currentImage.Height * scaleRatio);
        }
    }
    
    return (newWidth, newHeight);
}
```

### 3.2 å›¾ç‰‡å®šä½

```csharp
// è·å–æŠ•å½±ScrollViewerçš„å®é™…DIUå°ºå¯¸ç”¨äºå±…ä¸­è®¡ç®—
double containerWidth = _projectionScrollViewer?.ActualWidth ?? screenWidth;
double containerHeight = _projectionScrollViewer?.ActualHeight ?? screenHeight;
if (containerWidth <= 0) containerWidth = screenWidth;
if (containerHeight <= 0) containerHeight = screenHeight;

// è®¡ç®—å±…ä¸­ä½ç½® (å®Œå…¨æ¨¡ä»¿Pythonçš„é€»è¾‘,ä½†ä½¿ç”¨DIUå°ºå¯¸)
double x = Math.Max(0, (containerWidth - newWidth) / 2.0);
double y = Math.Max(0, (containerHeight - newHeight) / 2.0);

// è®¾ç½®å¯¹é½æ–¹å¼å’Œä½ç½® (æ¨¡ä»¿Python: anchor=tk.NW + è®¡ç®—çš„x,yåæ ‡)
_projectionImageControl.HorizontalAlignment = HorizontalAlignment.Left;
_projectionImageControl.VerticalAlignment = VerticalAlignment.Top;

if (_isOriginalMode)
{
    // åŸå›¾æ¨¡å¼: æ°´å¹³å’Œå‚ç›´éƒ½å±…ä¸­ (Python: x=å±…ä¸­, y=å±…ä¸­)
    _projectionImageControl.Margin = new Thickness(x, y, 0, 0);
}
else
{
    // æ­£å¸¸æ¨¡å¼: æ°´å¹³å±…ä¸­,å‚ç›´é¡¶éƒ¨ (Python: x=å±…ä¸­, y=0)
    _projectionImageControl.Margin = new Thickness(x, 0, 0, 0);
}
```

## å››ã€åŸå›¾æ¨¡å¼æ˜¾ç¤ºé€»è¾‘

### 4.1 æ‹‰ä¼¸æ¨¡å¼(Stretch)

**ç›®æ ‡**: å›¾ç‰‡å®½åº¦å¡«æ»¡æŠ•å½±å±å¹•

**å®ç°**:
- å›¾ç‰‡å®½åº¦ = ScrollViewerçš„ActualWidth (DIU)
- å›¾ç‰‡é«˜åº¦ = æŒ‰æ¯”ä¾‹ç¼©æ”¾
- æ°´å¹³åç§» = 0 (å®½åº¦å·²å¡«æ»¡)
- å‚ç›´åç§» = (å®¹å™¨é«˜åº¦ - å›¾ç‰‡é«˜åº¦) / 2 (ä¸Šä¸‹å±…ä¸­)

**é¢„æœŸæ•ˆæœ**:
- å›¾ç‰‡å®½åº¦å¡«æ»¡å±å¹•
- å›¾ç‰‡ä¸Šä¸‹å¯èƒ½æœ‰é»‘è¾¹(å¦‚æœå›¾ç‰‡é«˜åº¦ < å±å¹•é«˜åº¦)

### 4.2 é€‚ä¸­æ¨¡å¼(Fit)

**ç›®æ ‡**: å›¾ç‰‡å®Œæ•´æ˜¾ç¤º,ä¸è£åˆ‡

**å®ç°**:
- ç¼©æ”¾æ¯”ä¾‹ = Min(å®½åº¦æ¯”, é«˜åº¦æ¯”)
- å›¾ç‰‡å®½åº¦ = åŸå›¾å®½åº¦ Ã— ç¼©æ”¾æ¯”ä¾‹
- å›¾ç‰‡é«˜åº¦ = åŸå›¾é«˜åº¦ Ã— ç¼©æ”¾æ¯”ä¾‹
- æ°´å¹³åç§» = (å®¹å™¨å®½åº¦ - å›¾ç‰‡å®½åº¦) / 2 (å·¦å³å±…ä¸­)
- å‚ç›´åç§» = (å®¹å™¨é«˜åº¦ - å›¾ç‰‡é«˜åº¦) / 2 (ä¸Šä¸‹å±…ä¸­)

**é¢„æœŸæ•ˆæœ**:
- å›¾ç‰‡å®Œæ•´æ˜¾ç¤º,ä¸è£åˆ‡
- å›¾ç‰‡å¯èƒ½å·¦å³æˆ–ä¸Šä¸‹æœ‰é»‘è¾¹

## äº”ã€å…³é”®ç»éªŒæ•™è®­

### 5.1 æ·±å…¥ç ”ç©¶æºä»£ç çš„é‡è¦æ€§

**æ•™è®­**: å¦‚æœä¸€å¼€å§‹å°±æ·±å…¥ç ”ç©¶Pythonæºä»£ç ,è€Œä¸æ˜¯å‡­ç»éªŒçŒœæµ‹,å°±èƒ½é¿å…èµ°å¾ˆå¤šå¼¯è·¯ã€‚

**Pythonæºä»£ç å…³é”®ç‚¹**:
```python
# projection_manager.py, line 740-753
# è®¡ç®—å±…ä¸­ä½ç½® - æ°´å¹³å’Œå‚ç›´éƒ½å±…ä¸­
x = max(0, (screen_width - new_width) // 2)
y = max(0, (screen_height - new_height) // 2)

# æ˜¾ç¤ºæ–°å›¾ç‰‡ - åœ¨åŸå›¾æ¨¡å¼ä¸‹å±…ä¸­æ˜¾ç¤º
if self.main_app.original_mode:
    self.second_image_on_canvas = self.second_canvas.create_image(
        x, y, anchor=tk.NW, image=self.second_photo
    )
else:
    # æ­£å¸¸æ¨¡å¼ä¿æŒåŸæœ‰é€»è¾‘ï¼ˆé¡¶éƒ¨æ˜¾ç¤ºï¼‰
    self.second_image_on_canvas = self.second_canvas.create_image(
        x, 0, anchor=tk.NW, image=self.second_photo
    )
```

**å…³é”®å‘ç°**:
1. Pythonä½¿ç”¨**ç»å¯¹åæ ‡å®šä½**,ä¸æ˜¯å¯¹é½å±æ€§
2. åŸå›¾æ¨¡å¼: `x=å±…ä¸­, y=å±…ä¸­`
3. æ­£å¸¸æ¨¡å¼: `x=å±…ä¸­, y=0`

### 5.2 WPFä¸Tkinterçš„å·®å¼‚

| ç‰¹æ€§ | Tkinter | WPF |
|------|---------|-----|
| åæ ‡ç³»ç»Ÿ | ç»å¯¹åƒç´ åæ ‡ | è®¾å¤‡ç‹¬ç«‹å•ä½(DIU) |
| å®šä½æ–¹å¼ | `create_image(x, y)` | `Margin` + `HorizontalAlignment.Left/Top` |
| DPIç¼©æ”¾ | ä¸å½±å“åæ ‡ | è‡ªåŠ¨ç¼©æ”¾(200% DPI â†’ 1/2å°ºå¯¸) |
| å¸ƒå±€å•ä½ | ç‰©ç†åƒç´  | DIU (ä¸DPIæ— å…³) |

**å…³é”®**: ä¸èƒ½ç›´æ¥ç¿»è¯‘Tkinterä»£ç ä¸ºWPF,éœ€è¦ç†è§£åº•å±‚é€»è¾‘å¹¶é€‚é…WPFçš„å¸ƒå±€ç³»ç»Ÿ!

### 5.3 è°ƒè¯•æŠ€å·§

**æœ‰æ•ˆçš„è°ƒè¯•æ—¥å¿—**:
```csharp
System.Diagnostics.Debug.WriteLine($"  ğŸ“ ç”»å¸ƒå°ºå¯¸: æŠ•å½±ScrollViewer={canvasWidth:F0}x{canvasHeight:F0} DIU (å±å¹•ç‰©ç†={screenWidth}x{screenHeight})");
System.Diagnostics.Debug.WriteLine($"  ğŸ“ åŸå›¾æ¨¡å¼å®šä½: å®¹å™¨={containerWidth:F0}x{containerHeight:F0}, å›¾ç‰‡={newWidth}x{newHeight}, åç§»=({x:F0},{y:F0})");
```

**å…³é”®ä¿¡æ¯**:
- ScrollViewerçš„DIUå°ºå¯¸
- å±å¹•ç‰©ç†å°ºå¯¸
- å›¾ç‰‡å°ºå¯¸
- è®¡ç®—çš„åç§»é‡

é€šè¿‡å¯¹æ¯”è¿™äº›æ•°æ®,å¯ä»¥å¿«é€Ÿå®šä½é—®é¢˜!

## å…­ã€åç»­ä¼˜åŒ–å»ºè®®

### 6.1 æ€§èƒ½ä¼˜åŒ–

- [ ] ç¼“å­˜DPIç¼©æ”¾å› å­,é¿å…æ¯æ¬¡éƒ½æŸ¥è¯¢ScrollViewer
- [ ] è€ƒè™‘ä½¿ç”¨GPUåŠ é€Ÿæ¸²æŸ“(ComputeSharp.D2D1)

### 6.2 åŠŸèƒ½æ‰©å±•

- [ ] å®ç°å…¨å±€çƒ­é”®æ”¯æŒ(PageUp/PageDown/ESC)
- [ ] å®ç°åª’ä½“æ’­æ”¾æŠ•å½±(è§†é¢‘/éŸ³é¢‘)
- [ ] æ”¯æŒå¤šæŠ•å½±å±å¹•åŒæ—¶æŠ•å½±

### 6.3 ä»£ç é‡æ„

- [ ] æå–DPIç¼©æ”¾ç›¸å…³é€»è¾‘åˆ°ç‹¬ç«‹çš„Helperç±»
- [ ] ç»Ÿä¸€ä¸»å±å¹•å’ŒæŠ•å½±å±å¹•çš„å›¾ç‰‡å¤„ç†é€»è¾‘

## ä¸ƒã€æ€»ç»“

é€šè¿‡æ·±å…¥ç ”ç©¶Pythonæºä»£ç ,å‘ç°äº†WPFæŠ•å½±æ˜¾ç¤ºé—®é¢˜çš„æ ¹æœ¬åŸå› :
1. **DPIç¼©æ”¾**: å¿…é¡»ä½¿ç”¨ScrollViewerçš„ActualWidth/ActualHeight (DIUå•ä½)
2. **å®šä½æ–¹å¼**: å¿…é¡»ä½¿ç”¨Margin + Left/Topå¯¹é½,æ¨¡ä»¿Pythonçš„ç»å¯¹åæ ‡å®šä½

**æ ¸å¿ƒåŸåˆ™**: 
- ç†è§£æ¡†æ¶å·®å¼‚,ä¸è¦ç›´æ¥ç¿»è¯‘ä»£ç 
- æ·±å…¥ç ”ç©¶æºä»£ç ,ç†è§£åº•å±‚é€»è¾‘
- å……åˆ†åˆ©ç”¨è°ƒè¯•æ—¥å¿—,å¿«é€Ÿå®šä½é—®é¢˜

**æœ€ç»ˆæ•ˆæœ**: 
æŠ•å½±åŠŸèƒ½ç°åœ¨å®Œå…¨æ­£å¸¸,æ‹‰ä¼¸/é€‚ä¸­æ¨¡å¼éƒ½èƒ½æ­£ç¡®æ˜¾ç¤º!

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-10  
**ä½œè€…**: AI Assistant  
**ç‰ˆæœ¬**: 1.0

